<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Takuto Yoshida" />


<title>jsPsych_sample</title>

<script src="data:application/javascript;base64,Ly8gUGFuZG9jIDIuOSBhZGRzIGF0dHJpYnV0ZXMgb24gYm90aCBoZWFkZXIgYW5kIGRpdi4gV2UgcmVtb3ZlIHRoZSBmb3JtZXIgKHRvCi8vIGJlIGNvbXBhdGlibGUgd2l0aCB0aGUgYmVoYXZpb3Igb2YgUGFuZG9jIDwgMi44KS4KZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKGUpIHsKICB2YXIgaHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCJkaXYuc2VjdGlvbltjbGFzcyo9J2xldmVsJ10gPiA6Zmlyc3QtY2hpbGQiKTsKICB2YXIgaSwgaCwgYTsKICBmb3IgKGkgPSAwOyBpIDwgaHMubGVuZ3RoOyBpKyspIHsKICAgIGggPSBoc1tpXTsKICAgIGlmICghL15oWzEtNl0kL2kudGVzdChoLnRhZ05hbWUpKSBjb250aW51ZTsgIC8vIGl0IHNob3VsZCBiZSBhIGhlYWRlciBoMS1oNgogICAgYSA9IGguYXR0cmlidXRlczsKICAgIHdoaWxlIChhLmxlbmd0aCA+IDApIGgucmVtb3ZlQXR0cmlidXRlKGFbMF0ubmFtZSk7CiAgfQp9KTsK"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
      .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>






<link rel="stylesheet" href="data:text/css,%0A%40import%20local%28css%2Etemp%29%3B%0A%0A%2Ejspsych%2Ddisplay%2Delement%20%7B%0Adisplay%3A%20flex%3B%0Aflex%2Ddirection%3A%20column%3B%0Aoverflow%2Dy%3A%20auto%3B%0A%7D%0A%2Ejspsych%2Ddisplay%2Delement%3Afocus%20%7B%0Aoutline%3A%20none%3B%0A%7D%0A%2Ejspsych%2Dcontent%2Dwrapper%20%7B%0Adisplay%3A%20flex%3B%0Amargin%3A%20auto%3B%0Aflex%3A%201%201%20100%25%3B%0Awidth%3A%20100%25%3B%0A%7D%0A%2Ejspsych%2Dcontent%20%7B%0Amax%2Dwidth%3A%2095%25%3B%20%0Atext%2Dalign%3A%20center%3B%0Amargin%3A%20auto%3B%20%0A%7D%0A%2Ejspsych%2Dtop%20%7B%0Aalign%2Ditems%3A%20flex%2Dstart%3B%0A%7D%0A%2Ejspsych%2Dmiddle%20%7B%0Aalign%2Ditems%3A%20center%3B%0A%7D%0A%0A%2Ejspsych%2Ddisplay%2Delement%20%7B%0Afont%2Dfamily%3A%20%27Open%20Sans%27%2C%20%27Arial%27%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2018px%3B%0Aline%2Dheight%3A%201%2E6em%3B%0A%7D%0A%0A%2Ejspsych%2Ddisplay%2Delement%20input%5Btype%3D%22text%22%5D%20%7B%0Afont%2Dfamily%3A%20%27Open%20Sans%27%2C%20%27Arial%27%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0A%7D%0A%0A%2Ejspsych%2Dbtn%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Apadding%3A%206px%2012px%3B%0Amargin%3A%200px%3B%0Afont%2Dsize%3A%2014px%3B%0Afont%2Dweight%3A%20400%3B%0Afont%2Dfamily%3A%20%27Open%20Sans%27%2C%20%27Arial%27%2C%20sans%2Dserif%3B%0Acursor%3A%20pointer%3B%0Aline%2Dheight%3A%201%2E4%3B%0Atext%2Dalign%3A%20center%3B%0Awhite%2Dspace%3A%20nowrap%3B%0Avertical%2Dalign%3A%20middle%3B%0Abackground%2Dimage%3A%20none%3B%0Aborder%3A%201px%20solid%20transparent%3B%0Aborder%2Dradius%3A%204px%3B%0Acolor%3A%20%23333%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0Aborder%2Dcolor%3A%20%23ccc%3B%0A%7D%0A%2Ejspsych%2Dbtn%3Ahover%20%7B%0Abackground%2Dcolor%3A%20%23ddd%3B%0Aborder%2Dcolor%3A%20%23aaa%3B%0A%7D%0A%2Ejspsych%2Dbtn%3Adisabled%20%7B%0Abackground%2Dcolor%3A%20%23eee%3B%0Acolor%3A%20%23aaa%3B%0Aborder%2Dcolor%3A%20%23ccc%3B%0Acursor%3A%20not%2Dallowed%3B%0A%7D%0A%0A%23jspsych%2Dprogressbar%2Dcontainer%20%7B%0Acolor%3A%20%23555%3B%0Aborder%2Dbottom%3A%201px%20solid%20%23dedede%3B%0Abackground%2Dcolor%3A%20%23f9f9f9%3B%0Amargin%2Dbottom%3A%201em%3B%0Atext%2Dalign%3A%20center%3B%0Apadding%3A%208px%200px%3B%0Awidth%3A%20100%25%3B%0Aline%2Dheight%3A%201em%3B%0A%7D%0A%23jspsych%2Dprogressbar%2Dcontainer%20span%20%7B%0Afont%2Dsize%3A%2014px%3B%0Apadding%2Dright%3A%2014px%3B%0A%7D%0A%23jspsych%2Dprogressbar%2Douter%20%7B%0Abackground%2Dcolor%3A%20%23eee%3B%0Awidth%3A%2050%25%3B%0Amargin%3A%20auto%3B%0Aheight%3A%2014px%3B%0Adisplay%3A%20inline%2Dblock%3B%0Avertical%2Dalign%3A%20middle%3B%0Abox%2Dshadow%3A%20inset%200%201px%202px%20rgba%280%2C0%2C0%2C0%2E1%29%3B%0A%7D%0A%23jspsych%2Dprogressbar%2Dinner%20%7B%0Abackground%2Dcolor%3A%20%23aaa%3B%0Awidth%3A%200%25%3B%0Aheight%3A%20100%25%3B%0A%7D%0A%0A%23jspsych%2Ddata%2Ddisplay%20%7B%0Atext%2Dalign%3A%20left%3B%0A%7D%0A" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">jsPsych_sample</h1>
<h4 class="author">Takuto Yoshida</h4>
<h4 class="date">5/10/2020</h4>



<script src="data:application/javascript;base64,LyoqDQogKiBqc3BzeWNoLmpzDQogKiBKb3NoIGRlIExlZXV3DQogKg0KICogZG9jdW1lbnRhdGlvbjogZG9jcy5qc3BzeWNoLm9yZw0KICoNCiAqKi8NCndpbmRvdy5qc1BzeWNoID0gKGZ1bmN0aW9uKCkgew0KDQogIHZhciBjb3JlID0ge307DQoNCiAgLy8NCiAgLy8gcHJpdmF0ZSB2YXJpYWJsZXMNCiAgLy8NCg0KICAvLyBvcHRpb25zDQogIHZhciBvcHRzID0ge307DQogIC8vIGV4cGVyaW1lbnQgdGltZWxpbmUNCiAgdmFyIHRpbWVsaW5lOw0KICAvLyBmbG93IGNvbnRyb2wNCiAgdmFyIGdsb2JhbF90cmlhbF9pbmRleCA9IDA7DQogIHZhciBjdXJyZW50X3RyaWFsID0ge307DQogIHZhciBjdXJyZW50X3RyaWFsX2ZpbmlzaGVkID0gZmFsc2U7DQogIC8vIHRhcmdldCBET00gZWxlbWVudA0KICB2YXIgRE9NX2NvbnRhaW5lcjsNCiAgdmFyIERPTV90YXJnZXQ7DQogIC8vIHRpbWUgdGhhdCB0aGUgZXhwZXJpbWVudCBiZWdhbg0KICB2YXIgZXhwX3N0YXJ0X3RpbWU7DQogIC8vIGlzIHRoZSBleHBlcmltZW50IHBhdXNlZD8NCiAgdmFyIHBhdXNlZCA9IGZhbHNlOw0KICB2YXIgd2FpdGluZyA9IGZhbHNlOw0KICAvLyBkb25lIGxvYWRpbmc/DQogIHZhciBsb2FkZWQgPSBmYWxzZTsNCiAgdmFyIGxvYWRmYWlsID0gZmFsc2U7DQoNCiAgLy8gc3RvcmluZyBhIHNpbmdsZSB3ZWJhdWRpbyBjb250ZXh0IHRvIHByZXZlbnQgcHJvYmxlbXMgd2l0aCBtdWx0aXBsZSBpbml0cw0KICAvLyBvZiBqc1BzeWNoDQogIGNvcmUud2ViYXVkaW9fY29udGV4dCA9IG51bGw7DQogIC8vIHRlbXBvcmFyeSBwYXRjaCBmb3IgU2FmYXJpDQogIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuaGFzT3duUHJvcGVydHkoJ3dlYmtpdEF1ZGlvQ29udGV4dCcpICYmICF3aW5kb3cuaGFzT3duUHJvcGVydHkoJ0F1ZGlvQ29udGV4dCcpKSB7DQogICAgd2luZG93LkF1ZGlvQ29udGV4dCA9IHdlYmtpdEF1ZGlvQ29udGV4dDsNCiAgfQ0KICAvLyBlbmQgcGF0Y2gNCiAgY29yZS53ZWJhdWRpb19jb250ZXh0ID0gKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiB3aW5kb3cuQXVkaW9Db250ZXh0ICE9PSAndW5kZWZpbmVkJykgPyBuZXcgQXVkaW9Db250ZXh0KCkgOiBudWxsOw0KDQogIC8vIGVudW1lcmF0ZWQgdmFyaWFibGVzIGZvciBzcGVjaWFsIHBhcmFtZXRlciB0eXBlcw0KICBjb3JlLkFMTF9LRVlTID0gJ2FsbGtleXMnOw0KICBjb3JlLk5PX0tFWVMgPSAnbm9uZSc7DQoNCiAgLy8NCiAgLy8gcHVibGljIG1ldGhvZHMNCiAgLy8NCg0KICBjb3JlLmluaXQgPSBmdW5jdGlvbihvcHRpb25zKSB7DQoNCiAgICBpZih0eXBlb2Ygb3B0aW9ucy50aW1lbGluZSA9PT0gJ3VuZGVmaW5lZCcpew0KICAgICAgY29uc29sZS5lcnJvcignTm8gdGltZWxpbmUgZGVjbGFyZWQgaW4ganNQc3ljaC5pbml0LiBDYW5ub3Qgc3RhcnQgZXhwZXJpbWVudC4nKQ0KICAgIH0NCg0KICAgIC8vIHJlc2V0IHZhcmlhYmxlcw0KICAgIHRpbWVsaW5lID0gbnVsbDsNCiAgICBnbG9iYWxfdHJpYWxfaW5kZXggPSAwOw0KICAgIGN1cnJlbnRfdHJpYWwgPSB7fTsNCiAgICBjdXJyZW50X3RyaWFsX2ZpbmlzaGVkID0gZmFsc2U7DQogICAgcGF1c2VkID0gZmFsc2U7DQogICAgd2FpdGluZyA9IGZhbHNlOw0KICAgIGxvYWRlZCA9IGZhbHNlOw0KICAgIGxvYWRmYWlsID0gZmFsc2U7DQogICAganNQc3ljaC5kYXRhLnJlc2V0KCk7DQoNCiAgICB2YXIgZGVmYXVsdHMgPSB7DQogICAgICAnZGlzcGxheV9lbGVtZW50JzogdW5kZWZpbmVkLA0KICAgICAgJ29uX2ZpbmlzaCc6IGZ1bmN0aW9uKGRhdGEpIHsNCiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsNCiAgICAgIH0sDQogICAgICAnb25fdHJpYWxfc3RhcnQnOiBmdW5jdGlvbih0cmlhbCkgew0KICAgICAgICByZXR1cm4gdW5kZWZpbmVkOw0KICAgICAgfSwNCiAgICAgICdvbl90cmlhbF9maW5pc2gnOiBmdW5jdGlvbigpIHsNCiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsNCiAgICAgIH0sDQogICAgICAnb25fZGF0YV91cGRhdGUnOiBmdW5jdGlvbihkYXRhKSB7DQogICAgICAgIHJldHVybiB1bmRlZmluZWQ7DQogICAgICB9LA0KICAgICAgJ29uX2ludGVyYWN0aW9uX2RhdGFfdXBkYXRlJzogZnVuY3Rpb24oZGF0YSl7DQogICAgICAgIHJldHVybiB1bmRlZmluZWQ7DQogICAgICB9LA0KICAgICAgJ29uX2Nsb3NlJzogZnVuY3Rpb24oKXsNCiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsNCiAgICAgIH0sDQogICAgICAncHJlbG9hZF9pbWFnZXMnOiBbXSwNCiAgICAgICdwcmVsb2FkX2F1ZGlvJzogW10sDQogICAgICAncHJlbG9hZF92aWRlbyc6IFtdLA0KICAgICAgJ3VzZV93ZWJhdWRpbyc6IHRydWUsDQogICAgICAnZXhjbHVzaW9ucyc6IHt9LA0KICAgICAgJ3Nob3dfcHJvZ3Jlc3NfYmFyJzogZmFsc2UsDQogICAgICAnbWVzc2FnZV9wcm9ncmVzc19iYXInOiAnQ29tcGxldGlvbiBQcm9ncmVzcycsDQogICAgICAnYXV0b191cGRhdGVfcHJvZ3Jlc3NfYmFyJzogdHJ1ZSwNCiAgICAgICdhdXRvX3ByZWxvYWQnOiB0cnVlLA0KICAgICAgJ3Nob3dfcHJlbG9hZF9wcm9ncmVzc19iYXInOiB0cnVlLA0KICAgICAgJ21heF9sb2FkX3RpbWUnOiA2MDAwMCwNCiAgICAgICdtYXhfcHJlbG9hZF9hdHRlbXB0cyc6IDEwLA0KICAgICAgJ2RlZmF1bHRfaXRpJzogMCwNCiAgICAgICdleHBlcmltZW50X3dpZHRoJzogbnVsbA0KICAgIH07DQoNCiAgICAvLyBvdmVycmlkZSBkZWZhdWx0IG9wdGlvbnMgaWYgdXNlciBzcGVjaWZpZXMgYW4gb3B0aW9uDQogICAgb3B0cyA9IE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRzLCBvcHRpb25zKTsNCg0KICAgIC8vIHNldCBET00gZWxlbWVudCB3aGVyZSBqc1BzeWNoIHdpbGwgcmVuZGVyIGNvbnRlbnQNCiAgICAvLyBpZiB1bmRlZmluZWQsIHRoZW4ganNQc3ljaCB3aWxsIHVzZSB0aGUgPGJvZHk+IHRhZyBhbmQgdGhlIGVudGlyZSBwYWdlDQogICAgaWYodHlwZW9mIG9wdHMuZGlzcGxheV9lbGVtZW50ID09ICd1bmRlZmluZWQnKXsNCiAgICAgIC8vIGNoZWNrIGlmIHRoZXJlIGlzIGEgYm9keSBlbGVtZW50IG9uIHRoZSBwYWdlDQogICAgICB2YXIgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKTsNCiAgICAgIGlmIChib2R5ID09PSBudWxsKSB7DQogICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdib2R5JykpOw0KICAgICAgfQ0KICAgICAgLy8gdXNpbmcgdGhlIGZ1bGwgcGFnZSwgc28gd2UgbmVlZCB0aGUgSFRNTCBlbGVtZW50IHRvDQogICAgICAvLyBoYXZlIDEwMCUgaGVpZ2h0LCBhbmQgYm9keSB0byBiZSBmdWxsIHdpZHRoIGFuZCBoZWlnaHQgd2l0aA0KICAgICAgLy8gbm8gbWFyZ2luDQogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdodG1sJykuc3R5bGUuaGVpZ2h0ID0gJzEwMCUnOw0KICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpLnN0eWxlLm1hcmdpbiA9ICcwcHgnOw0KICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpLnN0eWxlLmhlaWdodCA9ICcxMDAlJzsNCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKS5zdHlsZS53aWR0aCA9ICcxMDAlJzsNCiAgICAgIG9wdHMuZGlzcGxheV9lbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpOw0KICAgIH0gZWxzZSB7DQogICAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgZGlzcGxheSBlbGVtZW50IGV4aXN0cyBvbiB0aGUgcGFnZQ0KICAgICAgdmFyIGRpc3BsYXk7DQogICAgICBpZiAob3B0cy5kaXNwbGF5X2VsZW1lbnQgaW5zdGFuY2VvZiBFbGVtZW50KSB7DQogICAgICAgIHZhciBkaXNwbGF5ID0gb3B0cy5kaXNwbGF5X2VsZW1lbnQ7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB2YXIgZGlzcGxheSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyMnICsgb3B0cy5kaXNwbGF5X2VsZW1lbnQpOw0KICAgICAgfQ0KICAgICAgaWYoZGlzcGxheSA9PT0gbnVsbCkgew0KICAgICAgICBjb25zb2xlLmVycm9yKCdUaGUgZGlzcGxheV9lbGVtZW50IHNwZWNpZmllZCBpbiBqc1BzeWNoLmluaXQoKSBkb2VzIG5vdCBleGlzdCBpbiB0aGUgRE9NLicpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgb3B0cy5kaXNwbGF5X2VsZW1lbnQgPSBkaXNwbGF5Ow0KICAgICAgfQ0KICAgIH0NCiAgICBvcHRzLmRpc3BsYXlfZWxlbWVudC5pbm5lckhUTUwgPSAnPGRpdiBjbGFzcz0ianNwc3ljaC1jb250ZW50LXdyYXBwZXIiPjxkaXYgaWQ9ImpzcHN5Y2gtY29udGVudCI+PC9kaXY+PC9kaXY+JzsNCiAgICBET01fY29udGFpbmVyID0gb3B0cy5kaXNwbGF5X2VsZW1lbnQ7DQogICAgRE9NX3RhcmdldCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNqc3BzeWNoLWNvbnRlbnQnKTsNCiAgICANCg0KICAgIC8vIGFkZCB0YWJJbmRleCBhdHRyaWJ1dGUgdG8gc2NvcGUgZXZlbnQgbGlzdGVuZXJzDQogICAgb3B0cy5kaXNwbGF5X2VsZW1lbnQudGFiSW5kZXggPSAwOw0KDQogICAgLy8gYWRkIENTUyBjbGFzcyB0byBET01fdGFyZ2V0DQogICAgaWYob3B0cy5kaXNwbGF5X2VsZW1lbnQuY2xhc3NOYW1lLmluZGV4T2YoJ2pzcHN5Y2gtZGlzcGxheS1lbGVtZW50JykgPT0gLTEpew0KICAgICAgb3B0cy5kaXNwbGF5X2VsZW1lbnQuY2xhc3NOYW1lICs9ICcganNwc3ljaC1kaXNwbGF5LWVsZW1lbnQnOw0KICAgIH0NCiAgICBET01fdGFyZ2V0LmNsYXNzTmFtZSArPSAnanNwc3ljaC1jb250ZW50JzsNCg0KICAgIC8vIHNldCBleHBlcmltZW50X3dpZHRoIGlmIG5vdCBudWxsDQogICAgaWYob3B0cy5leHBlcmltZW50X3dpZHRoICE9PSBudWxsKXsNCiAgICAgIERPTV90YXJnZXQuc3R5bGUud2lkdGggPSBvcHRzLmV4cGVyaW1lbnRfd2lkdGggKyAicHgiOw0KICAgIH0NCg0KICAgIC8vIGNyZWF0ZSBleHBlcmltZW50IHRpbWVsaW5lDQogICAgdGltZWxpbmUgPSBuZXcgVGltZWxpbmVOb2RlKHsNCiAgICAgIHRpbWVsaW5lOiBvcHRzLnRpbWVsaW5lDQogICAgfSk7DQoNCiAgICAvLyBpbml0aWFsaXplIGF1ZGlvIGNvbnRleHQgYmFzZWQgb24gb3B0aW9ucyBhbmQgYnJvd3NlciBjYXBhYmlsaXRpZXMNCiAgICBqc1BzeWNoLnBsdWdpbkFQSS5pbml0QXVkaW8oKTsNCg0KICAgIC8vIGJlbG93IGNvZGUgcmVzZXRzIGV2ZW50IGxpc3RlbmVycyB0aGF0IG1heSBoYXZlIGxpbmdlcmVkIGZyb20NCiAgICAvLyBhIHByZXZpb3VzIGluY29tcGxldGUgZXhwZXJpbWVudCBsb2FkZWQgaW4gc2FtZSBET00uDQogICAganNQc3ljaC5wbHVnaW5BUEkucmVzZXQob3B0cy5kaXNwbGF5X2VsZW1lbnQpOw0KICAgIC8vIGNyZWF0ZSBrZXlib2FyZCBldmVudCBsaXN0ZW5lcnMNCiAgICBqc1BzeWNoLnBsdWdpbkFQSS5jcmVhdGVLZXlib2FyZEV2ZW50TGlzdGVuZXJzKG9wdHMuZGlzcGxheV9lbGVtZW50KTsNCiAgICAvLyBjcmVhdGUgbGlzdGVuZXJzIGZvciB1c2VyIGJyb3dzZXIgaW50ZXJhY3Rpb24NCiAgICBqc1BzeWNoLmRhdGEuY3JlYXRlSW50ZXJhY3Rpb25MaXN0ZW5lcnMoKTsNCg0KICAgIC8vIGFkZCBldmVudCBmb3IgY2xvc2luZyB3aW5kb3cNCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignYmVmb3JldW5sb2FkJywgb3B0cy5vbl9jbG9zZSk7DQoNCiAgICAvLyBjaGVjayBleGNsdXNpb25zIGJlZm9yZSBjb250aW51aW5nDQogICAgY2hlY2tFeGNsdXNpb25zKG9wdHMuZXhjbHVzaW9ucywNCiAgICAgIGZ1bmN0aW9uKCl7DQogICAgICAgIC8vIHN1Y2Nlc3MhIHVzZXIgY2FuIGNvbnRpbnVlLi4uDQogICAgICAgIC8vIHN0YXJ0IGV4cGVyaW1lbnQsIHdpdGggb3Igd2l0aG91dCBwcmVsb2FkaW5nDQogICAgICAgIGlmKG9wdHMuYXV0b19wcmVsb2FkKXsNCiAgICAgICAgICBqc1BzeWNoLnBsdWdpbkFQSS5hdXRvUHJlbG9hZCh0aW1lbGluZSwgc3RhcnRFeHBlcmltZW50LCBvcHRzLnByZWxvYWRfaW1hZ2VzLCBvcHRzLnByZWxvYWRfYXVkaW8sIG9wdHMucHJlbG9hZF92aWRlbywgb3B0cy5zaG93X3ByZWxvYWRfcHJvZ3Jlc3NfYmFyKTsNCiAgICAgICAgICBpZihvcHRzLm1heF9sb2FkX3RpbWUgPiAwKXsNCiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgaWYoIWxvYWRlZCAmJiAhbG9hZGZhaWwpew0KICAgICAgICAgICAgICAgIGNvcmUubG9hZEZhaWwoKTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwgb3B0cy5tYXhfbG9hZF90aW1lKTsNCiAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgc3RhcnRFeHBlcmltZW50KCk7DQogICAgICAgIH0NCiAgICAgIH0sDQogICAgICBmdW5jdGlvbigpew0KICAgICAgICAvLyBmYWlsLiBpbmNvbXBhdGlibGUgdXNlci4NCg0KICAgICAgfQ0KICAgICk7DQogIH07DQoNCiAgY29yZS5wcm9ncmVzcyA9IGZ1bmN0aW9uKCkgew0KDQogICAgdmFyIHBlcmNlbnRfY29tcGxldGUgPSB0eXBlb2YgdGltZWxpbmUgPT0gJ3VuZGVmaW5lZCcgPyAwIDogdGltZWxpbmUucGVyY2VudENvbXBsZXRlKCk7DQoNCiAgICB2YXIgb2JqID0gew0KICAgICAgInRvdGFsX3RyaWFscyI6IHR5cGVvZiB0aW1lbGluZSA9PSAndW5kZWZpbmVkJyA/IHVuZGVmaW5lZCA6IHRpbWVsaW5lLmxlbmd0aCgpLA0KICAgICAgImN1cnJlbnRfdHJpYWxfZ2xvYmFsIjogZ2xvYmFsX3RyaWFsX2luZGV4LA0KICAgICAgInBlcmNlbnRfY29tcGxldGUiOiBwZXJjZW50X2NvbXBsZXRlDQogICAgfTsNCg0KICAgIHJldHVybiBvYmo7DQogIH07DQoNCiAgY29yZS5zdGFydFRpbWUgPSBmdW5jdGlvbigpIHsNCiAgICByZXR1cm4gZXhwX3N0YXJ0X3RpbWU7DQogIH07DQoNCiAgY29yZS50b3RhbFRpbWUgPSBmdW5jdGlvbigpIHsNCiAgICBpZih0eXBlb2YgZXhwX3N0YXJ0X3RpbWUgPT0gJ3VuZGVmaW5lZCcpeyByZXR1cm4gMDsgfQ0KICAgIHJldHVybiAobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gZXhwX3N0YXJ0X3RpbWUuZ2V0VGltZSgpOw0KICB9Ow0KDQogIGNvcmUuZ2V0RGlzcGxheUVsZW1lbnQgPSBmdW5jdGlvbigpIHsNCiAgICByZXR1cm4gRE9NX3RhcmdldDsNCiAgfTsNCg0KICBjb3JlLmdldERpc3BsYXlDb250YWluZXJFbGVtZW50ID0gZnVuY3Rpb24oKXsNCiAgICByZXR1cm4gRE9NX2NvbnRhaW5lcjsNCiAgfQ0KDQogIGNvcmUuZmluaXNoVHJpYWwgPSBmdW5jdGlvbihkYXRhKSB7DQoNCiAgICBpZihjdXJyZW50X3RyaWFsX2ZpbmlzaGVkKXsgcmV0dXJuOyB9DQogICAgY3VycmVudF90cmlhbF9maW5pc2hlZCA9IHRydWU7DQoNCiAgICAvLyB3cml0ZSB0aGUgZGF0YSBmcm9tIHRoZSB0cmlhbA0KICAgIGRhdGEgPSB0eXBlb2YgZGF0YSA9PSAndW5kZWZpbmVkJyA/IHt9IDogZGF0YTsNCiAgICBqc1BzeWNoLmRhdGEud3JpdGUoZGF0YSk7DQoNCiAgICAvLyBnZXQgYmFjayB0aGUgZGF0YSB3aXRoIGFsbCBvZiB0aGUgZGVmYXVsdHMgaW4NCiAgICB2YXIgdHJpYWxfZGF0YSA9IGpzUHN5Y2guZGF0YS5nZXQoKS5maWx0ZXIoe3RyaWFsX2luZGV4OiBnbG9iYWxfdHJpYWxfaW5kZXh9KTsNCg0KICAgIC8vIGZvciB0cmlhbC1sZXZlbCBjYWxsYmFja3MsIHdlIGp1c3Qgd2FudCB0byBwYXNzIGluIGEgcmVmZXJlbmNlIHRvIHRoZSB2YWx1ZXMNCiAgICAvLyBvZiB0aGUgRGF0YUNvbGxlY3Rpb24sIGZvciBlYXN5IGFjY2VzcyBhbmQgZWRpdGluZy4NCiAgICB2YXIgdHJpYWxfZGF0YV92YWx1ZXMgPSB0cmlhbF9kYXRhLnZhbHVlcygpWzBdOw0KDQogICAgLy8gaGFuZGxlIGNhbGxiYWNrIGF0IHBsdWdpbiBsZXZlbA0KICAgIGlmICh0eXBlb2YgY3VycmVudF90cmlhbC5vbl9maW5pc2ggPT09ICdmdW5jdGlvbicpIHsNCiAgICAgIGN1cnJlbnRfdHJpYWwub25fZmluaXNoKHRyaWFsX2RhdGFfdmFsdWVzKTsNCiAgICB9DQoNCiAgICAvLyBoYW5kbGUgY2FsbGJhY2sgYXQgd2hvbGUtZXhwZXJpbWVudCBsZXZlbA0KICAgIG9wdHMub25fdHJpYWxfZmluaXNoKHRyaWFsX2RhdGFfdmFsdWVzKTsNCg0KICAgIC8vIGFmdGVyIHRoZSBhYm92ZSBjYWxsYmFja3MgYXJlIGNvbXBsZXRlLCB0aGVuIHRoZSBkYXRhIHNob3VsZCBiZSBmaW5hbGl6ZWQNCiAgICAvLyBmb3IgdGhpcyB0cmlhbC4gY2FsbCB0aGUgb25fZGF0YV91cGRhdGUgaGFuZGxlciwgcGFzc2luZyBpbiB0aGUgc2FtZQ0KICAgIC8vIGRhdGEgb2JqZWN0IHRoYXQganVzdCB3ZW50IHRocm91Z2ggdGhlIHRyaWFsJ3MgZmluaXNoIGhhbmRsZXJzLg0KICAgIG9wdHMub25fZGF0YV91cGRhdGUodHJpYWxfZGF0YV92YWx1ZXMpOw0KDQogICAgLy8gd2FpdCBmb3IgaXRpDQogICAgaWYgKHR5cGVvZiBjdXJyZW50X3RyaWFsLnBvc3RfdHJpYWxfZ2FwID09PSBudWxsIHx8IHR5cGVvZiBjdXJyZW50X3RyaWFsLnBvc3RfdHJpYWxfZ2FwID09PSAndW5kZWZpbmVkJykgew0KICAgICAgaWYgKG9wdHMuZGVmYXVsdF9pdGkgPiAwKSB7DQogICAgICAgIHNldFRpbWVvdXQobmV4dFRyaWFsLCBvcHRzLmRlZmF1bHRfaXRpKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIG5leHRUcmlhbCgpOw0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBpZiAoY3VycmVudF90cmlhbC5wb3N0X3RyaWFsX2dhcCA+IDApIHsNCiAgICAgICAgc2V0VGltZW91dChuZXh0VHJpYWwsIGN1cnJlbnRfdHJpYWwucG9zdF90cmlhbF9nYXApOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgbmV4dFRyaWFsKCk7DQogICAgICB9DQogICAgfQ0KICB9DQoNCiAgY29yZS5lbmRFeHBlcmltZW50ID0gZnVuY3Rpb24oZW5kX21lc3NhZ2UpIHsNCiAgICB0aW1lbGluZS5lbmRfbWVzc2FnZSA9IGVuZF9tZXNzYWdlOw0KICAgIHRpbWVsaW5lLmVuZCgpOw0KICAgIGpzUHN5Y2gucGx1Z2luQVBJLmNhbmNlbEFsbEtleWJvYXJkUmVzcG9uc2VzKCk7DQogICAganNQc3ljaC5wbHVnaW5BUEkuY2xlYXJBbGxUaW1lb3V0cygpOw0KICAgIGNvcmUuZmluaXNoVHJpYWwoKTsNCiAgfQ0KDQogIGNvcmUuZW5kQ3VycmVudFRpbWVsaW5lID0gZnVuY3Rpb24oKSB7DQogICAgdGltZWxpbmUuZW5kQWN0aXZlTm9kZSgpOw0KICB9DQoNCiAgY29yZS5jdXJyZW50VHJpYWwgPSBmdW5jdGlvbigpIHsNCiAgICByZXR1cm4gY3VycmVudF90cmlhbDsNCiAgfTsNCg0KICBjb3JlLmluaXRTZXR0aW5ncyA9IGZ1bmN0aW9uKCkgew0KICAgIHJldHVybiBvcHRzOw0KICB9Ow0KDQogIGNvcmUuY3VycmVudFRpbWVsaW5lTm9kZUlEID0gZnVuY3Rpb24oKSB7DQogICAgcmV0dXJuIHRpbWVsaW5lLmFjdGl2ZUlEKCk7DQogIH07DQoNCiAgY29yZS50aW1lbGluZVZhcmlhYmxlID0gZnVuY3Rpb24odmFybmFtZSwgZXhlY3V0ZSl7DQogICAgaWYoZXhlY3V0ZSl7DQogICAgICByZXR1cm4gdGltZWxpbmUudGltZWxpbmVWYXJpYWJsZSh2YXJuYW1lKTsNCiAgICB9IGVsc2Ugew0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgeyByZXR1cm4gdGltZWxpbmUudGltZWxpbmVWYXJpYWJsZSh2YXJuYW1lKTsgfQ0KICAgIH0NCiAgfQ0KDQogIGNvcmUuYWRkTm9kZVRvRW5kT2ZUaW1lbGluZSA9IGZ1bmN0aW9uKG5ld190aW1lbGluZSwgcHJlbG9hZF9jYWxsYmFjayl7DQogICAgdGltZWxpbmUuaW5zZXJ0KG5ld190aW1lbGluZSk7DQogICAgaWYodHlwZW9mIHByZWxvYWRfY2FsbGJhY2sgIT09ICd1bmRlZmluZGVkJyl7DQogICAgICBpZihvcHRzLmF1dG9fcHJlbG9hZCl7DQogICAgICAgIGpzUHN5Y2gucGx1Z2luQVBJLmF1dG9QcmVsb2FkKHRpbWVsaW5lLCBwcmVsb2FkX2NhbGxiYWNrKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHByZWxvYWRfY2FsbGJhY2soKTsNCiAgICAgIH0NCiAgICB9DQogIH0NCg0KICBjb3JlLnBhdXNlRXhwZXJpbWVudCA9IGZ1bmN0aW9uKCl7DQogICAgcGF1c2VkID0gdHJ1ZTsNCiAgfQ0KDQogIGNvcmUucmVzdW1lRXhwZXJpbWVudCA9IGZ1bmN0aW9uKCl7DQogICAgcGF1c2VkID0gZmFsc2U7DQogICAgaWYod2FpdGluZyl7DQogICAgICB3YWl0aW5nID0gZmFsc2U7DQogICAgICBuZXh0VHJpYWwoKTsNCiAgICB9DQogIH0NCg0KICBjb3JlLmxvYWRGYWlsID0gZnVuY3Rpb24obWVzc2FnZSl7DQogICAgbWVzc2FnZSA9IG1lc3NhZ2UgfHwgJzxwPlRoZSBleHBlcmltZW50IGZhaWxlZCB0byBsb2FkLjwvcD4nOw0KICAgIGxvYWRmYWlsID0gdHJ1ZTsNCiAgICBET01fdGFyZ2V0LmlubmVySFRNTCA9IG1lc3NhZ2U7DQogIH0NCg0KICBmdW5jdGlvbiBUaW1lbGluZU5vZGUocGFyYW1ldGVycywgcGFyZW50LCByZWxhdGl2ZUlEKSB7DQoNCiAgICAvLyBhIHVuaXF1ZSBJRCBmb3IgdGhpcyBub2RlLCByZWxhdGl2ZSB0byB0aGUgcGFyZW50DQogICAgdmFyIHJlbGF0aXZlX2lkOw0KDQogICAgLy8gc3RvcmUgdGhlIHBhcmVudCBmb3IgdGhpcyBub2RlDQogICAgdmFyIHBhcmVudF9ub2RlOw0KDQogICAgLy8gcGFyYW1ldGVycyBmb3IgdGhlIHRyaWFsIGlmIHRoZSBub2RlIGNvbnRhaW5zIGEgdHJpYWwNCiAgICB2YXIgdHJpYWxfcGFyYW1ldGVyczsNCg0KICAgIC8vIHBhcmFtZXRlcnMgZm9yIG5vZGVzIHRoYXQgY29udGFpbiB0aW1lbGluZXMNCiAgICB2YXIgdGltZWxpbmVfcGFyYW1ldGVyczsNCg0KICAgIC8vIHN0b3JlcyB0cmlhbCBpbmZvcm1hdGlvbiBvbiBhIG5vZGUgdGhhdCBjb250YWlucyBhIHRpbWVsaW5lDQogICAgLy8gdXNlZCBmb3IgYWRkaW5nIG5ldyB0cmlhbHMNCiAgICB2YXIgbm9kZV90cmlhbF9kYXRhOw0KDQogICAgLy8gdHJhY2sgcHJvZ3Jlc3MgdGhyb3VnaCB0aGUgbm9kZQ0KICAgIHZhciBwcm9ncmVzcyA9IHsNCiAgICAgIGN1cnJlbnRfbG9jYXRpb246IC0xLCAvLyB3aGVyZSBvbiB0aGUgdGltZWxpbmUgKHdoaWNoIHRpbWVsaW5lbm9kZSkNCiAgICAgIGN1cnJlbnRfdmFyaWFibGVfc2V0OiAwLCAvLyB3aGljaCBzZXQgb2YgdmFyaWFibGVzIHRvIHVzZSBmcm9tIHRpbWVsaW5lX3ZhcmlhYmxlcw0KICAgICAgY3VycmVudF9yZXBldGl0aW9uOiAwLCAvLyBob3cgbWFueSB0aW1lcyB0aHJvdWdoIHRoZSB2YXJpYWJsZSBzZXQgb24gdGhpcyBydW4gb2YgdGhlIG5vZGUNCiAgICAgIGN1cnJlbnRfaXRlcmF0aW9uOiAwLCAvLyBob3cgbWFueSB0aW1lcyB0aGlzIG5vZGUgaGFzIGJlZW4gcmV2aXNpdGVkDQogICAgICBkb25lOiBmYWxzZQ0KICAgIH0NCg0KICAgIC8vIHJlZmVyZW5jZSB0byBzZWxmDQogICAgdmFyIHNlbGYgPSB0aGlzOw0KDQogICAgLy8gcmVjdXJzaXZlbHkgZ2V0IHRoZSBuZXh0IHRyaWFsIHRvIHJ1bi4NCiAgICAvLyBpZiB0aGlzIG5vZGUgaXMgYSBsZWFmICh0cmlhbCksIHRoZW4gcmV0dXJuIHRoZSB0cmlhbC4NCiAgICAvLyBvdGhlcndpc2UsIHJlY3Vyc2l2ZWx5IGZpbmQgdGhlIG5leHQgdHJpYWwgaW4gdGhlIGNoaWxkIHRpbWVsaW5lLg0KICAgIHRoaXMudHJpYWwgPSBmdW5jdGlvbigpIHsNCiAgICAgIGlmICh0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJykgew0KICAgICAgICAvLyByZXR1cm5zIGEgY2xvbmUgb2YgdGhlIHRyaWFsX3BhcmFtZXRlcnMgdG8NCiAgICAgICAgLy8gcHJvdGVjdCBmdW5jdGlvbnMuDQogICAgICAgIHJldHVybiBqc1BzeWNoLnV0aWxzLmRlZXBDb3B5KHRyaWFsX3BhcmFtZXRlcnMpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgaWYgKHByb2dyZXNzLmN1cnJlbnRfbG9jYXRpb24gPj0gdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZS5sZW5ndGgpIHsNCiAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZVtwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uXS50cmlhbCgpOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KDQogICAgdGhpcy5tYXJrQ3VycmVudFRyaWFsQ29tcGxldGUgPSBmdW5jdGlvbigpIHsNCiAgICAgIGlmKHR5cGVvZiB0aW1lbGluZV9wYXJhbWV0ZXJzID09ICd1bmRlZmluZWQnKXsNCiAgICAgICAgcHJvZ3Jlc3MuZG9uZSA9IHRydWU7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lW3Byb2dyZXNzLmN1cnJlbnRfbG9jYXRpb25dLm1hcmtDdXJyZW50VHJpYWxDb21wbGV0ZSgpOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHRoaXMubmV4dFJlcGV0aXRvbiA9IGZ1bmN0aW9uKCkgew0KICAgICAgdGhpcy5zZXRUaW1lbGluZVZhcmlhYmxlc09yZGVyKCk7DQogICAgICBwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uID0gLTE7DQogICAgICBwcm9ncmVzcy5jdXJyZW50X3ZhcmlhYmxlX3NldCA9IDA7DQogICAgICBwcm9ncmVzcy5jdXJyZW50X3JlcGV0aXRpb24rKzsNCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZS5sZW5ndGg7IGkrKykgew0KICAgICAgICB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lW2ldLnJlc2V0KCk7DQogICAgICB9DQogICAgfQ0KDQogICAgLy8gc2V0IHRoZSBvcmRlciBmb3IgZ29pbmcgdGhyb3VnaCB0aGUgdGltZWxpbmUgdmFyaWFibGVzIGFycmF5DQogICAgdGhpcy5zZXRUaW1lbGluZVZhcmlhYmxlc09yZGVyID0gZnVuY3Rpb24oKSB7DQoNCiAgICAgIC8vIGNoZWNrIHRvIG1ha2Ugc3VyZSB0aGlzIG5vZGUgaGFzIHZhcmlhYmxlcw0KICAgICAgaWYodHlwZW9mIHRpbWVsaW5lX3BhcmFtZXRlcnMgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lX3ZhcmlhYmxlcyA9PT0gJ3VuZGVmaW5lZCcpew0KICAgICAgICByZXR1cm47DQogICAgICB9DQoNCiAgICAgIHZhciBvcmRlciA9IFtdOw0KICAgICAgZm9yKHZhciBpPTA7IGk8dGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZV92YXJpYWJsZXMubGVuZ3RoOyBpKyspew0KICAgICAgICBvcmRlci5wdXNoKGkpOw0KICAgICAgfQ0KDQogICAgICBpZih0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycy5zYW1wbGUgIT09ICd1bmRlZmluZWQnKXsNCiAgICAgICAgaWYodGltZWxpbmVfcGFyYW1ldGVycy5zYW1wbGUudHlwZSA9PSAnY3VzdG9tJyl7DQogICAgICAgICAgb3JkZXIgPSB0aW1lbGluZV9wYXJhbWV0ZXJzLnNhbXBsZS5mbihvcmRlcik7DQogICAgICAgIH0gZWxzZSBpZih0aW1lbGluZV9wYXJhbWV0ZXJzLnNhbXBsZS50eXBlID09ICd3aXRoLXJlcGxhY2VtZW50Jyl7DQogICAgICAgICAgb3JkZXIgPSBqc1BzeWNoLnJhbmRvbWl6YXRpb24uc2FtcGxlV2l0aFJlcGxhY2VtZW50KG9yZGVyLCB0aW1lbGluZV9wYXJhbWV0ZXJzLnNhbXBsZS5zaXplLCB0aW1lbGluZV9wYXJhbWV0ZXJzLnNhbXBsZS53ZWlnaHRzKTsNCiAgICAgICAgfSBlbHNlIGlmKHRpbWVsaW5lX3BhcmFtZXRlcnMuc2FtcGxlLnR5cGUgPT0gJ3dpdGhvdXQtcmVwbGFjZW1lbnQnKXsNCiAgICAgICAgICBvcmRlciA9IGpzUHN5Y2gucmFuZG9taXphdGlvbi5zYW1wbGVXaXRob3V0UmVwbGFjZW1lbnQob3JkZXIsIHRpbWVsaW5lX3BhcmFtZXRlcnMuc2FtcGxlLnNpemUpOw0KICAgICAgICB9IGVsc2UgaWYodGltZWxpbmVfcGFyYW1ldGVycy5zYW1wbGUudHlwZSA9PSAnZml4ZWQtcmVwZXRpdGlvbnMnKXsNCiAgICAgICAgICBvcmRlciA9IGpzUHN5Y2gucmFuZG9taXphdGlvbi5yZXBlYXQob3JkZXIsIHRpbWVsaW5lX3BhcmFtZXRlcnMuc2FtcGxlLnNpemUsIGZhbHNlKTsNCiAgICAgICAgfSBlbHNlIGlmKHRpbWVsaW5lX3BhcmFtZXRlcnMuc2FtcGxlLnR5cGUgPT0gJ2FsdGVybmF0ZS1ncm91cHMnKXsNCiAgICAgICAgICBvcmRlciA9IGpzUHN5Y2gucmFuZG9taXphdGlvbi5zaHVmZmxlQWx0ZXJuYXRlR3JvdXBzKHRpbWVsaW5lX3BhcmFtZXRlcnMuc2FtcGxlLmdyb3VwcywgdGltZWxpbmVfcGFyYW1ldGVycy5zYW1wbGUucmFuZG9taXplX2dyb3VwX29yZGVyKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBjb25zb2xlLmVycm9yKCdJbnZhbGlkIHR5cGUgaW4gdGltZWxpbmUgc2FtcGxlIHBhcmFtZXRlcnMuIFZhbGlkIG9wdGlvbnMgZm9yIHR5cGUgYXJlICJjdXN0b20iLCAid2l0aC1yZXBsYWNlbWVudCIsICJ3aXRob3V0LXJlcGxhY2VtZW50IiwgImZpeGVkLXJlcGV0aXRpb25zIiwgYW5kICJhbHRlcm5hdGUtZ3JvdXBzIicpOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIGlmKHRpbWVsaW5lX3BhcmFtZXRlcnMucmFuZG9taXplX29yZGVyKSB7DQogICAgICAgIG9yZGVyID0ganNQc3ljaC5yYW5kb21pemF0aW9uLnNodWZmbGUob3JkZXIpOw0KICAgICAgfQ0KDQogICAgICBwcm9ncmVzcy5vcmRlciA9IG9yZGVyOw0KICAgIH0NCg0KICAgIC8vIG5leHQgdmFyaWFibGUgc2V0DQogICAgdGhpcy5uZXh0U2V0ID0gZnVuY3Rpb24oKSB7DQogICAgICBwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uID0gLTE7DQogICAgICBwcm9ncmVzcy5jdXJyZW50X3ZhcmlhYmxlX3NldCsrOw0KICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbaV0ucmVzZXQoKTsNCiAgICAgIH0NCiAgICB9DQoNCiAgICAvLyB1cGRhdGUgdGhlIGN1cnJlbnQgdHJpYWwgbm9kZSB0byBiZSBjb21wbGV0ZWQNCiAgICAvLyByZXR1cm5zIHRydWUgaWYgdGhlIG5vZGUgaXMgY29tcGxldGUgYWZ0ZXIgYWR2YW5jZSAoYWxsIHN1Ym5vZGVzIGFyZSBhbHNvIGNvbXBsZXRlKQ0KICAgIC8vIHJldHVybnMgZmFsc2Ugb3RoZXJ3aXNlDQogICAgdGhpcy5hZHZhbmNlID0gZnVuY3Rpb24oKSB7DQoNCiAgICAgIC8vIGZpcnN0IGNoZWNrIHRvIHNlZSBpZiBkb25lDQogICAgICBpZiAocHJvZ3Jlc3MuZG9uZSkgew0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCg0KICAgICAgLy8gaWYgbm9kZSBoYXMgbm90IHN0YXJ0ZWQgeWV0IChwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uID09IC0xKSwNCiAgICAgIC8vIHRoZW4gdHJ5IHRvIHN0YXJ0IHRoZSBub2RlLg0KICAgICAgaWYgKHByb2dyZXNzLmN1cnJlbnRfbG9jYXRpb24gPT0gLTEpIHsNCiAgICAgICAgLy8gY2hlY2sgZm9yIGNvbmRpdG9uYWwgZnVuY3Rpb24gb24gbm9kZXMgd2l0aCB0aW1lbGluZXMNCiAgICAgICAgaWYgKHR5cGVvZiB0aW1lbGluZV9wYXJhbWV0ZXJzICE9ICd1bmRlZmluZWQnKSB7DQogICAgICAgICAgaWYgKHR5cGVvZiB0aW1lbGluZV9wYXJhbWV0ZXJzLmNvbmRpdGlvbmFsX2Z1bmN0aW9uICE9PSAndW5kZWZpbmVkJykgew0KICAgICAgICAgICAgdmFyIGNvbmRpdGlvbmFsX3Jlc3VsdCA9IHRpbWVsaW5lX3BhcmFtZXRlcnMuY29uZGl0aW9uYWxfZnVuY3Rpb24oKTsNCiAgICAgICAgICAgIC8vIGlmIHRoZSBjb25kaXRpb25hbF9mdW5jdGlvbigpIHJldHVybnMgZmFsc2UsIHRoZW4gdGhlIHRpbWVsaW5lDQogICAgICAgICAgICAvLyBkb2Vzbid0IHJ1biBhbmQgaXMgbWFya2VkIGFzIGNvbXBsZXRlLg0KICAgICAgICAgICAgaWYgKGNvbmRpdGlvbmFsX3Jlc3VsdCA9PSBmYWxzZSkgew0KICAgICAgICAgICAgICBwcm9ncmVzcy5kb25lID0gdHJ1ZTsNCiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICB9DQogICAgICAgICAgICAvLyBpZiB0aGUgY29uZGl0b25hbF9mdW5jdGlvbigpIHJldHVybnMgdHJ1ZSwgdGhlbiB0aGUgbm9kZSBjYW4gc3RhcnQNCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICBwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uID0gMDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgICAgLy8gaWYgdGhlcmUgaXMgbm8gY29uZGl0aW9uYWxfZnVuY3Rpb24sIHRoZW4gdGhlIG5vZGUgY2FuIHN0YXJ0DQogICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uID0gMDsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgLy8gaWYgdGhlIG5vZGUgZG9lcyBub3QgaGF2ZSBhIHRpbWVsaW5lLCB0aGVuIGl0IGNhbiBzdGFydA0KICAgICAgICBwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uID0gMDsNCiAgICAgICAgLy8gY2FsbCBhZHZhbmNlIGFnYWluIG9uIHRoaXMgbm9kZSBub3cgdGhhdCBpdCBpcyBwb2ludGluZyB0byBhIG5ldyBsb2NhdGlvbg0KICAgICAgICByZXR1cm4gdGhpcy5hZHZhbmNlKCk7DQogICAgICB9DQoNCiAgICAgIC8vIGlmIHRoaXMgbm9kZSBoYXMgYSB0aW1lbGluZSwgcHJvcG9nYXRlIGRvd24gdG8gdGhlIGN1cnJlbnQgdHJpYWwuDQogICAgICBpZiAodHlwZW9mIHRpbWVsaW5lX3BhcmFtZXRlcnMgIT09ICd1bmRlZmluZWQnKSB7DQoNCiAgICAgICAgdmFyIGhhdmVfbm9kZV90b19ydW4gPSBmYWxzZTsNCiAgICAgICAgLy8ga2VlcCBpbmNyZW1lbnRpbmcgdGhlIGxvY2F0aW9uIGluIHRoZSB0aW1lbGluZSB1bnRpbCBvbmUgb2YgdGhlIG5vZGVzIHJlYWNoZWQgaXMgaW5jb21wbGV0ZQ0KICAgICAgICB3aGlsZSAocHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbiA8IHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmUubGVuZ3RoICYmIGhhdmVfbm9kZV90b19ydW4gPT0gZmFsc2UpIHsNCg0KICAgICAgICAgIC8vIGNoZWNrIHRvIHNlZSBpZiB0aGUgbm9kZSBjdXJyZW50bHkgcG9pbnRlZCBhdCBpcyBkb25lDQogICAgICAgICAgdmFyIHRhcmdldF9jb21wbGV0ZSA9IHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbcHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbl0uYWR2YW5jZSgpOw0KICAgICAgICAgIGlmICghdGFyZ2V0X2NvbXBsZXRlKSB7DQogICAgICAgICAgICBoYXZlX25vZGVfdG9fcnVuID0gdHJ1ZTsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbisrOw0KICAgICAgICAgIH0NCg0KICAgICAgICB9DQoNCiAgICAgICAgLy8gaWYgd2UndmUgcmVhY2hlZCB0aGUgZW5kIG9mIHRoZSB0aW1lbGluZSAod2hpY2gsIGlmIHRoZSBjb2RlIGlzIGhlcmUsIHdlIGhhdmUpDQogICAgICAgIC8vIHRoZXJlIGFyZSBhIGZldyBzdGVwcyB0byBzZWUgd2hhdCB0byBkbyBuZXh0Li4uDQoNCiAgICAgICAgLy8gZmlyc3QsIGNoZWNrIHRoZSB0aW1lbGluZV92YXJpYWJsZXMgdG8gc2VlIGlmIHdlIG5lZWQgdG8gbG9vcCB0aHJvdWdoIGFnYWluDQogICAgICAgIC8vIHdpdGggYSBuZXcgc2V0IG9mIHZhcmlhYmxlcw0KICAgICAgICBpZiAocHJvZ3Jlc3MuY3VycmVudF92YXJpYWJsZV9zZXQgPCBwcm9ncmVzcy5vcmRlci5sZW5ndGggLSAxKSB7DQogICAgICAgICAgLy8gcmVzZXQgdGhlIHByb2dyZXNzIG9mIHRoZSBub2RlIHRvIGJlIHdpdGggdGhlIG5ldyBzZXQNCiAgICAgICAgICB0aGlzLm5leHRTZXQoKTsNCiAgICAgICAgICAvLyB0aGVuIHRyeSB0byBhZHZhbmNlIHRoaXMgbm9kZSBhZ2Fpbi4NCiAgICAgICAgICByZXR1cm4gdGhpcy5hZHZhbmNlKCk7DQogICAgICAgIH0NCg0KICAgICAgICAvLyBpZiB3ZSdyZSBhbGwgZG9uZSB3aXRoIHRoZSB0aW1lbGluZV92YXJpYWJsZXMsIHRoZW4gY2hlY2sgdG8gc2VlIGlmIHRoZXJlIGFyZSBtb3JlIHJlcGV0aXRpb25zDQogICAgICAgIGVsc2UgaWYgKHByb2dyZXNzLmN1cnJlbnRfcmVwZXRpdGlvbiA8IHRpbWVsaW5lX3BhcmFtZXRlcnMucmVwZXRpdGlvbnMgLSAxKSB7DQogICAgICAgICAgdGhpcy5uZXh0UmVwZXRpdG9uKCk7DQogICAgICAgICAgcmV0dXJuIHRoaXMuYWR2YW5jZSgpOw0KICAgICAgICB9DQoNCiAgICAgICAgLy8gaWYgd2UncmUgYWxsIGRvbmUgd2l0aCB0aGUgcmVwZXRpdGlvbnMsIGNoZWNrIGlmIHRoZXJlIGlzIGEgbG9vcCBmdW5jdGlvbi4NCiAgICAgICAgZWxzZSBpZiAodHlwZW9mIHRpbWVsaW5lX3BhcmFtZXRlcnMubG9vcF9mdW5jdGlvbiAhPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICBpZiAodGltZWxpbmVfcGFyYW1ldGVycy5sb29wX2Z1bmN0aW9uKHRoaXMuZ2VuZXJhdGVkRGF0YSgpKSkgew0KICAgICAgICAgICAgdGhpcy5yZXNldCgpOw0KICAgICAgICAgICAgcmV0dXJuIHBhcmVudF9ub2RlLmFkdmFuY2UoKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcHJvZ3Jlc3MuZG9uZSA9IHRydWU7DQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAvLyBubyBtb3JlIGxvb3BzIG9uIHRoaXMgdGltZWxpbmUsIHdlJ3JlIGRvbmUhDQogICAgICAgIGVsc2Ugew0KICAgICAgICAgIHByb2dyZXNzLmRvbmUgPSB0cnVlOw0KICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQoNCiAgICAgIH0NCiAgICB9DQoNCiAgICAvLyBjaGVjayB0aGUgc3RhdHVzIG9mIHRoZSBkb25lIGZsYWcNCiAgICB0aGlzLmlzQ29tcGxldGUgPSBmdW5jdGlvbigpIHsNCiAgICAgIHJldHVybiBwcm9ncmVzcy5kb25lOw0KICAgIH0NCg0KICAgIC8vIGdldHRlciBtZXRob2QgZm9yIHRpbWVsaW5lIHZhcmlhYmxlcw0KICAgIHRoaXMuZ2V0VGltZWxpbmVWYXJpYWJsZVZhbHVlID0gZnVuY3Rpb24odmFyaWFibGVfbmFtZSl7DQogICAgICBpZih0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJyl7DQogICAgICAgIHJldHVybiB1bmRlZmluZWQ7DQogICAgICB9DQogICAgICB2YXIgdiA9IHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVfdmFyaWFibGVzW3Byb2dyZXNzLm9yZGVyW3Byb2dyZXNzLmN1cnJlbnRfdmFyaWFibGVfc2V0XV1bdmFyaWFibGVfbmFtZV07DQogICAgICByZXR1cm4gdjsNCiAgICB9DQoNCiAgICAvLyByZWN1cnNpdmUgdXB3YXJkIHNlYXJjaCBmb3IgdGltZWxpbmUgdmFyaWFibGVzDQogICAgdGhpcy5maW5kVGltZWxpbmVWYXJpYWJsZSA9IGZ1bmN0aW9uKHZhcmlhYmxlX25hbWUpew0KICAgICAgdmFyIHYgPSB0aGlzLmdldFRpbWVsaW5lVmFyaWFibGVWYWx1ZSh2YXJpYWJsZV9uYW1lKTsNCiAgICAgIGlmKHR5cGVvZiB2ID09ICd1bmRlZmluZWQnKXsNCiAgICAgICAgaWYodHlwZW9mIHBhcmVudF9ub2RlICE9PSAndW5kZWZpbmVkJyl7DQogICAgICAgICAgcmV0dXJuIHBhcmVudF9ub2RlLmZpbmRUaW1lbGluZVZhcmlhYmxlKHZhcmlhYmxlX25hbWUpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiB2Ow0KICAgICAgfQ0KICAgIH0NCg0KICAgIC8vIHJlY3Vyc2l2ZSBkb3dud2FyZCBzZWFyY2ggZm9yIGFjdGl2ZSB0cmlhbCB0byBleHRyYWN0IHRpbWVsaW5lIHZhcmlhYmxlDQogICAgdGhpcy50aW1lbGluZVZhcmlhYmxlID0gZnVuY3Rpb24odmFyaWFibGVfbmFtZSl7DQogICAgICBpZih0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJyl7DQogICAgICAgIHJldHVybiB0aGlzLmZpbmRUaW1lbGluZVZhcmlhYmxlKHZhcmlhYmxlX25hbWUpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgLy8gaWYgcHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbiBpcyAtMSwgdGhlbiB0aGUgdGltZWxpbmUgdmFyaWFibGUgaXMgYmVpbmcgZXZhbHVhdGVkDQogICAgICAgIC8vIGluIGEgZnVuY3Rpb24gdGhhdCBydW5zIHByaW9yIHRvIHRoZSB0cmlhbCBzdGFydGluZywgc28gd2Ugc2hvdWxkIHRyZWF0IHRoYXQgdHJpYWwNCiAgICAgICAgLy8gYXMgYmVpbmcgdGhlIGFjdGl2ZSB0cmlhbCBmb3IgcHVycG9zZXMgb2YgZmluZGluZyB0aGUgdmFsdWUgb2YgdGhlIHRpbWVsaW5lIHZhcmlhYmxlDQogICAgICAgIHZhciBsb2MgPSBNYXRoLm1heCgwLCBwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uKTsgDQogICAgICAgIHJldHVybiB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lW2xvY10udGltZWxpbmVWYXJpYWJsZSh2YXJpYWJsZV9uYW1lKTsNCiAgICAgIH0NCiAgICB9DQoNCiAgICAvLyByZWN1cnNpdmVseSBnZXQgdGhlIG51bWJlciBvZiAqKnRyaWFscyoqIGNvbnRhaW5lZCBpbiB0aGUgdGltZWxpbmUNCiAgICAvLyBhc3N1bWluZyB0aGF0IHdoaWxlIGxvb3BzIGV4ZWN1dGUgZXhhY3RseSBvbmNlIGFuZCBpZiBjb25kaXRpb25hbHMNCiAgICAvLyBhbHdheXMgcnVuDQogICAgdGhpcy5sZW5ndGggPSBmdW5jdGlvbigpIHsNCiAgICAgIHZhciBsZW5ndGggPSAwOw0KICAgICAgaWYgKHR5cGVvZiB0aW1lbGluZV9wYXJhbWV0ZXJzICE9PSAndW5kZWZpbmVkJykgew0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmUubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICBsZW5ndGggKz0gdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZVtpXS5sZW5ndGgoKTsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIDE7DQogICAgICB9DQogICAgICByZXR1cm4gbGVuZ3RoOw0KICAgIH0NCg0KICAgIC8vIHJldHVybiB0aGUgcGVyY2VudGFnZSBvZiB0cmlhbHMgY29tcGxldGVkLCBncm91cGVkIGF0IHRoZSBmaXJzdCBjaGlsZCBsZXZlbA0KICAgIC8vIGNvdW50cyBhIHNldCBvZiB0cmlhbHMgYXMgY29tcGxldGUgd2hlbiB0aGUgY2hpbGQgbm9kZSBpcyBkb25lDQogICAgdGhpcy5wZXJjZW50Q29tcGxldGUgPSBmdW5jdGlvbigpIHsNCiAgICAgIHZhciB0b3RhbF90cmlhbHMgPSB0aGlzLmxlbmd0aCgpOw0KICAgICAgdmFyIGNvbXBsZXRlZF90cmlhbHMgPSAwOw0KICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGlmICh0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lW2ldLmlzQ29tcGxldGUoKSkgew0KICAgICAgICAgIGNvbXBsZXRlZF90cmlhbHMgKz0gdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZVtpXS5sZW5ndGgoKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcmV0dXJuIChjb21wbGV0ZWRfdHJpYWxzIC8gdG90YWxfdHJpYWxzICogMTAwKQ0KICAgIH0NCg0KICAgIC8vIHJlc2V0cyB0aGUgbm9kZSBhbmQgYWxsIHN1Ym5vZGVzIHRvIG9yaWdpbmFsIHN0YXRlDQogICAgLy8gYnV0IGluY3JlbWVudHMgdGhlIGN1cnJlbnRfaXRlcmF0aW9uIGNvdW50ZXINCiAgICB0aGlzLnJlc2V0ID0gZnVuY3Rpb24oKSB7DQogICAgICBwcm9ncmVzcy5jdXJyZW50X2xvY2F0aW9uID0gLTE7DQogICAgICBwcm9ncmVzcy5jdXJyZW50X3JlcGV0aXRpb24gPSAwOw0KICAgICAgcHJvZ3Jlc3MuY3VycmVudF92YXJpYWJsZV9zZXQgPSAwOw0KICAgICAgcHJvZ3Jlc3MuY3VycmVudF9pdGVyYXRpb24rKzsNCiAgICAgIHByb2dyZXNzLmRvbmUgPSBmYWxzZTsNCiAgICAgIHRoaXMuc2V0VGltZWxpbmVWYXJpYWJsZXNPcmRlcigpOw0KICAgICAgaWYgKHR5cGVvZiB0aW1lbGluZV9wYXJhbWV0ZXJzICE9ICd1bmRlZmluZWQnKSB7DQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGltZWxpbmVfcGFyYW1ldGVycy50aW1lbGluZS5sZW5ndGg7IGkrKykgew0KICAgICAgICAgIHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbaV0ucmVzZXQoKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgfQ0KDQogICAgLy8gbWFyayB0aGlzIG5vZGUgYXMgZmluaXNoZWQNCiAgICB0aGlzLmVuZCA9IGZ1bmN0aW9uKCkgew0KICAgICAgcHJvZ3Jlc3MuZG9uZSA9IHRydWU7DQogICAgfQ0KDQogICAgLy8gcmVjdXJzaXZlbHkgZW5kIHdoYXRldmVyIHN1Yi1ub2RlIGlzIHJ1bm5pbmcgdGhlIGN1cnJlbnQgdHJpYWwNCiAgICB0aGlzLmVuZEFjdGl2ZU5vZGUgPSBmdW5jdGlvbigpIHsNCiAgICAgIGlmICh0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJykgew0KICAgICAgICB0aGlzLmVuZCgpOw0KICAgICAgICBwYXJlbnRfbm9kZS5lbmQoKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbcHJvZ3Jlc3MuY3VycmVudF9sb2NhdGlvbl0uZW5kQWN0aXZlTm9kZSgpOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIC8vIGdldCBhIHVuaXF1ZSBJRCBhc3NvY2lhdGVkIHdpdGggdGhpcyBub2RlDQogICAgLy8gdGhlIElEIHJlZmxlY3RzIHRoZSBjdXJyZW50IGl0ZXJhdGlvbiB0aHJvdWdoIHRoaXMgbm9kZS4NCiAgICB0aGlzLklEID0gZnVuY3Rpb24oKSB7DQogICAgICB2YXIgaWQgPSAiIjsNCiAgICAgIGlmICh0eXBlb2YgcGFyZW50X25vZGUgPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgcmV0dXJuICIwLiIgKyBwcm9ncmVzcy5jdXJyZW50X2l0ZXJhdGlvbjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGlkICs9IHBhcmVudF9ub2RlLklEKCkgKyAiLSI7DQogICAgICAgIGlkICs9IHJlbGF0aXZlX2lkICsgIi4iICsgcHJvZ3Jlc3MuY3VycmVudF9pdGVyYXRpb247DQogICAgICAgIHJldHVybiBpZDsNCiAgICAgIH0NCiAgICB9DQoNCiAgICAvLyBnZXQgdGhlIElEIG9mIHRoZSBhY3RpdmUgdHJpYWwNCiAgICB0aGlzLmFjdGl2ZUlEID0gZnVuY3Rpb24oKSB7DQogICAgICBpZiAodHlwZW9mIHRpbWVsaW5lX3BhcmFtZXRlcnMgPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuSUQoKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lW3Byb2dyZXNzLmN1cnJlbnRfbG9jYXRpb25dLmFjdGl2ZUlEKCk7DQogICAgICB9DQogICAgfQ0KDQogICAgLy8gZ2V0IGFsbCB0aGUgZGF0YSBnZW5lcmF0ZWQgd2l0aGluIHRoaXMgbm9kZQ0KICAgIHRoaXMuZ2VuZXJhdGVkRGF0YSA9IGZ1bmN0aW9uKCkgew0KICAgICAgcmV0dXJuIGpzUHN5Y2guZGF0YS5nZXREYXRhQnlUaW1lbGluZU5vZGUodGhpcy5JRCgpKTsNCiAgICB9DQoNCiAgICAvLyBnZXQgYWxsIHRoZSB0cmlhbHMgb2YgYSBwYXJ0aWN1bGFyIHR5cGUNCiAgICB0aGlzLnRyaWFsc09mVHlwZSA9IGZ1bmN0aW9uKHR5cGUpIHsNCiAgICAgIGlmICh0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJyl7DQogICAgICAgIGlmICh0cmlhbF9wYXJhbWV0ZXJzLnR5cGUgPT0gdHlwZSkgew0KICAgICAgICAgIHJldHVybiB0cmlhbF9wYXJhbWV0ZXJzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiBbXTsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdmFyIHRyaWFscyA9IFtdOw0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmUubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICB2YXIgdCA9IHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmVbaV0udHJpYWxzT2ZUeXBlKHR5cGUpOw0KICAgICAgICAgIHRyaWFscyA9IHRyaWFscy5jb25jYXQodCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRyaWFsczsNCiAgICAgIH0NCiAgICB9DQoNCiAgICAvLyBhZGQgbmV3IHRyaWFscyB0byBlbmQgb2YgdGhpcyB0aW1lbGluZQ0KICAgIHRoaXMuaW5zZXJ0ID0gZnVuY3Rpb24ocGFyYW1ldGVycyl7DQogICAgICBpZih0eXBlb2YgdGltZWxpbmVfcGFyYW1ldGVycyA9PSAndW5kZWZpbmVkJyl7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Nhbm5vdCBhZGQgbmV3IHRyaWFscyB0byBhIHRyaWFsLWxldmVsIG5vZGUuJyk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lLnB1c2goDQogICAgICAgICAgbmV3IFRpbWVsaW5lTm9kZShPYmplY3QuYXNzaWduKHt9LCBub2RlX3RyaWFsX2RhdGEsIHBhcmFtZXRlcnMpLCBzZWxmLCB0aW1lbGluZV9wYXJhbWV0ZXJzLnRpbWVsaW5lLmxlbmd0aCkNCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICB9DQoNCiAgICAvLyBjb25zdHJ1Y3Rvcg0KICAgIHZhciBfY29uc3RydWN0ID0gZnVuY3Rpb24oKSB7DQoNCiAgICAgIC8vIHN0b3JlIGEgbGluayB0byB0aGUgcGFyZW50IG9mIHRoaXMgbm9kZQ0KICAgICAgcGFyZW50X25vZGUgPSBwYXJlbnQ7DQoNCiAgICAgIC8vIGNyZWF0ZSB0aGUgSUQgZm9yIHRoaXMgbm9kZQ0KICAgICAgaWYgKHR5cGVvZiBwYXJlbnQgPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgcmVsYXRpdmVfaWQgPSAwOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmVsYXRpdmVfaWQgPSByZWxhdGl2ZUlEOw0KICAgICAgfQ0KDQogICAgICAvLyBjaGVjayBpZiB0aGVyZSBpcyBhIHRpbWVsaW5lIHBhcmFtZXRlcg0KICAgICAgLy8gaWYgdGhlcmUgaXMsIHRoZW4gdGhpcyBub2RlIGhhcyBpdHMgb3duIHRpbWVsaW5lDQogICAgICBpZiAoKHR5cGVvZiBwYXJhbWV0ZXJzLnRpbWVsaW5lICE9PSAndW5kZWZpbmVkJykgfHwgKHR5cGVvZiBqc1BzeWNoLnBsdWdpbnNbdHJpYWxfdHlwZV0gPT0gJ2Z1bmN0aW9uJykpIHsNCg0KICAgICAgICAvLyBjcmVhdGUgdGltZWxpbmUgcHJvcGVydGllcw0KICAgICAgICB0aW1lbGluZV9wYXJhbWV0ZXJzID0gew0KICAgICAgICAgIHRpbWVsaW5lOiBbXSwNCiAgICAgICAgICBsb29wX2Z1bmN0aW9uOiBwYXJhbWV0ZXJzLmxvb3BfZnVuY3Rpb24sDQogICAgICAgICAgY29uZGl0aW9uYWxfZnVuY3Rpb246IHBhcmFtZXRlcnMuY29uZGl0aW9uYWxfZnVuY3Rpb24sDQogICAgICAgICAgc2FtcGxlOiBwYXJhbWV0ZXJzLnNhbXBsZSwNCiAgICAgICAgICByYW5kb21pemVfb3JkZXI6IHR5cGVvZiBwYXJhbWV0ZXJzLnJhbmRvbWl6ZV9vcmRlciA9PSAndW5kZWZpbmVkJyA/IGZhbHNlIDogcGFyYW1ldGVycy5yYW5kb21pemVfb3JkZXIsDQogICAgICAgICAgcmVwZXRpdGlvbnM6IHR5cGVvZiBwYXJhbWV0ZXJzLnJlcGV0aXRpb25zID09ICd1bmRlZmluZWQnID8gMSA6IHBhcmFtZXRlcnMucmVwZXRpdGlvbnMsDQogICAgICAgICAgdGltZWxpbmVfdmFyaWFibGVzOiB0eXBlb2YgcGFyYW1ldGVycy50aW1lbGluZV92YXJpYWJsZXMgPT0gJ3VuZGVmaW5lZCcgPyBbe31dIDogcGFyYW1ldGVycy50aW1lbGluZV92YXJpYWJsZXMNCiAgICAgICAgfTsNCg0KICAgICAgICBzZWxmLnNldFRpbWVsaW5lVmFyaWFibGVzT3JkZXIoKTsNCg0KICAgICAgICAvLyBleHRyYWN0IGFsbCBvZiB0aGUgbm9kZSBsZXZlbCBkYXRhIGFuZCBwYXJhbWV0ZXJzDQogICAgICAgIHZhciBub2RlX2RhdGEgPSBPYmplY3QuYXNzaWduKHt9LCBwYXJhbWV0ZXJzKTsNCiAgICAgICAgZGVsZXRlIG5vZGVfZGF0YS50aW1lbGluZTsNCiAgICAgICAgZGVsZXRlIG5vZGVfZGF0YS5jb25kaXRpb25hbF9mdW5jdGlvbjsNCiAgICAgICAgZGVsZXRlIG5vZGVfZGF0YS5sb29wX2Z1bmN0aW9uOw0KICAgICAgICBkZWxldGUgbm9kZV9kYXRhLnJhbmRvbWl6ZV9vcmRlcjsNCiAgICAgICAgZGVsZXRlIG5vZGVfZGF0YS5yZXBldGl0aW9uczsNCiAgICAgICAgZGVsZXRlIG5vZGVfZGF0YS50aW1lbGluZV92YXJpYWJsZXM7DQogICAgICAgIGRlbGV0ZSBub2RlX2RhdGEuc2FtcGxlOw0KICAgICAgICBub2RlX3RyaWFsX2RhdGEgPSBub2RlX2RhdGE7IC8vIHN0b3JlIGZvciBsYXRlci4uLg0KDQogICAgICAgIC8vIGNyZWF0ZSBhIFRpbWVsaW5lTm9kZSBmb3IgZWFjaCBlbGVtZW50IGluIHRoZSB0aW1lbGluZQ0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcmFtZXRlcnMudGltZWxpbmUubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAvLyBtZXJnZSBwYXJhbWV0ZXJzDQogICAgICAgICAgdmFyIG1lcmdlZF9wYXJhbWV0ZXJzID0gT2JqZWN0LmFzc2lnbih7fSwgbm9kZV9kYXRhLCBwYXJhbWV0ZXJzLnRpbWVsaW5lW2ldKTsNCiAgICAgICAgICAvLyBtZXJnZSBhbnkgZGF0YSBmcm9tIHRoZSBwYXJlbnQgbm9kZSBpbnRvIGNoaWxkIG5vZGVzDQogICAgICAgICAgaWYodHlwZW9mIG5vZGVfZGF0YS5kYXRhID09ICdvYmplY3QnICYmIHR5cGVvZiBwYXJhbWV0ZXJzLnRpbWVsaW5lW2ldLmRhdGEgPT0gJ29iamVjdCcpew0KICAgICAgICAgICAgdmFyIG1lcmdlZF9kYXRhID0gT2JqZWN0LmFzc2lnbih7fSwgbm9kZV9kYXRhLmRhdGEsIHBhcmFtZXRlcnMudGltZWxpbmVbaV0uZGF0YSk7DQogICAgICAgICAgICBtZXJnZWRfcGFyYW1ldGVycy5kYXRhID0gbWVyZ2VkX2RhdGE7DQogICAgICAgICAgfQ0KICAgICAgICAgIHRpbWVsaW5lX3BhcmFtZXRlcnMudGltZWxpbmUucHVzaChuZXcgVGltZWxpbmVOb2RlKG1lcmdlZF9wYXJhbWV0ZXJzLCBzZWxmLCBpKSk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8vIGlmIHRoZXJlIGlzIG5vIHRpbWVsaW5lIHBhcmFtZXRlciwgdGhlbiB0aGlzIG5vZGUgaXMgYSB0cmlhbCBub2RlDQogICAgICBlbHNlIHsNCiAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIGEgdmFsaWQgdHJpYWwgdHlwZSBpcyBkZWZpbmVkDQogICAgICAgIHZhciB0cmlhbF90eXBlID0gcGFyYW1ldGVycy50eXBlOw0KICAgICAgICBpZiAodHlwZW9mIHRyaWFsX3R5cGUgPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICBjb25zb2xlLmVycm9yKCdUcmlhbCBsZXZlbCBub2RlIGlzIG1pc3NpbmcgdGhlICJ0eXBlIiBwYXJhbWV0ZXIuIFRoZSBwYXJhbWV0ZXJzIGZvciB0aGUgbm9kZSBhcmU6ICcgKyBKU09OLnN0cmluZ2lmeShwYXJhbWV0ZXJzKSk7DQogICAgICAgIH0gZWxzZSBpZiAoKHR5cGVvZiBqc1BzeWNoLnBsdWdpbnNbdHJpYWxfdHlwZV0gPT0gJ3VuZGVmaW5lZCcpICYmICh0cmlhbF90eXBlLnRvU3RyaW5nKCkucmVwbGFjZSgvXHMvZywnJykgIT0gImZ1bmN0aW9uKCl7cmV0dXJudGltZWxpbmUudGltZWxpbmVWYXJpYWJsZSh2YXJuYW1lKTt9IikpIHsNCiAgICAgICAgICBjb25zb2xlLmVycm9yKCdObyBwbHVnaW4gbG9hZGVkIGZvciB0cmlhbHMgb2YgdHlwZSAiJyArIHRyaWFsX3R5cGUgKyAnIicpOw0KICAgICAgICB9DQogICAgICAgIC8vIGNyZWF0ZSBhIGRlZXAgY29weSBvZiB0aGUgcGFyYW1ldGVycyBmb3IgdGhlIHRyaWFsDQogICAgICAgIHRyaWFsX3BhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCBwYXJhbWV0ZXJzKTsNCiAgICAgIH0NCg0KICAgIH0oKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHN0YXJ0RXhwZXJpbWVudCgpIHsNCg0KICAgIGxvYWRlZCA9IHRydWU7DQoNCiAgICAvLyBzaG93IHByb2dyZXNzIGJhciBpZiByZXF1ZXN0ZWQNCiAgICBpZiAob3B0cy5zaG93X3Byb2dyZXNzX2JhciA9PT0gdHJ1ZSkgew0KICAgICAgZHJhd1Byb2dyZXNzQmFyKG9wdHMubWVzc2FnZV9wcm9ncmVzc19iYXIpOw0KICAgIH0NCg0KICAgIC8vIHJlY29yZCB0aGUgc3RhcnQgdGltZQ0KICAgIGV4cF9zdGFydF90aW1lID0gbmV3IERhdGUoKTsNCg0KICAgIC8vIGJlZ2luIQ0KICAgIHRpbWVsaW5lLmFkdmFuY2UoKTsNCiAgICBkb1RyaWFsKHRpbWVsaW5lLnRyaWFsKCkpOw0KDQogIH0NCg0KICBmdW5jdGlvbiBmaW5pc2hFeHBlcmltZW50KCkgew0KDQogICAgaWYodHlwZW9mIHRpbWVsaW5lLmVuZF9tZXNzYWdlICE9PSAndW5kZWZpbmVkJyl7DQogICAgICBET01fdGFyZ2V0LmlubmVySFRNTCA9IHRpbWVsaW5lLmVuZF9tZXNzYWdlOw0KICAgIH0NCg0KICAgIG9wdHMub25fZmluaXNoKGpzUHN5Y2guZGF0YS5nZXQoKSk7DQoNCiAgfQ0KDQogIGZ1bmN0aW9uIG5leHRUcmlhbCgpIHsNCiAgICAvLyBpZiBleHBlcmltZW50IGlzIHBhdXNlZCwgZG9uJ3QgZG8gYW55dGhpbmcuDQogICAgaWYocGF1c2VkKSB7DQogICAgICB3YWl0aW5nID0gdHJ1ZTsNCiAgICAgIHJldHVybjsNCiAgICB9DQoNCiAgICBnbG9iYWxfdHJpYWxfaW5kZXgrKzsNCg0KICAgIC8vIGFkdmFuY2UgdGltZWxpbmUNCiAgICB0aW1lbGluZS5tYXJrQ3VycmVudFRyaWFsQ29tcGxldGUoKTsNCiAgICB2YXIgY29tcGxldGUgPSB0aW1lbGluZS5hZHZhbmNlKCk7DQoNCiAgICAvLyB1cGRhdGUgcHJvZ3Jlc3MgYmFyIGlmIHNob3duDQogICAgaWYgKG9wdHMuc2hvd19wcm9ncmVzc19iYXIgPT09IHRydWUgJiYgb3B0cy5hdXRvX3VwZGF0ZV9wcm9ncmVzc19iYXIgPT0gdHJ1ZSkgew0KICAgICAgdXBkYXRlUHJvZ3Jlc3NCYXIoKTsNCiAgICB9DQoNCiAgICAvLyBjaGVjayBpZiBleHBlcmltZW50IGlzIG92ZXINCiAgICBpZiAoY29tcGxldGUpIHsNCiAgICAgIGZpbmlzaEV4cGVyaW1lbnQoKTsNCiAgICAgIHJldHVybjsNCiAgICB9DQoNCiAgICBkb1RyaWFsKHRpbWVsaW5lLnRyaWFsKCkpOw0KICB9DQoNCiAgZnVuY3Rpb24gZG9UcmlhbCh0cmlhbCkgew0KDQogICAgY3VycmVudF90cmlhbCA9IHRyaWFsOw0KICAgIGN1cnJlbnRfdHJpYWxfZmluaXNoZWQgPSBmYWxzZTsNCg0KICAgIC8vIHByb2Nlc3MgYWxsIHRpbWVsaW5lIHZhcmlhYmxlcyBmb3IgdGhpcyB0cmlhbA0KICAgIGV2YWx1YXRlVGltZWxpbmVWYXJpYWJsZXModHJpYWwpOw0KDQogICAgLy8gZXZhbHVhdGUgdmFyaWFibGVzIHRoYXQgYXJlIGZ1bmN0aW9ucw0KICAgIGV2YWx1YXRlRnVuY3Rpb25QYXJhbWV0ZXJzKHRyaWFsKTsNCg0KICAgIC8vIGdldCBkZWZhdWx0IHZhbHVlcyBmb3IgcGFyYW1ldGVycw0KICAgIHNldERlZmF1bHRWYWx1ZXModHJpYWwpOw0KDQogICAgLy8gY2FsbCBleHBlcmltZW50IHdpZGUgY2FsbGJhY2sNCiAgICBvcHRzLm9uX3RyaWFsX3N0YXJ0KHRyaWFsKTsNCg0KICAgIC8vIGNhbGwgdHJpYWwgc3BlY2lmaWMgY2FsbGJhY2sgaWYgaXQgZXhpc3RzDQogICAgaWYodHlwZW9mIHRyaWFsLm9uX3N0YXJ0ID09ICdmdW5jdGlvbicpew0KICAgICAgdHJpYWwub25fc3RhcnQodHJpYWwpOw0KICAgIH0NCg0KICAgIC8vIGFwcGx5IHRoZSBmb2N1cyB0byB0aGUgZWxlbWVudCBjb250YWluaW5nIHRoZSBleHBlcmltZW50Lg0KICAgIERPTV9jb250YWluZXIuZm9jdXMoKTsNCg0KICAgIC8vIHJlc2V0IHRoZSBzY3JvbGwgb24gdGhlIERPTSB0YXJnZXQNCiAgICBET01fdGFyZ2V0LnNjcm9sbFRvcCA9IDA7DQoNCiAgICAvLyBleGVjdXRlIHRyaWFsIG1ldGhvZA0KICAgIGpzUHN5Y2gucGx1Z2luc1t0cmlhbC50eXBlXS50cmlhbChET01fdGFyZ2V0LCB0cmlhbCk7DQoNCiAgICAvLyBjYWxsIHRyaWFsIHNwZWNpZmljIGxvYWRlZCBjYWxsYmFjayBpZiBpdCBleGlzdHMNCiAgICBpZih0eXBlb2YgdHJpYWwub25fbG9hZCA9PSAnZnVuY3Rpb24nKXsNCiAgICAgIHRyaWFsLm9uX2xvYWQoKTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBldmFsdWF0ZVRpbWVsaW5lVmFyaWFibGVzKHRyaWFsKXsNCiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRyaWFsKTsNCg0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgew0KICAgICAgLy8gdGltZWxpbmUgdmFyaWFibGVzIG9uIHRoZSByb290IGxldmVsDQogICAgICBpZiAodHlwZW9mIHRyaWFsW2tleXNbaV1dID09ICJmdW5jdGlvbiIgJiYgdHJpYWxba2V5c1tpXV0udG9TdHJpbmcoKS5yZXBsYWNlKC9ccy9nLCcnKSA9PSAiZnVuY3Rpb24oKXtyZXR1cm50aW1lbGluZS50aW1lbGluZVZhcmlhYmxlKHZhcm5hbWUpO30iKSB7DQogICAgICAgIHRyaWFsW2tleXNbaV1dID0gdHJpYWxba2V5c1tpXV0uY2FsbCgpOw0KICAgICAgfQ0KICAgICAgLy8gdGltZWxpbmUgdmFyaWFibGVzIHRoYXQgYXJlIG5lc3RlZCBpbiBvYmplY3RzDQogICAgICBpZiAodHlwZW9mIHRyaWFsW2tleXNbaV1dID09ICJvYmplY3QiICYmIHRyaWFsW2tleXNbaV1dICE9PSBudWxsKXsNCiAgICAgICAgZXZhbHVhdGVUaW1lbGluZVZhcmlhYmxlcyh0cmlhbFtrZXlzW2ldXSk7DQogICAgICB9DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gZXZhbHVhdGVGdW5jdGlvblBhcmFtZXRlcnModHJpYWwpew0KDQogICAgLy8gZmlyc3QsIGV2YWwgdGhlIHRyaWFsIHR5cGUgaWYgaXQgaXMgYSBmdW5jdGlvbg0KICAgIC8vIHRoaXMgbGV0cyB1c2VycyBzZXQgdGhlIHBsdWdpbiB0eXBlIHdpdGggYSBmdW5jdGlvbg0KICAgIGlmKHR5cGVvZiB0cmlhbC50eXBlID09PSAnZnVuY3Rpb24nKXsNCiAgICAgIHRyaWFsLnR5cGUgPSB0cmlhbC50eXBlLmNhbGwoKTsNCiAgICB9DQoNCiAgICAvLyBub3cgZXZhbCB0aGUgd2hvbGUgdHJpYWwNCg0KICAgIC8vIHN0YXJ0IGJ5IGdldHRpbmcgYSBsaXN0IG9mIHRoZSBwYXJhbWV0ZXJzDQogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh0cmlhbCk7DQoNCiAgICAvLyBpdGVyYXRlIG92ZXIgZWFjaCBwYXJhbWV0ZXINCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsNCiAgICAgIC8vIGNoZWNrIHRvIG1ha2Ugc3VyZSBwYXJhbWV0ZXIgaXMgbm90ICJ0eXBlIiwgc2luY2UgdGhhdCB3YXMgZXZhbCdkIGFib3ZlLg0KICAgICAgaWYoa2V5c1tpXSAhPT0gJ3R5cGUnKXsNCiAgICAgICAgLy8gdGhpcyBpZiBzdGF0ZW1lbnQgaXMgY2hlY2tpbmcgdG8gc2VlIGlmIHRoZSBwYXJhbWV0ZXIgdHlwZSBpcyBleHBlY3RlZCB0byBiZSBhIGZ1bmN0aW9uLCBpbiB3aGljaCBjYXNlIHdlIHNob3VsZCBOT1QgZXZhbHVhdGUgaXQuDQogICAgICAgIC8vIHRoZSBmaXJzdCBsaW5lIGNoZWNrcyBpZiB0aGUgcGFyYW1ldGVyIGlzIGRlZmluZWQgaW4gdGhlIHVuaXZlcnNhbFBsdWdpblBhcmFtZXRlcnMgc2V0DQogICAgICAgIC8vIHRoZSBzZWNvbmQgbGluZSBjaGVja3MgdGhlIHBsdWdpbi1zcGVjaWZpYyBwYXJhbWV0ZXJzDQogICAgICAgIGlmKA0KICAgICAgICAgICh0eXBlb2YganNQc3ljaC5wbHVnaW5zLnVuaXZlcnNhbFBsdWdpblBhcmFtZXRlcnNba2V5c1tpXV0gIT09ICd1bmRlZmluZWQnICYmIGpzUHN5Y2gucGx1Z2lucy51bml2ZXJzYWxQbHVnaW5QYXJhbWV0ZXJzW2tleXNbaV1dLnR5cGUgIT09IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLkZVTkNUSU9OICkgfHwNCiAgICAgICAgICAodHlwZW9mIGpzUHN5Y2gucGx1Z2luc1t0cmlhbC50eXBlXS5pbmZvLnBhcmFtZXRlcnNba2V5c1tpXV0gIT09ICd1bmRlZmluZWQnICYmIGpzUHN5Y2gucGx1Z2luc1t0cmlhbC50eXBlXS5pbmZvLnBhcmFtZXRlcnNba2V5c1tpXV0udHlwZSAhPT0ganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuRlVOQ1RJT04pDQogICAgICAgICkgew0KICAgICAgICAgIGlmICh0eXBlb2YgdHJpYWxba2V5c1tpXV0gPT0gImZ1bmN0aW9uIikgew0KICAgICAgICAgICAgdHJpYWxba2V5c1tpXV0gPSB0cmlhbFtrZXlzW2ldXS5jYWxsKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgICAvLyBhZGQgYSBzcGVjaWFsIGV4Y2VwdGlvbiBmb3IgdGhlIGRhdGEgcGFyYW1ldGVyIHNvIHdlIGNhbiBldmFsdWF0ZSBmdW5jdGlvbnMuIGV2ZW50dWFsbHkgdGhpcyBjb3VsZCBiZSBnZW5lcmFsaXplZCBzbyB0aGF0IGFueSBDT01QTEVYIG9iamVjdCB0eXBlIGNvdWxkDQogICAgICAvLyBiZSBldmFsdWF0ZWQgYXQgdGhlIGluZGl2aWR1YWwgcGFyYW1ldGVyIGxldmVsLg0KICAgICAgaWYoa2V5c1tpXSA9PSAnZGF0YScpew0KICAgICAgICB2YXIgZGF0YV9wYXJhbXMgPSBPYmplY3Qua2V5cyh0cmlhbFtrZXlzW2ldXSk7DQogICAgICAgIGZvcih2YXIgaj0wOyBqPGRhdGFfcGFyYW1zLmxlbmd0aDsgaisrKXsNCiAgICAgICAgICBpZih0eXBlb2YgdHJpYWxba2V5c1tpXV1bZGF0YV9wYXJhbXNbal1dID09ICJmdW5jdGlvbiIpIHsNCiAgICAgICAgICAgIHRyaWFsW2tleXNbaV1dW2RhdGFfcGFyYW1zW2pdXSA9IHRyaWFsW2tleXNbaV1dW2RhdGFfcGFyYW1zW2pdXS5jYWxsKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gc2V0RGVmYXVsdFZhbHVlcyh0cmlhbCl7DQogICAgZm9yKHZhciBwYXJhbSBpbiBqc1BzeWNoLnBsdWdpbnNbdHJpYWwudHlwZV0uaW5mby5wYXJhbWV0ZXJzKXsNCiAgICAgIC8vIGNoZWNrIGlmIHBhcmFtZXRlciBpcyBjb21wbGV4IHdpdGggbmVzdGVkIGRlZmF1bHRzDQogICAgICBpZihqc1BzeWNoLnBsdWdpbnNbdHJpYWwudHlwZV0uaW5mby5wYXJhbWV0ZXJzW3BhcmFtXS50eXBlID09IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLkNPTVBMRVgpew0KICAgICAgICBpZihqc1BzeWNoLnBsdWdpbnNbdHJpYWwudHlwZV0uaW5mby5wYXJhbWV0ZXJzW3BhcmFtXS5hcnJheSA9PSB0cnVlKXsNCiAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgZWFjaCBlbnRyeSBpbiB0aGUgYXJyYXkNCiAgICAgICAgICBmb3IodmFyIGkgaW4gdHJpYWxbcGFyYW1dKXsNCiAgICAgICAgICAgIC8vIGNoZWNrIGVhY2ggcGFyYW1ldGVyIGluIHRoZSBwbHVnaW4gZGVzY3JpcHRpb24NCiAgICAgICAgICAgIGZvcih2YXIgcCBpbiBqc1BzeWNoLnBsdWdpbnNbdHJpYWwudHlwZV0uaW5mby5wYXJhbWV0ZXJzW3BhcmFtXS5uZXN0ZWQpew0KICAgICAgICAgICAgICBpZih0eXBlb2YgdHJpYWxbcGFyYW1dW2ldW3BdID09ICd1bmRlZmluZWQnIHx8IHRyaWFsW3BhcmFtXVtpXVtwXSA9PT0gbnVsbCl7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mIGpzUHN5Y2gucGx1Z2luc1t0cmlhbC50eXBlXS5pbmZvLnBhcmFtZXRlcnNbcGFyYW1dLm5lc3RlZFtwXS5kZWZhdWx0ID09ICd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1lvdSBtdXN0IHNwZWNpZnkgYSB2YWx1ZSBmb3IgdGhlICcrcCsnIHBhcmFtZXRlciAobmVzdGVkIGluIHRoZSAnK3BhcmFtKycgcGFyYW1ldGVyKSBpbiB0aGUgJyt0cmlhbC50eXBlKycgcGx1Z2luLicpOw0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICB0cmlhbFtwYXJhbV1baV1bcF0gPSBqc1BzeWNoLnBsdWdpbnNbdHJpYWwudHlwZV0uaW5mby5wYXJhbWV0ZXJzW3BhcmFtXS5uZXN0ZWRbcF0uZGVmYXVsdDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0gICAgICANCiAgICAgIC8vIGlmIGl0J3Mgbm90IG5lc3RlZCwgY2hlY2tpbmcgaXMgbXVjaCBlYXNpZXIgYW5kIGRvIHRoYXQgaGVyZToNCiAgICAgIGVsc2UgaWYodHlwZW9mIHRyaWFsW3BhcmFtXSA9PSAndW5kZWZpbmVkJyB8fCB0cmlhbFtwYXJhbV0gPT09IG51bGwpew0KICAgICAgICBpZih0eXBlb2YganNQc3ljaC5wbHVnaW5zW3RyaWFsLnR5cGVdLmluZm8ucGFyYW1ldGVyc1twYXJhbV0uZGVmYXVsdCA9PSAndW5kZWZpbmVkJyl7DQogICAgICAgICAgY29uc29sZS5lcnJvcignWW91IG11c3Qgc3BlY2lmeSBhIHZhbHVlIGZvciB0aGUgJytwYXJhbSsnIHBhcmFtZXRlciBpbiB0aGUgJyt0cmlhbC50eXBlKycgcGx1Z2luLicpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRyaWFsW3BhcmFtXSA9IGpzUHN5Y2gucGx1Z2luc1t0cmlhbC50eXBlXS5pbmZvLnBhcmFtZXRlcnNbcGFyYW1dLmRlZmF1bHQ7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBjaGVja0V4Y2x1c2lvbnMoZXhjbHVzaW9ucywgc3VjY2VzcywgZmFpbCl7DQogICAgdmFyIGNsZWFyID0gdHJ1ZTsNCg0KICAgIC8vIE1JTklNVU0gU0laRQ0KICAgIGlmKHR5cGVvZiBleGNsdXNpb25zLm1pbl93aWR0aCAhPT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGV4Y2x1c2lvbnMubWluX2hlaWdodCAhPT0gJ3VuZGVmaW5lZCcpew0KICAgICAgdmFyIG13ID0gdHlwZW9mIGV4Y2x1c2lvbnMubWluX3dpZHRoICE9PSAndW5kZWZpbmVkJyA/IGV4Y2x1c2lvbnMubWluX3dpZHRoIDogMDsNCiAgICAgIHZhciBtaCA9IHR5cGVvZiBleGNsdXNpb25zLm1pbl9oZWlnaHQgIT09ICd1bmRlZmluZWQnID8gZXhjbHVzaW9ucy5taW5faGVpZ2h0IDogMDsNCiAgICAgIHZhciB3ID0gd2luZG93LmlubmVyV2lkdGg7DQogICAgICB2YXIgaCA9IHdpbmRvdy5pbm5lckhlaWdodDsNCiAgICAgIGlmKHcgPCBtdyB8fCBoIDwgbWgpew0KICAgICAgICBjbGVhciA9IGZhbHNlOw0KICAgICAgICB2YXIgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpew0KICAgICAgICAgIHZhciB3ID0gd2luZG93LmlubmVyV2lkdGg7DQogICAgICAgICAgdmFyIGggPSB3aW5kb3cuaW5uZXJIZWlnaHQ7DQogICAgICAgICAgaWYodyA8IG13IHx8IGggPCBtaCl7DQogICAgICAgICAgICB2YXIgbXNnID0gJzxwPllvdXIgYnJvd3NlciB3aW5kb3cgaXMgdG9vIHNtYWxsIHRvIGNvbXBsZXRlIHRoaXMgZXhwZXJpbWVudC4gJysNCiAgICAgICAgICAgICAgJ1BsZWFzZSBtYXhpbWl6ZSB0aGUgc2l6ZSBvZiB5b3VyIGJyb3dzZXIgd2luZG93LiBJZiB5b3VyIGJyb3dzZXIgd2luZG93IGlzIGFscmVhZHkgbWF4aW1pemVkLCAnKw0KICAgICAgICAgICAgICAneW91IHdpbGwgbm90IGJlIGFibGUgdG8gY29tcGxldGUgdGhpcyBleHBlcmltZW50LjwvcD4nKw0KICAgICAgICAgICAgICAnPHA+VGhlIG1pbmltdW0gd2lkdGggaXMgJyttdysncHguIFlvdXIgY3VycmVudCB3aWR0aCBpcyAnK3crJ3B4LjwvcD4nKw0KICAgICAgICAgICAgICAnPHA+VGhlIG1pbmltdW0gaGVpZ2h0IGlzICcrbWgrJ3B4LiBZb3VyIGN1cnJlbnQgaGVpZ2h0IGlzICcraCsncHguPC9wPic7DQogICAgICAgICAgICBjb3JlLmdldERpc3BsYXlFbGVtZW50KCkuaW5uZXJIVE1MID0gbXNnOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsKTsNCiAgICAgICAgICAgIGNvcmUuZ2V0RGlzcGxheUVsZW1lbnQoKS5pbm5lckhUTUwgPSAnJzsNCiAgICAgICAgICAgIGNoZWNrRXhjbHVzaW9ucyhleGNsdXNpb25zLCBzdWNjZXNzLCBmYWlsKTsNCiAgICAgICAgICB9DQogICAgICAgIH0sIDEwMCk7DQogICAgICAgIHJldHVybjsgLy8gcHJldmVudHMgY2hlY2tpbmcgb3RoZXIgZXhjbHVzaW9ucyB3aGlsZSB0aGlzIGlzIGJlaW5nIGZpeGVkDQogICAgICB9DQogICAgfQ0KDQogICAgLy8gV0VCIEFVRElPIEFQSQ0KICAgIGlmKHR5cGVvZiBleGNsdXNpb25zLmF1ZGlvICE9PSAndW5kZWZpbmVkJyAmJiBleGNsdXNpb25zLmF1ZGlvKSB7DQogICAgICBpZih3aW5kb3cuaGFzT3duUHJvcGVydHkoJ0F1ZGlvQ29udGV4dCcpIHx8IHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgnd2Via2l0QXVkaW9Db250ZXh0Jykpew0KICAgICAgICAvLyBjbGVhcg0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY2xlYXIgPSBmYWxzZTsNCiAgICAgICAgdmFyIG1zZyA9ICc8cD5Zb3VyIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCB0aGUgV2ViQXVkaW8gQVBJLCB3aGljaCBtZWFucyB0aGF0IHlvdSB3aWxsIG5vdCAnKw0KICAgICAgICAgICdiZSBhYmxlIHRvIGNvbXBsZXRlIHRoZSBleHBlcmltZW50LjwvcD48cD5Ccm93c2VycyB0aGF0IHN1cHBvcnQgdGhlIFdlYkF1ZGlvIEFQSSBpbmNsdWRlICcrDQogICAgICAgICAgJ0Nocm9tZSwgRmlyZWZveCwgU2FmYXJpLCBhbmQgRWRnZS48L3A+JzsNCiAgICAgICAgY29yZS5nZXREaXNwbGF5RWxlbWVudCgpLmlubmVySFRNTCA9IG1zZzsNCiAgICAgICAgZmFpbCgpOw0KICAgICAgICByZXR1cm47DQogICAgICB9DQogICAgfQ0KDQogICAgLy8gR08/DQogICAgaWYoY2xlYXIpeyBzdWNjZXNzKCk7IH0NCiAgfQ0KDQogIGZ1bmN0aW9uIGRyYXdQcm9ncmVzc0Jhcihtc2cpIHsNCiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuanNwc3ljaC1kaXNwbGF5LWVsZW1lbnQnKS5pbnNlcnRBZGphY2VudEhUTUwoJ2FmdGVyYmVnaW4nLA0KICAgICAgJzxkaXYgaWQ9ImpzcHN5Y2gtcHJvZ3Jlc3NiYXItY29udGFpbmVyIj4nKw0KICAgICAgJzxzcGFuPicrDQogICAgICBtc2crIA0KICAgICAgJzwvc3Bhbj4nKw0KICAgICAgJzxkaXYgaWQ9ImpzcHN5Y2gtcHJvZ3Jlc3NiYXItb3V0ZXIiPicrDQogICAgICAgICc8ZGl2IGlkPSJqc3BzeWNoLXByb2dyZXNzYmFyLWlubmVyIj48L2Rpdj4nKw0KICAgICAgJzwvZGl2PjwvZGl2PicpOw0KICB9DQoNCiAgZnVuY3Rpb24gdXBkYXRlUHJvZ3Jlc3NCYXIoKSB7DQogICAgdmFyIHByb2dyZXNzID0ganNQc3ljaC5wcm9ncmVzcygpLnBlcmNlbnRfY29tcGxldGU7DQogICAgY29yZS5zZXRQcm9ncmVzc0Jhcihwcm9ncmVzcyAvIDEwMCk7DQogIH0NCg0KICB2YXIgcHJvZ3Jlc3NfYmFyX2Ftb3VudCA9IDA7DQoNCiAgY29yZS5zZXRQcm9ncmVzc0JhciA9IGZ1bmN0aW9uKHByb3BvcnRpb25fY29tcGxldGUpew0KICAgIHByb3BvcnRpb25fY29tcGxldGUgPSBNYXRoLm1heChNYXRoLm1pbigxLHByb3BvcnRpb25fY29tcGxldGUpLDApOw0KICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNqc3BzeWNoLXByb2dyZXNzYmFyLWlubmVyJykuc3R5bGUud2lkdGggPSAocHJvcG9ydGlvbl9jb21wbGV0ZSoxMDApICsgIiUiOw0KICAgIHByb2dyZXNzX2Jhcl9hbW91bnQgPSBwcm9wb3J0aW9uX2NvbXBsZXRlOw0KICB9DQoNCiAgY29yZS5nZXRQcm9ncmVzc0JhckNvbXBsZXRlZCA9IGZ1bmN0aW9uKCl7DQogICAgcmV0dXJuIHByb2dyZXNzX2Jhcl9hbW91bnQ7DQogIH0NCg0KICAvL0xlYXZlIGEgdHJhY2UgaW4gdGhlIERPTSB0aGF0IGpzcHN5Y2ggd2FzIGxvYWRlZA0KICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2V0QXR0cmlidXRlKCdqc3BzeWNoJywgJ3ByZXNlbnQnKTsNCg0KICByZXR1cm4gY29yZTsNCn0pKCk7DQoNCmpzUHN5Y2gucGx1Z2lucyA9IChmdW5jdGlvbigpIHsNCg0KICB2YXIgbW9kdWxlID0ge307DQoNCiAgLy8gZW51bWVyYXRlIHBvc3NpYmxlIHBhcmFtZXRlciB0eXBlcyBmb3IgcGx1Z2lucw0KICBtb2R1bGUucGFyYW1ldGVyVHlwZSA9IHsNCiAgICBCT09MOiAwLA0KICAgIFNUUklORzogMSwNCiAgICBJTlQ6IDIsDQogICAgRkxPQVQ6IDMsDQogICAgRlVOQ1RJT046IDQsDQogICAgS0VZQ09ERTogNSwNCiAgICBTRUxFQ1Q6IDYsDQogICAgSFRNTF9TVFJJTkc6IDcsDQogICAgSU1BR0U6IDgsDQogICAgQVVESU86IDksDQogICAgVklERU86IDEwLA0KICAgIE9CSkVDVDogMTEsDQogICAgQ09NUExFWDogMTINCiAgfQ0KDQogIG1vZHVsZS51bml2ZXJzYWxQbHVnaW5QYXJhbWV0ZXJzID0gew0KICAgIGRhdGE6IHsNCiAgICAgIHR5cGU6IG1vZHVsZS5wYXJhbWV0ZXJUeXBlLk9CSkVDVCwNCiAgICAgIHByZXR0eV9uYW1lOiAnRGF0YScsDQogICAgICBkZWZhdWx0OiB7fSwNCiAgICAgIGRlc2NyaXB0aW9uOiAnRGF0YSB0byBhZGQgdG8gdGhpcyB0cmlhbCAoa2V5LXZhbHVlIHBhaXJzKScNCiAgICB9LA0KICAgIG9uX3N0YXJ0OiB7DQogICAgICB0eXBlOiBtb2R1bGUucGFyYW1ldGVyVHlwZS5GVU5DVElPTiwNCiAgICAgIHByZXR0eV9uYW1lOiAnT24gc3RhcnQnLA0KICAgICAgZGVmYXVsdDogZnVuY3Rpb24oKSB7IHJldHVybjsgfSwNCiAgICAgIGRlc2NyaXB0aW9uOiAnRnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIHRyaWFsIGJlZ2lucycNCiAgICB9LA0KICAgIG9uX2ZpbmlzaDogew0KICAgICAgdHlwZTogbW9kdWxlLnBhcmFtZXRlclR5cGUuRlVOQ1RJT04sDQogICAgICBwcmV0dHlfbmFtZTogJ09uIGZpbmlzaCcsDQogICAgICBkZWZhdWx0OiBmdW5jdGlvbigpIHsgcmV0dXJuOyB9LA0KICAgICAgZGVzY3JpcHRpb246ICdGdW5jdGlvbiB0byBleGVjdXRlIHdoZW4gdHJpYWwgaXMgZmluaXNoZWQnDQogICAgfSwNCiAgICBvbl9sb2FkOiB7DQogICAgICB0eXBlOiBtb2R1bGUucGFyYW1ldGVyVHlwZS5GVU5DVElPTiwNCiAgICAgIHByZXR0eV9uYW1lOiAnT24gbG9hZCcsDQogICAgICBkZWZhdWx0OiBmdW5jdGlvbigpIHsgcmV0dXJuOyB9LA0KICAgICAgZGVzY3JpcHRpb246ICdGdW5jdGlvbiB0byBleGVjdXRlIGFmdGVyIHRoZSB0cmlhbCBoYXMgbG9hZGVkJw0KICAgIH0sDQogICAgcG9zdF90cmlhbF9nYXA6IHsNCiAgICAgIHR5cGU6IG1vZHVsZS5wYXJhbWV0ZXJUeXBlLklOVCwNCiAgICAgIHByZXR0eV9uYW1lOiAnUG9zdCB0cmlhbCBnYXAnLA0KICAgICAgZGVmYXVsdDogbnVsbCwNCiAgICAgIGRlc2NyaXB0aW9uOiAnTGVuZ3RoIG9mIGdhcCBiZXR3ZWVuIHRoZSBlbmQgb2YgdGhpcyB0cmlhbCBhbmQgdGhlIHN0YXJ0IG9mIHRoZSBuZXh0IHRyaWFsJw0KICAgIH0NCiAgfQ0KDQogIHJldHVybiBtb2R1bGU7DQp9KSgpOw0KDQpqc1BzeWNoLmRhdGEgPSAoZnVuY3Rpb24oKSB7DQoNCiAgdmFyIG1vZHVsZSA9IHt9Ow0KDQogIC8vIGRhdGEgc3RvcmFnZSBvYmplY3QNCiAgdmFyIGFsbERhdGEgPSBEYXRhQ29sbGVjdGlvbigpOw0KDQogIC8vIGJyb3dzZXIgaW50ZXJhY3Rpb24gZXZlbnQgZGF0YQ0KICB2YXIgaW50ZXJhY3Rpb25EYXRhID0gRGF0YUNvbGxlY3Rpb24oKTsNCg0KICAvLyBkYXRhIHByb3BlcnRpZXMgZm9yIGFsbCB0cmlhbHMNCiAgdmFyIGRhdGFQcm9wZXJ0aWVzID0ge307DQoNCiAgLy8gY2FjaGUgdGhlIHF1ZXJ5X3N0cmluZw0KICB2YXIgcXVlcnlfc3RyaW5nOw0KDQogIC8vIERhdGFDb2xsZWN0aW9uDQogIGZ1bmN0aW9uIERhdGFDb2xsZWN0aW9uKGRhdGEpew0KDQogICAgdmFyIGRhdGFfY29sbGVjdGlvbiA9IHt9Ow0KDQogICAgdmFyIHRyaWFscyA9IHR5cGVvZiBkYXRhID09PSAndW5kZWZpbmVkJyA/IFtdIDogZGF0YTsNCg0KICAgIGRhdGFfY29sbGVjdGlvbi5wdXNoID0gZnVuY3Rpb24obmV3X2RhdGEpew0KICAgICAgdHJpYWxzLnB1c2gobmV3X2RhdGEpOw0KICAgICAgcmV0dXJuIGRhdGFfY29sbGVjdGlvbjsNCiAgICB9DQoNCiAgICBkYXRhX2NvbGxlY3Rpb24uam9pbiA9IGZ1bmN0aW9uKG90aGVyX2RhdGFfY29sbGVjdGlvbil7DQogICAgICB0cmlhbHMgPSB0cmlhbHMuY29uY2F0KG90aGVyX2RhdGFfY29sbGVjdGlvbi52YWx1ZXMoKSk7DQogICAgICByZXR1cm4gZGF0YV9jb2xsZWN0aW9uOw0KICAgIH0NCg0KICAgIGRhdGFfY29sbGVjdGlvbi50b3AgPSBmdW5jdGlvbigpew0KICAgICAgaWYodHJpYWxzLmxlbmd0aCA8PSAxKXsNCiAgICAgICAgcmV0dXJuIGRhdGFfY29sbGVjdGlvbjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiBEYXRhQ29sbGVjdGlvbihbdHJpYWxzW3RyaWFscy5sZW5ndGgtMV1dKTsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBkYXRhX2NvbGxlY3Rpb24uZmlyc3QgPSBmdW5jdGlvbihuKXsNCiAgICAgIGlmKHR5cGVvZiBuPT0ndW5kZWZpbmVkJyl7IG4gPSAxIH0NCiAgICAgIHZhciBvdXQgPSBbXTsNCiAgICAgIGZvcih2YXIgaT0wOyBpPG47IGkrKyl7DQogICAgICAgIG91dC5wdXNoKHRyaWFsc1tpXSk7DQogICAgICB9DQogICAgICByZXR1cm4gRGF0YUNvbGxlY3Rpb24ob3V0KTsNCiAgICB9DQoNCiAgICBkYXRhX2NvbGxlY3Rpb24ubGFzdCA9IGZ1bmN0aW9uKG4pew0KICAgICAgaWYodHlwZW9mIG49PSd1bmRlZmluZWQnKXsgbiA9IDEgfQ0KICAgICAgdmFyIG91dCA9IFtdOw0KICAgICAgZm9yKHZhciBpPXRyaWFscy5sZW5ndGgtbjsgaTx0cmlhbHMubGVuZ3RoOyBpKyspew0KICAgICAgICBvdXQucHVzaCh0cmlhbHNbaV0pOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIERhdGFDb2xsZWN0aW9uKG91dCk7DQogICAgfQ0KDQogICAgZGF0YV9jb2xsZWN0aW9uLnZhbHVlcyA9IGZ1bmN0aW9uKCl7DQogICAgICByZXR1cm4gdHJpYWxzOw0KICAgIH0NCg0KICAgIGRhdGFfY29sbGVjdGlvbi5jb3VudCA9IGZ1bmN0aW9uKCl7DQogICAgICByZXR1cm4gdHJpYWxzLmxlbmd0aDsNCiAgICB9DQoNCiAgICBkYXRhX2NvbGxlY3Rpb24ucmVhZE9ubHkgPSBmdW5jdGlvbigpew0KICAgICAgcmV0dXJuIERhdGFDb2xsZWN0aW9uKGpzUHN5Y2gudXRpbHMuZGVlcENvcHkodHJpYWxzKSk7DQogICAgfQ0KDQogICAgZGF0YV9jb2xsZWN0aW9uLmFkZFRvQWxsID0gZnVuY3Rpb24ocHJvcGVydGllcyl7DQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRyaWFscy5sZW5ndGg7IGkrKykgew0KICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcGVydGllcykgew0KICAgICAgICAgIHRyaWFsc1tpXVtrZXldID0gcHJvcGVydGllc1trZXldOw0KICAgICAgICB9DQogICAgICB9DQogICAgICByZXR1cm4gZGF0YV9jb2xsZWN0aW9uOw0KICAgIH0NCg0KICAgIGRhdGFfY29sbGVjdGlvbi5hZGRUb0xhc3QgPSBmdW5jdGlvbihwcm9wZXJ0aWVzKXsNCiAgICAgIGlmKHRyaWFscy5sZW5ndGggIT0gMCl7DQogICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wZXJ0aWVzKSB7DQogICAgICAgICAgdHJpYWxzW3RyaWFscy5sZW5ndGgtMV1ba2V5XSA9IHByb3BlcnRpZXNba2V5XTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcmV0dXJuIGRhdGFfY29sbGVjdGlvbjsNCiAgICB9DQoNCiAgICBkYXRhX2NvbGxlY3Rpb24uZmlsdGVyID0gZnVuY3Rpb24oZmlsdGVycyl7DQogICAgICAvLyBbe3AxOiB2MSwgcDI6djJ9LCB7cDE6djJ9XQ0KICAgICAgLy8ge3AxOiB2MX0NCiAgICAgIGlmKCFBcnJheS5pc0FycmF5KGZpbHRlcnMpKXsNCiAgICAgICAgdmFyIGYgPSBqc1BzeWNoLnV0aWxzLmRlZXBDb3B5KFtmaWx0ZXJzXSk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB2YXIgZiA9IGpzUHN5Y2gudXRpbHMuZGVlcENvcHkoZmlsdGVycyk7DQogICAgICB9DQoNCiAgICAgIHZhciBmaWx0ZXJlZF9kYXRhID0gW107DQogICAgICBmb3IodmFyIHg9MDsgeCA8IHRyaWFscy5sZW5ndGg7IHgrKyl7DQogICAgICAgIHZhciBrZWVwID0gZmFsc2U7DQogICAgICAgIGZvcih2YXIgaT0wOyBpPGYubGVuZ3RoOyBpKyspew0KICAgICAgICAgIHZhciBtYXRjaCA9IHRydWU7DQogICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhmW2ldKTsNCiAgICAgICAgICBmb3IodmFyIGs9MDsgazxrZXlzLmxlbmd0aDsgaysrKXsNCiAgICAgICAgICAgIGlmKHR5cGVvZiB0cmlhbHNbeF1ba2V5c1trXV0gIT09ICd1bmRlZmluZWQnICYmIHRyaWFsc1t4XVtrZXlzW2tdXSA9PSBmW2ldW2tleXNba11dKXsNCiAgICAgICAgICAgICAgLy8gbWF0Y2hlcyBvbiB0aGlzIGtleSENCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIG1hdGNoID0gZmFsc2U7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmKG1hdGNoKSB7IGtlZXAgPSB0cnVlOyBicmVhazsgfSAvLyBjYW4gYnJlYWsgYmVjYXVzZSBlYWNoIGZpbHRlciBpcyBPUi4NCiAgICAgICAgfQ0KICAgICAgICBpZihrZWVwKXsNCiAgICAgICAgICBmaWx0ZXJlZF9kYXRhLnB1c2godHJpYWxzW3hdKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgICB2YXIgb3V0ID0gRGF0YUNvbGxlY3Rpb24oZmlsdGVyZWRfZGF0YSk7DQoNCiAgICAgIHJldHVybiBvdXQ7DQogICAgfQ0KDQogICAgZGF0YV9jb2xsZWN0aW9uLmZpbHRlckN1c3RvbSA9IGZ1bmN0aW9uKGZuKXsNCiAgICAgIHZhciBpbmNsdWRlZCA9IFtdOw0KICAgICAgZm9yKHZhciBpPTA7IGk8dHJpYWxzLmxlbmd0aDsgaSsrKXsNCiAgICAgICAgaWYoZm4odHJpYWxzW2ldKSl7DQogICAgICAgICAgaW5jbHVkZWQucHVzaCh0cmlhbHNbaV0pOw0KICAgICAgICB9DQogICAgICB9DQogICAgICByZXR1cm4gRGF0YUNvbGxlY3Rpb24oaW5jbHVkZWQpOw0KICAgIH0NCg0KICAgIGRhdGFfY29sbGVjdGlvbi5zZWxlY3QgPSBmdW5jdGlvbihjb2x1bW4pew0KICAgICAgdmFyIHZhbHVlcyA9IFtdOw0KICAgICAgZm9yKHZhciBpPTA7IGk8dHJpYWxzLmxlbmd0aDsgaSsrKXsNCiAgICAgICAgaWYodHlwZW9mIHRyaWFsc1tpXVtjb2x1bW5dICE9PSAndW5kZWZpbmVkJyl7DQogICAgICAgICAgdmFsdWVzLnB1c2godHJpYWxzW2ldW2NvbHVtbl0pOw0KICAgICAgICB9DQogICAgICB9DQogICAgICB2YXIgb3V0ID0gRGF0YUNvbHVtbigpOw0KICAgICAgb3V0LnZhbHVlcyA9IHZhbHVlczsNCiAgICAgIHJldHVybiBvdXQ7DQogICAgfQ0KDQogICAgZGF0YV9jb2xsZWN0aW9uLmlnbm9yZSA9IGZ1bmN0aW9uKGNvbHVtbnMpew0KICAgICAgaWYoIUFycmF5LmlzQXJyYXkoY29sdW1ucykpew0KICAgICAgICBjb2x1bW5zID0gW2NvbHVtbnNdOw0KICAgICAgfQ0KICAgICAgdmFyIG8gPSBqc1BzeWNoLnV0aWxzLmRlZXBDb3B5KHRyaWFscyk7DQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG8ubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgZm9yICh2YXIgaiBpbiBjb2x1bW5zKSB7DQogICAgICAgICAgZGVsZXRlIG9baV1bY29sdW1uc1tqXV07DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHJldHVybiBEYXRhQ29sbGVjdGlvbihvKTsNCiAgICB9DQoNCiAgICBkYXRhX2NvbGxlY3Rpb24udW5pcXVlTmFtZXMgPSBmdW5jdGlvbigpew0KICAgICAgdmFyIG5hbWVzID0gW107DQoNCiAgICAgIGZvcih2YXIgaT0wOyBpPHRyaWFscy5sZW5ndGg7IGkrKyl7DQogICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModHJpYWxzW2ldKTsNCiAgICAgICAgZm9yKHZhciBqPTA7IGo8a2V5cy5sZW5ndGg7IGorKyl7DQogICAgICAgICAgaWYoIW5hbWVzLmluY2x1ZGVzKGtleXNbal0pKXsNCiAgICAgICAgICAgIG5hbWVzLnB1c2goa2V5c1tqXSk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIHJldHVybiBuYW1lczsNCiAgICB9DQoNCiAgICBkYXRhX2NvbGxlY3Rpb24uY3N2ID0gZnVuY3Rpb24oKXsNCiAgICAgIHJldHVybiBKU09OMkNTVih0cmlhbHMpOw0KICAgIH0NCg0KICAgIGRhdGFfY29sbGVjdGlvbi5qc29uID0gZnVuY3Rpb24ocHJldHR5KXsNCiAgICAgIGlmKHByZXR0eSl7DQogICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh0cmlhbHMsIG51bGwsICdcdCcpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRyaWFscyk7DQogICAgfQ0KDQogICAgZGF0YV9jb2xsZWN0aW9uLmxvY2FsU2F2ZSA9IGZ1bmN0aW9uKGZvcm1hdCwgZmlsZW5hbWUpew0KICAgICAgdmFyIGRhdGFfc3RyaW5nOw0KDQogICAgICBpZiAoZm9ybWF0ID09ICdKU09OJyB8fCBmb3JtYXQgPT0gJ2pzb24nKSB7DQogICAgICAgIGRhdGFfc3RyaW5nID0gZGF0YV9jb2xsZWN0aW9uLmpzb24oKTsNCiAgICAgIH0gZWxzZSBpZiAoZm9ybWF0ID09ICdDU1YnIHx8IGZvcm1hdCA9PSAnY3N2Jykgew0KICAgICAgICBkYXRhX3N0cmluZyA9IGRhdGFfY29sbGVjdGlvbi5jc3YoKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBmb3JtYXQgc3BlY2lmaWVkIGZvciBsb2NhbFNhdmUuIE11c3QgYmUgIkpTT04iIG9yICJDU1YiLicpOw0KICAgICAgfQ0KDQogICAgICBzYXZlVGV4dFRvRmlsZShkYXRhX3N0cmluZywgZmlsZW5hbWUpOw0KICAgIH0NCg0KICAgIHJldHVybiBkYXRhX2NvbGxlY3Rpb247DQogIH0NCg0KICAvLyBEYXRhQ29sdW1uIGNsYXNzDQogIGZ1bmN0aW9uIERhdGFDb2x1bW4oKXsNCiAgICB2YXIgZGF0YV9jb2x1bW4gPSB7fTsNCg0KICAgIGRhdGFfY29sdW1uLnZhbHVlcyA9IFtdOw0KDQogICAgZGF0YV9jb2x1bW4uc3VtID0gZnVuY3Rpb24oKXsNCiAgICAgIHZhciBzID0gMDsNCiAgICAgIGZvcih2YXIgaT0wOyBpPGRhdGFfY29sdW1uLnZhbHVlcy5sZW5ndGg7IGkrKyl7DQogICAgICAgIHMgKz0gZGF0YV9jb2x1bW4udmFsdWVzW2ldOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIHM7DQogICAgfQ0KDQogICAgZGF0YV9jb2x1bW4ubWVhbiA9IGZ1bmN0aW9uKCl7DQogICAgICByZXR1cm4gZGF0YV9jb2x1bW4uc3VtKCkgLyBkYXRhX2NvbHVtbi5jb3VudCgpOw0KICAgIH0NCg0KICAgIGRhdGFfY29sdW1uLm1lZGlhbiA9IGZ1bmN0aW9uKCl7DQogICAgICBpZiAoZGF0YV9jb2x1bW4udmFsdWVzLmxlbmd0aCA9PSAwKSB7cmV0dXJuIHVuZGVmaW5lZH07DQogICAgICB2YXIgbnVtYmVycyA9IGRhdGFfY29sdW1uLnZhbHVlcy5zbGljZSgwKS5zb3J0KGZ1bmN0aW9uKGEsYil7IHJldHVybiBhIC0gYjsgfSk7DQogICAgICB2YXIgbWlkZGxlID0gTWF0aC5mbG9vcihudW1iZXJzLmxlbmd0aCAvIDIpOw0KICAgICAgdmFyIGlzRXZlbiA9IG51bWJlcnMubGVuZ3RoICUgMiA9PT0gMDsNCiAgICAgIHJldHVybiBpc0V2ZW4gPyAobnVtYmVyc1ttaWRkbGVdICsgbnVtYmVyc1ttaWRkbGUgLSAxXSkgLyAyIDogbnVtYmVyc1ttaWRkbGVdOw0KICAgIH0NCg0KICAgIGRhdGFfY29sdW1uLm1pbiA9IGZ1bmN0aW9uKCl7DQogICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkobnVsbCwgZGF0YV9jb2x1bW4udmFsdWVzKTsNCiAgICB9DQoNCiAgICBkYXRhX2NvbHVtbi5tYXggPSBmdW5jdGlvbigpew0KICAgICAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KG51bGwsIGRhdGFfY29sdW1uLnZhbHVlcyk7DQogICAgfQ0KDQogICAgZGF0YV9jb2x1bW4uY291bnQgPSBmdW5jdGlvbigpew0KICAgICAgcmV0dXJuIGRhdGFfY29sdW1uLnZhbHVlcy5sZW5ndGg7DQogICAgfQ0KDQogICAgZGF0YV9jb2x1bW4udmFyaWFuY2UgPSBmdW5jdGlvbigpew0KICAgICAgdmFyIG1lYW4gPSBkYXRhX2NvbHVtbi5tZWFuKCk7DQogICAgICB2YXIgc3VtX3NxdWFyZV9lcnJvciA9IDA7DQogICAgICBmb3IodmFyIGk9MDsgaTxkYXRhX2NvbHVtbi52YWx1ZXMubGVuZ3RoOyBpKyspew0KICAgICAgICBzdW1fc3F1YXJlX2Vycm9yICs9IE1hdGgucG93KGRhdGFfY29sdW1uLnZhbHVlc1tpXSAtIG1lYW4sMik7DQogICAgICB9DQogICAgICB2YXIgbXNlID0gc3VtX3NxdWFyZV9lcnJvciAvIChkYXRhX2NvbHVtbi52YWx1ZXMubGVuZ3RoIC0gMSk7DQogICAgICByZXR1cm4gbXNlOw0KICAgIH0NCg0KICAgIGRhdGFfY29sdW1uLnNkID0gZnVuY3Rpb24oKXsNCiAgICAgIHZhciBtc2UgPSBkYXRhX2NvbHVtbi52YXJpYW5jZSgpOw0KICAgICAgdmFyIHJtc2UgPSBNYXRoLnNxcnQobXNlKTsNCiAgICAgIHJldHVybiBybXNlOw0KICAgIH0NCg0KICAgIGRhdGFfY29sdW1uLmZyZXF1ZW5jaWVzID0gZnVuY3Rpb24oKXsNCiAgICAgIHZhciB1bmlxdWUgPSB7fQ0KICAgICAgZm9yKHZhciBpPTA7IGk8ZGF0YV9jb2x1bW4udmFsdWVzLmxlbmd0aDsgaSsrKXsNCiAgICAgICAgdmFyIHYgPSBkYXRhX2NvbHVtbi52YWx1ZXNbaV07DQogICAgICAgIGlmKHR5cGVvZiB1bmlxdWVbdl0gPT0gJ3VuZGVmaW5lZCcpew0KICAgICAgICAgIHVuaXF1ZVt2XSA9IDE7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgdW5pcXVlW3ZdKys7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHJldHVybiB1bmlxdWU7DQogICAgfQ0KDQogICAgZGF0YV9jb2x1bW4uYWxsID0gZnVuY3Rpb24oZXZhbF9mbil7DQogICAgICBmb3IodmFyIGk9MDsgaTxkYXRhX2NvbHVtbi52YWx1ZXMubGVuZ3RoOyBpKyspew0KICAgICAgICBpZighZXZhbF9mbihkYXRhX2NvbHVtbi52YWx1ZXNbaV0pKXsNCiAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCg0KICAgIGRhdGFfY29sdW1uLnN1YnNldCA9IGZ1bmN0aW9uKGV2YWxfZm4pew0KICAgICAgdmFyIG91dCA9IFtdOw0KICAgICAgZm9yKHZhciBpPTA7IGk8ZGF0YV9jb2x1bW4udmFsdWVzLmxlbmd0aDsgaSsrKXsNCiAgICAgICAgaWYoZXZhbF9mbihkYXRhX2NvbHVtbi52YWx1ZXNbaV0pKXsNCiAgICAgICAgICBvdXQucHVzaChkYXRhX2NvbHVtbi52YWx1ZXNbaV0pOw0KICAgICAgICB9DQogICAgICB9DQogICAgICB2YXIgbyA9IERhdGFDb2x1bW4oKTsNCiAgICAgIG8udmFsdWVzID0gb3V0Ow0KICAgICAgcmV0dXJuIG87DQogICAgfQ0KDQogICAgcmV0dXJuIGRhdGFfY29sdW1uOw0KICB9DQoNCiAgbW9kdWxlLnJlc2V0ID0gZnVuY3Rpb24oKXsNCiAgICBhbGxEYXRhID0gRGF0YUNvbGxlY3Rpb24oKTsNCiAgICBpbnRlcmFjdGlvbkRhdGEgPSBEYXRhQ29sbGVjdGlvbigpOw0KICB9DQoNCiAgbW9kdWxlLmdldCA9IGZ1bmN0aW9uKCkgew0KICAgIHJldHVybiBhbGxEYXRhOw0KICB9Ow0KDQogIG1vZHVsZS5nZXRJbnRlcmFjdGlvbkRhdGEgPSBmdW5jdGlvbigpIHsNCiAgICByZXR1cm4gaW50ZXJhY3Rpb25EYXRhOw0KICB9DQoNCiAgbW9kdWxlLndyaXRlID0gZnVuY3Rpb24oZGF0YV9vYmplY3QpIHsNCg0KICAgIHZhciBwcm9ncmVzcyA9IGpzUHN5Y2gucHJvZ3Jlc3MoKTsNCiAgICB2YXIgdHJpYWwgPSBqc1BzeWNoLmN1cnJlbnRUcmlhbCgpOw0KDQogICAgLy92YXIgdHJpYWxfb3B0X2RhdGEgPSB0eXBlb2YgdHJpYWwuZGF0YSA9PSAnZnVuY3Rpb24nID8gdHJpYWwuZGF0YSgpIDogdHJpYWwuZGF0YTsNCg0KICAgIHZhciBkZWZhdWx0X2RhdGEgPSB7DQogICAgICAndHJpYWxfdHlwZSc6IHRyaWFsLnR5cGUsDQogICAgICAndHJpYWxfaW5kZXgnOiBwcm9ncmVzcy5jdXJyZW50X3RyaWFsX2dsb2JhbCwNCiAgICAgICd0aW1lX2VsYXBzZWQnOiBqc1BzeWNoLnRvdGFsVGltZSgpLA0KICAgICAgJ2ludGVybmFsX25vZGVfaWQnOiBqc1BzeWNoLmN1cnJlbnRUaW1lbGluZU5vZGVJRCgpDQogICAgfTsNCg0KICAgIHZhciBleHRfZGF0YV9vYmplY3QgPSBPYmplY3QuYXNzaWduKHt9LCBkYXRhX29iamVjdCwgdHJpYWwuZGF0YSwgZGVmYXVsdF9kYXRhLCBkYXRhUHJvcGVydGllcyk7DQoNCiAgICBhbGxEYXRhLnB1c2goZXh0X2RhdGFfb2JqZWN0KTsNCiAgfTsNCg0KICBtb2R1bGUuYWRkUHJvcGVydGllcyA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpIHsNCg0KICAgIC8vIGZpcnN0LCBhZGQgdGhlIHByb3BlcnRpZXMgdG8gYWxsIGRhdGEgdGhhdCdzIGFscmVhZHkgc3RvcmVkDQogICAgYWxsRGF0YS5hZGRUb0FsbChwcm9wZXJ0aWVzKTsNCg0KICAgIC8vIG5vdyBhZGQgdG8gbGlzdCBzbyB0aGF0IGl0IGdldHMgYXBwZW5kZWQgdG8gYWxsIGZ1dHVyZSBkYXRhDQogICAgZGF0YVByb3BlcnRpZXMgPSBPYmplY3QuYXNzaWduKHt9LCBkYXRhUHJvcGVydGllcywgcHJvcGVydGllcyk7DQoNCiAgfTsNCg0KICBtb2R1bGUuYWRkRGF0YVRvTGFzdFRyaWFsID0gZnVuY3Rpb24oZGF0YSkgew0KICAgIGFsbERhdGEuYWRkVG9MYXN0KGRhdGEpOw0KICB9DQoNCiAgbW9kdWxlLmdldERhdGFCeVRpbWVsaW5lTm9kZSA9IGZ1bmN0aW9uKG5vZGVfaWQpIHsNCiAgICB2YXIgZGF0YSA9IGFsbERhdGEuZmlsdGVyQ3VzdG9tKGZ1bmN0aW9uKHgpew0KICAgICAgcmV0dXJuIHguaW50ZXJuYWxfbm9kZV9pZC5zbGljZSgwLCBub2RlX2lkLmxlbmd0aCkgPT09IG5vZGVfaWQ7DQogICAgfSk7DQoNCiAgICByZXR1cm4gZGF0YTsNCiAgfTsNCg0KICBtb2R1bGUuZ2V0TGFzdFRyaWFsRGF0YSA9IGZ1bmN0aW9uKCkgew0KICAgIHJldHVybiBhbGxEYXRhLnRvcCgpOw0KICB9Ow0KDQogIG1vZHVsZS5nZXRMYXN0VGltZWxpbmVEYXRhID0gZnVuY3Rpb24oKSB7DQogICAgdmFyIGxhc3R0cmlhbCA9IG1vZHVsZS5nZXRMYXN0VHJpYWxEYXRhKCk7DQogICAgdmFyIG5vZGVfaWQgPSBsYXN0dHJpYWwuc2VsZWN0KCdpbnRlcm5hbF9ub2RlX2lkJykudmFsdWVzWzBdOw0KICAgIGlmICh0eXBlb2Ygbm9kZV9pZCA9PT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgIHJldHVybiBEYXRhQ29sbGVjdGlvbigpOw0KICAgIH0gZWxzZSB7DQogICAgICB2YXIgcGFyZW50X25vZGVfaWQgPSBub2RlX2lkLnN1YnN0cigwLG5vZGVfaWQubGFzdEluZGV4T2YoJy0nKSk7DQogICAgICB2YXIgbGFzdG5vZGVkYXRhID0gbW9kdWxlLmdldERhdGFCeVRpbWVsaW5lTm9kZShwYXJlbnRfbm9kZV9pZCk7DQogICAgICByZXR1cm4gbGFzdG5vZGVkYXRhOw0KICAgIH0NCiAgfQ0KDQogIG1vZHVsZS5kaXNwbGF5RGF0YSA9IGZ1bmN0aW9uKGZvcm1hdCkgew0KICAgIGZvcm1hdCA9ICh0eXBlb2YgZm9ybWF0ID09PSAndW5kZWZpbmVkJykgPyAianNvbiIgOiBmb3JtYXQudG9Mb3dlckNhc2UoKTsNCiAgICBpZiAoZm9ybWF0ICE9ICJqc29uIiAmJiBmb3JtYXQgIT0gImNzdiIpIHsNCiAgICAgIGNvbnNvbGUubG9nKCdJbnZhbGlkIGZvcm1hdCBkZWNsYXJlZCBmb3IgZGlzcGxheURhdGEgZnVuY3Rpb24uIFVzaW5nIGpzb24gYXMgZGVmYXVsdC4nKTsNCiAgICAgIGZvcm1hdCA9ICJqc29uIjsNCiAgICB9DQoNCiAgICB2YXIgZGF0YV9zdHJpbmc7DQoNCiAgICBpZiAoZm9ybWF0ID09ICdqc29uJykgew0KICAgICAgZGF0YV9zdHJpbmcgPSBhbGxEYXRhLmpzb24odHJ1ZSk7IC8vIHRydWUgPSBwcmV0dHkgcHJpbnQgd2l0aCB0YWJzDQogICAgfSBlbHNlIHsNCiAgICAgIGRhdGFfc3RyaW5nID0gYWxsRGF0YS5jc3YoKTsNCiAgICB9DQoNCiAgICB2YXIgZGlzcGxheV9lbGVtZW50ID0ganNQc3ljaC5nZXREaXNwbGF5RWxlbWVudCgpOw0KDQogICAgZGlzcGxheV9lbGVtZW50LmlubmVySFRNTCA9ICc8cHJlIGlkPSJqc3BzeWNoLWRhdGEtZGlzcGxheSI+PC9wcmU+JzsNCg0KICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqc3BzeWNoLWRhdGEtZGlzcGxheScpLnRleHRDb250ZW50ID0gZGF0YV9zdHJpbmc7DQogIH07DQoNCiAgbW9kdWxlLnVybFZhcmlhYmxlcyA9IGZ1bmN0aW9uKCkgew0KICAgIGlmKHR5cGVvZiBxdWVyeV9zdHJpbmcgPT0gJ3VuZGVmaW5lZCcpew0KICAgICAgcXVlcnlfc3RyaW5nID0gZ2V0UXVlcnlTdHJpbmcoKTsNCiAgICB9DQogICAgcmV0dXJuIHF1ZXJ5X3N0cmluZzsNCiAgfQ0KDQogIG1vZHVsZS5nZXRVUkxWYXJpYWJsZSA9IGZ1bmN0aW9uKHdoaWNodmFyKXsNCiAgICBpZih0eXBlb2YgcXVlcnlfc3RyaW5nID09ICd1bmRlZmluZWQnKXsNCiAgICAgIHF1ZXJ5X3N0cmluZyA9IGdldFF1ZXJ5U3RyaW5nKCk7DQogICAgfQ0KICAgIHJldHVybiBxdWVyeV9zdHJpbmdbd2hpY2h2YXJdOw0KICB9DQoNCiAgbW9kdWxlLmNyZWF0ZUludGVyYWN0aW9uTGlzdGVuZXJzID0gZnVuY3Rpb24oKXsNCiAgICAvLyBibHVyIGV2ZW50IGNhcHR1cmUNCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignYmx1cicsIGZ1bmN0aW9uKCl7DQogICAgICB2YXIgZGF0YSA9IHsNCiAgICAgICAgZXZlbnQ6ICdibHVyJywNCiAgICAgICAgdHJpYWw6IGpzUHN5Y2gucHJvZ3Jlc3MoKS5jdXJyZW50X3RyaWFsX2dsb2JhbCwNCiAgICAgICAgdGltZToganNQc3ljaC50b3RhbFRpbWUoKQ0KICAgICAgfTsNCiAgICAgIGludGVyYWN0aW9uRGF0YS5wdXNoKGRhdGEpOw0KICAgICAganNQc3ljaC5pbml0U2V0dGluZ3MoKS5vbl9pbnRlcmFjdGlvbl9kYXRhX3VwZGF0ZShkYXRhKTsNCiAgICB9KTsNCg0KICAgIC8vIGZvY3VzIGV2ZW50IGNhcHR1cmUNCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXMnLCBmdW5jdGlvbigpew0KICAgICAgdmFyIGRhdGEgPSB7DQogICAgICAgIGV2ZW50OiAnZm9jdXMnLA0KICAgICAgICB0cmlhbDoganNQc3ljaC5wcm9ncmVzcygpLmN1cnJlbnRfdHJpYWxfZ2xvYmFsLA0KICAgICAgICB0aW1lOiBqc1BzeWNoLnRvdGFsVGltZSgpDQogICAgICB9Ow0KICAgICAgaW50ZXJhY3Rpb25EYXRhLnB1c2goZGF0YSk7DQogICAgICBqc1BzeWNoLmluaXRTZXR0aW5ncygpLm9uX2ludGVyYWN0aW9uX2RhdGFfdXBkYXRlKGRhdGEpOw0KICAgIH0pOw0KDQogICAgLy8gZnVsbHNjcmVlbiBjaGFuZ2UgY2FwdHVyZQ0KICAgIGZ1bmN0aW9uIGZ1bGxzY3JlZW5jaGFuZ2UoKXsNCiAgICAgIHZhciB0eXBlID0gKGRvY3VtZW50LmlzRnVsbFNjcmVlbiB8fCBkb2N1bWVudC53ZWJraXRJc0Z1bGxTY3JlZW4gfHwgZG9jdW1lbnQubW96SXNGdWxsU2NyZWVuIHx8IGRvY3VtZW50LmZ1bGxzY3JlZW5FbGVtZW50KSA/ICdmdWxsc2NyZWVuZW50ZXInIDogJ2Z1bGxzY3JlZW5leGl0JzsNCiAgICAgIHZhciBkYXRhID0gew0KICAgICAgICBldmVudDogdHlwZSwNCiAgICAgICAgdHJpYWw6IGpzUHN5Y2gucHJvZ3Jlc3MoKS5jdXJyZW50X3RyaWFsX2dsb2JhbCwNCiAgICAgICAgdGltZToganNQc3ljaC50b3RhbFRpbWUoKQ0KICAgICAgfTsNCiAgICAgIGludGVyYWN0aW9uRGF0YS5wdXNoKGRhdGEpOw0KICAgICAganNQc3ljaC5pbml0U2V0dGluZ3MoKS5vbl9pbnRlcmFjdGlvbl9kYXRhX3VwZGF0ZShkYXRhKTsNCiAgICB9DQoNCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdmdWxsc2NyZWVuY2hhbmdlJywgZnVsbHNjcmVlbmNoYW5nZSk7DQogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW96ZnVsbHNjcmVlbmNoYW5nZScsIGZ1bGxzY3JlZW5jaGFuZ2UpOw0KICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdGZ1bGxzY3JlZW5jaGFuZ2UnLCBmdWxsc2NyZWVuY2hhbmdlKTsNCiAgfQ0KDQogIC8vIHB1YmxpYyBtZXRob2RzIGZvciB0ZXN0aW5nIHB1cnBvc2VzLiBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4NCiAgbW9kdWxlLl9jdXN0b21JbnNlcnQgPSBmdW5jdGlvbihkYXRhKXsNCiAgICBhbGxEYXRhID0gRGF0YUNvbGxlY3Rpb24oZGF0YSk7DQogIH0NCg0KICBtb2R1bGUuX2Z1bGxyZXNldCA9IGZ1bmN0aW9uKCl7DQogICAgbW9kdWxlLnJlc2V0KCk7DQogICAgZGF0YVByb3BlcnRpZXMgPSB7fTsNCiAgfQ0KDQogIC8vIHByaXZhdGUgZnVuY3Rpb24gdG8gc2F2ZSB0ZXh0IGZpbGUgb24gbG9jYWwgZHJpdmUNCiAgZnVuY3Rpb24gc2F2ZVRleHRUb0ZpbGUodGV4dHN0ciwgZmlsZW5hbWUpIHsNCiAgICB2YXIgYmxvYlRvU2F2ZSA9IG5ldyBCbG9iKFt0ZXh0c3RyXSwgew0KICAgICAgdHlwZTogJ3RleHQvcGxhaW4nDQogICAgfSk7DQogICAgdmFyIGJsb2JVUkwgPSAiIjsNCiAgICBpZiAodHlwZW9mIHdpbmRvdy53ZWJraXRVUkwgIT09ICd1bmRlZmluZWQnKSB7DQogICAgICBibG9iVVJMID0gd2luZG93LndlYmtpdFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYlRvU2F2ZSk7DQogICAgfSBlbHNlIHsNCiAgICAgIGJsb2JVUkwgPSB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iVG9TYXZlKTsNCiAgICB9DQoNCiAgICB2YXIgZGlzcGxheV9lbGVtZW50ID0ganNQc3ljaC5nZXREaXNwbGF5RWxlbWVudCgpOw0KDQogICAgZGlzcGxheV9lbGVtZW50Lmluc2VydEFkamFjZW50SFRNTCgnYmVmb3JlZW5kJywnPGEgaWQ9ImpzcHN5Y2gtZG93bmxvYWQtYXMtdGV4dC1saW5rIiBzdHlsZT0iZGlzcGxheTpub25lOyIgZG93bmxvYWQ9IicrZmlsZW5hbWUrJyIgaHJlZj0iJytibG9iVVJMKyciPmNsaWNrIHRvIGRvd25sb2FkPC9hPicpOw0KICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqc3BzeWNoLWRvd25sb2FkLWFzLXRleHQtbGluaycpLmNsaWNrKCk7DQogIH0NCg0KICAvLw0KICAvLyBBIGZldyBoZWxwZXIgZnVuY3Rpb25zIHRvIGhhbmRsZSBkYXRhIGZvcm1hdCBjb252ZXJzaW9uDQogIC8vDQoNCiAgLy8gdGhpcyBmdW5jdGlvbiBiYXNlZCBvbiBjb2RlIHN1Z2dlc3RlZCBieSBTdGFja092ZXJmbG93IHVzZXJzOg0KICAvLyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vdXNlcnMvNjQ3NDEvemFjaGFyeQ0KICAvLyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vdXNlcnMvMzE3L2pvc2VwaC1zdHVydGV2YW50DQoNCiAgZnVuY3Rpb24gSlNPTjJDU1Yob2JqQXJyYXkpIHsNCiAgICB2YXIgYXJyYXkgPSB0eXBlb2Ygb2JqQXJyYXkgIT0gJ29iamVjdCcgPyBKU09OLnBhcnNlKG9iakFycmF5KSA6IG9iakFycmF5Ow0KICAgIHZhciBsaW5lID0gJyc7DQogICAgdmFyIHJlc3VsdCA9ICcnOw0KICAgIHZhciBjb2x1bW5zID0gW107DQoNCiAgICB2YXIgaSA9IDA7DQogICAgZm9yICh2YXIgaiA9IDA7IGogPCBhcnJheS5sZW5ndGg7IGorKykgew0KICAgICAgZm9yICh2YXIga2V5IGluIGFycmF5W2pdKSB7DQogICAgICAgIHZhciBrZXlTdHJpbmcgPSBrZXkgKyAiIjsNCiAgICAgICAga2V5U3RyaW5nID0gJyInICsga2V5U3RyaW5nLnJlcGxhY2UoLyIvZywgJyIiJykgKyAnIiwnOw0KICAgICAgICBpZiAoIWNvbHVtbnMuaW5jbHVkZXMoa2V5KSkgew0KICAgICAgICAgIGNvbHVtbnNbaV0gPSBrZXk7DQogICAgICAgICAgbGluZSArPSBrZXlTdHJpbmc7DQogICAgICAgICAgaSsrOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KDQogICAgbGluZSA9IGxpbmUuc2xpY2UoMCwgLTEpOw0KICAgIHJlc3VsdCArPSBsaW5lICsgJ1xyXG4nOw0KDQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgew0KICAgICAgdmFyIGxpbmUgPSAnJzsNCiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY29sdW1ucy5sZW5ndGg7IGorKykgew0KICAgICAgICB2YXIgdmFsdWUgPSAodHlwZW9mIGFycmF5W2ldW2NvbHVtbnNbal1dID09PSAndW5kZWZpbmVkJykgPyAnJyA6IGFycmF5W2ldW2NvbHVtbnNbal1dOw0KICAgICAgICB2YXIgdmFsdWVTdHJpbmcgPSB2YWx1ZSArICIiOw0KICAgICAgICBsaW5lICs9ICciJyArIHZhbHVlU3RyaW5nLnJlcGxhY2UoLyIvZywgJyIiJykgKyAnIiwnOw0KICAgICAgfQ0KDQogICAgICBsaW5lID0gbGluZS5zbGljZSgwLCAtMSk7DQogICAgICByZXN1bHQgKz0gbGluZSArICdcclxuJzsNCiAgICB9DQoNCiAgICByZXR1cm4gcmVzdWx0Ow0KICB9DQoNCiAgLy8gdGhpcyBmdW5jdGlvbiBpcyBtb2RpZmllZCBmcm9tIFN0YWNrT3ZlcmZsb3c6DQogIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9wb3N0cy8zODU1Mzk0DQoNCiAgZnVuY3Rpb24gZ2V0UXVlcnlTdHJpbmcoKSB7DQogICAgdmFyIGEgPSB3aW5kb3cubG9jYXRpb24uc2VhcmNoLnN1YnN0cigxKS5zcGxpdCgnJicpOw0KICAgIGlmIChhID09ICIiKSByZXR1cm4ge307DQogICAgdmFyIGIgPSB7fTsNCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGEubGVuZ3RoOyArK2kpDQogICAgew0KICAgICAgICB2YXIgcD1hW2ldLnNwbGl0KCc9JywgMik7DQogICAgICAgIGlmIChwLmxlbmd0aCA9PSAxKQ0KICAgICAgICAgICAgYltwWzBdXSA9ICIiOw0KICAgICAgICBlbHNlDQogICAgICAgICAgICBiW3BbMF1dID0gZGVjb2RlVVJJQ29tcG9uZW50KHBbMV0ucmVwbGFjZSgvXCsvZywgIiAiKSk7DQogICAgfQ0KICAgIHJldHVybiBiOw0KICB9DQoNCiAgcmV0dXJuIG1vZHVsZTsNCg0KfSkoKTsNCg0KanNQc3ljaC50dXJrID0gKGZ1bmN0aW9uKCkgew0KDQogIHZhciBtb2R1bGUgPSB7fTsNCg0KICAvLyBjb3JlLnR1cmtJbmZvIGdldHMgaW5mb3JtYXRpb24gcmVsZXZhbnQgdG8gbWVjaGFuaWNhbCB0dXJrIGV4cGVyaW1lbnRzLiByZXR1cm5zIGFuIG9iamVjdA0KICAvLyBjb250YWluaW5nIHRoZSB3b3JrZXJJRCwgYXNzaWdubWVudElELCBhbmQgaGl0SUQsIGFuZCB3aGV0aGVyIG9yIG5vdCB0aGUgSElUIGlzIGluDQogIC8vIHByZXZpZXcgbW9kZSwgbWVhbmluZyB0aGF0IHRoZXkgaGF2ZW4ndCBhY2NlcHRlZCB0aGUgSElUIHlldC4NCiAgbW9kdWxlLnR1cmtJbmZvID0gZnVuY3Rpb24oKSB7DQoNCiAgICB2YXIgdHVyayA9IHt9Ow0KDQogICAgdmFyIHBhcmFtID0gZnVuY3Rpb24odXJsLCBuYW1lKSB7DQogICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKC9bXFtdLywgIlxcXFsiKS5yZXBsYWNlKC9bXF1dLywgIlxcXF0iKTsNCiAgICAgIHZhciByZWdleFMgPSAiW1xcPyZdIiArIG5hbWUgKyAiPShbXiYjXSopIjsNCiAgICAgIHZhciByZWdleCA9IG5ldyBSZWdFeHAocmVnZXhTKTsNCiAgICAgIHZhciByZXN1bHRzID0gcmVnZXguZXhlYyh1cmwpOw0KICAgICAgcmV0dXJuIChyZXN1bHRzID09IG51bGwpID8gIiIgOiByZXN1bHRzWzFdOw0KICAgIH07DQoNCiAgICB2YXIgc3JjID0gcGFyYW0od2luZG93LmxvY2F0aW9uLmhyZWYsICJhc3NpZ25tZW50SWQiKSA/IHdpbmRvdy5sb2NhdGlvbi5ocmVmIDogZG9jdW1lbnQucmVmZXJyZXI7DQoNCiAgICB2YXIga2V5cyA9IFsiYXNzaWdubWVudElkIiwgImhpdElkIiwgIndvcmtlcklkIiwgInR1cmtTdWJtaXRUbyJdOw0KICAgIGtleXMubWFwKA0KDQogICAgICBmdW5jdGlvbihrZXkpIHsNCiAgICAgICAgdHVya1trZXldID0gdW5lc2NhcGUocGFyYW0oc3JjLCBrZXkpKTsNCiAgICAgIH0pOw0KDQogICAgdHVyay5wcmV2aWV3TW9kZSA9ICh0dXJrLmFzc2lnbm1lbnRJZCA9PSAiQVNTSUdOTUVOVF9JRF9OT1RfQVZBSUxBQkxFIik7DQoNCiAgICB0dXJrLm91dHNpZGVUdXJrID0gKCF0dXJrLnByZXZpZXdNb2RlICYmIHR1cmsuaGl0SWQgPT09ICIiICYmIHR1cmsuYXNzaWdubWVudElkID09ICIiICYmIHR1cmsud29ya2VySWQgPT0gIiIpDQoNCiAgICB0dXJrX2luZm8gPSB0dXJrOw0KDQogICAgcmV0dXJuIHR1cms7DQoNCiAgfTsNCg0KICAvLyBjb3JlLnN1Ym1pdFRvVHVyayB3aWxsIHN1Ym1pdCBhIE1lY2hhbmljYWxUdXJrIEV4dGVybmFsSElUIHR5cGUNCiAgbW9kdWxlLnN1Ym1pdFRvVHVyayA9IGZ1bmN0aW9uKGRhdGEpIHsNCg0KICAgIHZhciB0dXJrSW5mbyA9IGpzUHN5Y2gudHVyay50dXJrSW5mbygpOw0KICAgIHZhciBhc3NpZ25tZW50SWQgPSB0dXJrSW5mby5hc3NpZ25tZW50SWQ7DQogICAgdmFyIHR1cmtTdWJtaXRUbyA9IHR1cmtJbmZvLnR1cmtTdWJtaXRUbzsNCg0KICAgIGlmICghYXNzaWdubWVudElkIHx8ICF0dXJrU3VibWl0VG8pIHJldHVybjsNCg0KICAgIHZhciBkYXRhU3RyaW5nID0gW107DQoNCiAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgew0KDQogICAgICBpZiAoZGF0YS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7DQogICAgICAgIGRhdGFTdHJpbmcucHVzaChrZXkgKyAiPSIgKyBlc2NhcGUoZGF0YVtrZXldKSk7DQogICAgICB9DQogICAgfQ0KDQogICAgZGF0YVN0cmluZy5wdXNoKCJhc3NpZ25tZW50SWQ9IiArIGFzc2lnbm1lbnRJZCk7DQoNCiAgICB2YXIgdXJsID0gdHVya1N1Ym1pdFRvICsgIi9tdHVyay9leHRlcm5hbFN1Ym1pdD8iICsgZGF0YVN0cmluZy5qb2luKCImIik7DQoNCiAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IHVybDsNCiAgfTsNCg0KICByZXR1cm4gbW9kdWxlOw0KDQp9KSgpOw0KDQpqc1BzeWNoLnJhbmRvbWl6YXRpb24gPSAoZnVuY3Rpb24oKSB7DQoNCiAgdmFyIG1vZHVsZSA9IHt9Ow0KDQogIG1vZHVsZS5yZXBlYXQgPSBmdW5jdGlvbihhcnJheSwgcmVwZXRpdGlvbnMsIHVucGFjaykgew0KDQogICAgdmFyIGFycl9pc0FycmF5ID0gQXJyYXkuaXNBcnJheShhcnJheSk7DQogICAgdmFyIHJlcF9pc0FycmF5ID0gQXJyYXkuaXNBcnJheShyZXBldGl0aW9ucyk7DQoNCiAgICAvLyBpZiBhcnJheSBpcyBub3QgYW4gYXJyYXksIHRoZW4gd2UganVzdCByZXBlYXQgdGhlIGl0ZW0NCiAgICBpZiAoIWFycl9pc0FycmF5KSB7DQogICAgICBpZiAoIXJlcF9pc0FycmF5KSB7DQogICAgICAgIGFycmF5ID0gW2FycmF5XTsNCiAgICAgICAgcmVwZXRpdGlvbnMgPSBbcmVwZXRpdGlvbnNdOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmVwZXRpdGlvbnMgPSBbcmVwZXRpdGlvbnNbMF1dOw0KICAgICAgICBjb25zb2xlLmxvZygnVW5jbGVhciBwYXJhbWV0ZXJzIGdpdmVuIHRvIHJhbmRvbWl6YXRpb24ucmVwZWF0LiBNdWx0aXBsZSBzZXQgc2l6ZXMgc3BlY2lmaWVkLCBidXQgb25seSBvbmUgaXRlbSBleGlzdHMgdG8gc2FtcGxlLiBQcm9jZWVkaW5nIHVzaW5nIHRoZSBmaXJzdCBzZXQgc2l6ZS4nKTsNCiAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgaWYgKCFyZXBfaXNBcnJheSkgew0KICAgICAgICB2YXIgcmVwcyA9IFtdOw0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgcmVwcy5wdXNoKHJlcGV0aXRpb25zKTsNCiAgICAgICAgfQ0KICAgICAgICByZXBldGl0aW9ucyA9IHJlcHM7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBpZiAoYXJyYXkubGVuZ3RoICE9IHJlcGV0aXRpb25zLmxlbmd0aCkgew0KICAgICAgICAgIGNvbnNvbGUud2FybmluZygnVW5jbGVhciBwYXJhbWV0ZXJzIGdpdmVuIHRvIHJhbmRvbWl6YXRpb24ucmVwZWF0LiBJdGVtcyBhbmQgcmVwZXRpdGlvbnMgYXJlIHVuZXF1YWwgbGVuZ3Rocy4gQmVoYXZpb3IgbWF5IG5vdCBiZSBhcyBleHBlY3RlZC4nKTsNCiAgICAgICAgICAvLyB0aHJvdyB3YXJuaW5nIGlmIHJlcGV0aXRpb25zIGlzIHRvbyBzaG9ydCwgdXNlIGZpcnN0IHJlcCBPTkxZLg0KICAgICAgICAgIGlmIChyZXBldGl0aW9ucy5sZW5ndGggPCBhcnJheS5sZW5ndGgpIHsNCiAgICAgICAgICAgIHZhciByZXBzID0gW107DQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgIHJlcHMucHVzaChyZXBldGl0aW9ucyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXBldGl0aW9ucyA9IHJlcHM7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIC8vIHRocm93IHdhcm5pbmcgaWYgdG9vIGxvbmcsIGFuZCB0aGVuIHVzZSB0aGUgZmlyc3QgTg0KICAgICAgICAgICAgcmVwZXRpdGlvbnMgPSByZXBldGlvbnMuc2xpY2UoMCwgYXJyYXkubGVuZ3RoKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQoNCiAgICAvLyBzaG91bGQgYmUgY2xlYXIgYXQgdGhpcyBwb2ludCB0byBhc3N1bWUgdGhhdCBhcnJheSBhbmQgcmVwZXRpdGlvbnMgYXJlIGFycmF5cyB3aXRoID09IGxlbmd0aA0KICAgIHZhciBhbGxzYW1wbGVzID0gW107DQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgew0KICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCByZXBldGl0aW9uc1tpXTsgaisrKSB7DQogICAgICAgIGlmKGFycmF5W2ldID09IG51bGwgfHwgdHlwZW9mIGFycmF5W2ldICE9ICdvYmplY3QnKXsNCiAgICAgICAgICBhbGxzYW1wbGVzLnB1c2goYXJyYXlbaV0pOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGFsbHNhbXBsZXMucHVzaChPYmplY3QuYXNzaWduKHt9LCBhcnJheVtpXSkpOw0KICAgICAgICB9DQoNCiAgICAgIH0NCiAgICB9DQoNCiAgICB2YXIgb3V0ID0gc2h1ZmZsZShhbGxzYW1wbGVzKTsNCg0KICAgIGlmICh1bnBhY2spIHsNCiAgICAgIG91dCA9IHVucGFja0FycmF5KG91dCk7DQogICAgfQ0KDQogICAgcmV0dXJuIG91dDsNCiAgfQ0KDQogIG1vZHVsZS5zaHVmZmxlID0gZnVuY3Rpb24oYXJyKSB7DQogICAgaWYoIUFycmF5LmlzQXJyYXkoYXJyKSl7DQogICAgICBjb25zb2xlLmVycm9yKCdBcmd1bWVudCB0byBqc1BzeWNoLnJhbmRvbWl6YXRpb24uc2h1ZmZsZSgpIG11c3QgYmUgYW4gYXJyYXkuJykNCiAgICB9DQogICAgcmV0dXJuIHNodWZmbGUoYXJyKTsNCiAgfQ0KDQogIG1vZHVsZS5zaHVmZmxlTm9SZXBlYXRzID0gZnVuY3Rpb24oYXJyLCBlcXVhbGl0eVRlc3QpIHsNCiAgICBpZighQXJyYXkuaXNBcnJheShhcnIpKXsNCiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZpcnN0IGFyZ3VtZW50IHRvIGpzUHN5Y2gucmFuZG9taXphdGlvbi5zaHVmZmxlTm9SZXBlYXRzKCkgbXVzdCBiZSBhbiBhcnJheS4nKQ0KICAgIH0NCiAgICBpZih0eXBlb2YgZXF1YWxpdHlUZXN0ICE9PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgZXF1YWxpdHlUZXN0ICE9PSAnZnVuY3Rpb24nKXsNCiAgICAgIGNvbnNvbGUuZXJyb3IoJ1NlY29uZCBhcmd1bWVudCB0byBqc1BzeWNoLnJhbmRvbWl6YXRpb24uc2h1ZmZsZU5vUmVwZWF0cygpIG11c3QgYmUgYSBmdW5jdGlvbi4nKQ0KICAgIH0NCiAgICAvLyBkZWZpbmUgYSBkZWZhdWx0IGVxdWFsaXR5VGVzdA0KICAgIGlmICh0eXBlb2YgZXF1YWxpdHlUZXN0ID09ICd1bmRlZmluZWQnKSB7DQogICAgICBlcXVhbGl0eVRlc3QgPSBmdW5jdGlvbihhLCBiKSB7DQogICAgICAgIGlmIChhID09PSBiKSB7DQogICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KDQogICAgdmFyIHJhbmRvbV9zaHVmZmxlID0gc2h1ZmZsZShhcnIpOw0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmFuZG9tX3NodWZmbGUubGVuZ3RoIC0gMTsgaSsrKSB7DQogICAgICBpZiAoZXF1YWxpdHlUZXN0KHJhbmRvbV9zaHVmZmxlW2ldLCByYW5kb21fc2h1ZmZsZVtpICsgMV0pKSB7DQogICAgICAgIC8vIG5laWdoYm9ycyBhcmUgZXF1YWwsIHBpY2sgYSBuZXcgcmFuZG9tIG5laWdoYm9yIHRvIHN3YXAgKG5vdCB0aGUgZmlyc3Qgb3IgbGFzdCBlbGVtZW50LCB0byBhdm9pZCBlZGdlIGNhc2VzKQ0KICAgICAgICB2YXIgcmFuZG9tX3BpY2sgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAocmFuZG9tX3NodWZmbGUubGVuZ3RoIC0gMikpICsgMTsNCiAgICAgICAgLy8gdGVzdCB0byBtYWtlIHN1cmUgdGhlIG5ldyBuZWlnaGJvciBpc24ndCBlcXVhbCB0byB0aGUgb2xkIG9uZQ0KICAgICAgICB3aGlsZSAoDQogICAgICAgICAgZXF1YWxpdHlUZXN0KHJhbmRvbV9zaHVmZmxlW2kgKyAxXSwgcmFuZG9tX3NodWZmbGVbcmFuZG9tX3BpY2tdKSB8fA0KICAgICAgICAgIChlcXVhbGl0eVRlc3QocmFuZG9tX3NodWZmbGVbaSArIDFdLCByYW5kb21fc2h1ZmZsZVtyYW5kb21fcGljayArIDFdKSB8fCBlcXVhbGl0eVRlc3QocmFuZG9tX3NodWZmbGVbaSArIDFdLCByYW5kb21fc2h1ZmZsZVtyYW5kb21fcGljayAtIDFdKSkNCiAgICAgICAgKSB7DQogICAgICAgICAgcmFuZG9tX3BpY2sgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAocmFuZG9tX3NodWZmbGUubGVuZ3RoIC0gMikpICsgMTsNCiAgICAgICAgfQ0KICAgICAgICB2YXIgbmV3X25laWdoYm9yID0gcmFuZG9tX3NodWZmbGVbcmFuZG9tX3BpY2tdOw0KICAgICAgICByYW5kb21fc2h1ZmZsZVtyYW5kb21fcGlja10gPSByYW5kb21fc2h1ZmZsZVtpICsgMV07DQogICAgICAgIHJhbmRvbV9zaHVmZmxlW2kgKyAxXSA9IG5ld19uZWlnaGJvcjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICByZXR1cm4gcmFuZG9tX3NodWZmbGU7DQogIH0NCg0KICBtb2R1bGUuc2h1ZmZsZUFsdGVybmF0ZUdyb3VwcyA9IGZ1bmN0aW9uKGFycl9ncm91cHMsIHJhbmRvbV9ncm91cF9vcmRlcil7DQogICAgaWYodHlwZW9mIHJhbmRvbV9ncm91cF9vcmRlciA9PSAndW5kZWZpbmVkJyl7DQogICAgICByYW5kb21fZ3JvdXBfb3JkZXIgPSBmYWxzZTsNCiAgICB9DQoNCiAgICB2YXIgbl9ncm91cHMgPSBhcnJfZ3JvdXBzLmxlbmd0aDsNCiAgICBpZihuX2dyb3VwcyA9PSAxKXsNCiAgICAgIGNvbnNvbGUud2FybignanNQc3ljaC5yYW5kb21pemF0aW9uLnNodWZmbGVBbHRlcm5hdGVHcm91cHMgd2FzIGNhbGxlZCB3aXRoIG9ubHkgb25lIGdyb3VwLiBEZWZhdWx0aW5nIHRvIHNpbXBsZSBzaHVmZmxlLicpOw0KICAgICAgcmV0dXJuKG1vZHVsZS5zaHVmZmxlKGFycl9ncm91cHNbMF0pKTsNCiAgICB9DQoNCiAgICB2YXIgZ3JvdXBfb3JkZXIgPSBbXTsNCiAgICBmb3IodmFyIGk9MDsgaTxuX2dyb3VwczsgaSsrKXsNCiAgICAgIGdyb3VwX29yZGVyLnB1c2goaSk7DQogICAgfQ0KICAgIGlmKHJhbmRvbV9ncm91cF9vcmRlcil7DQogICAgICBncm91cF9vcmRlciA9IG1vZHVsZS5zaHVmZmxlKGdyb3VwX29yZGVyKTsNCiAgICB9DQoNCiAgICB2YXIgcmFuZG9taXplZF9ncm91cHMgPSBbXTsNCiAgICB2YXIgbWluX2xlbmd0aCA9IG51bGw7DQogICAgZm9yKHZhciBpPTA7IGk8bl9ncm91cHM7IGkrKyl7DQogICAgICBtaW5fbGVuZ3RoID0gbWluX2xlbmd0aCA9PT0gbnVsbCA/IGFycl9ncm91cHNbaV0ubGVuZ3RoIDogTWF0aC5taW4obWluX2xlbmd0aCwgYXJyX2dyb3Vwc1tpXS5sZW5ndGgpOw0KICAgICAgcmFuZG9taXplZF9ncm91cHMucHVzaChtb2R1bGUuc2h1ZmZsZShhcnJfZ3JvdXBzW2ldKSk7DQogICAgfQ0KDQogICAgdmFyIG91dCA9IFtdOw0KICAgIGZvcih2YXIgaT0wOyBpPG1pbl9sZW5ndGg7IGkrKyl7DQogICAgICBmb3IodmFyIGo9MDsgajxncm91cF9vcmRlci5sZW5ndGg7IGorKyl7DQogICAgICAgIG91dC5wdXNoKHJhbmRvbWl6ZWRfZ3JvdXBzW2dyb3VwX29yZGVyW2pdXVtpXSkNCiAgICAgIH0NCiAgICB9DQoNCiAgICByZXR1cm4gb3V0Ow0KICB9DQoNCiAgbW9kdWxlLnNhbXBsZVdpdGhvdXRSZXBsYWNlbWVudCA9IGZ1bmN0aW9uKGFyciwgc2l6ZSl7DQogICAgaWYoIUFycmF5LmlzQXJyYXkoYXJyKSl7DQogICAgICBjb25zb2xlLmVycm9yKCJGaXJzdCBhcmd1bWVudCB0byBqc1BzeWNoLnJhbmRvbWl6YXRpb24uc2FtcGxlV2l0aG91dFJlcGxhY2VtZW50KCkgbXVzdCBiZSBhbiBhcnJheSIpDQogICAgfQ0KICAgIA0KICAgIGlmIChzaXplID4gYXJyLmxlbmd0aCkgew0KICAgICAgY29uc29sZS5lcnJvcigiQ2Fubm90IHRha2UgYSBzYW1wbGUgIiArDQogICAgICAgICJsYXJnZXIgdGhhbiB0aGUgc2l6ZSBvZiB0aGUgc2V0IG9mIGl0ZW1zIHRvIHNhbXBsZS4iKTsNCiAgICB9DQogICAgcmV0dXJuIGpzUHN5Y2gucmFuZG9taXphdGlvbi5zaHVmZmxlKGFycikuc2xpY2UoMCxzaXplKTsNCiAgfQ0KDQogIG1vZHVsZS5zYW1wbGVXaXRoUmVwbGFjZW1lbnQgPSBmdW5jdGlvbihhcnIsIHNpemUsIHdlaWdodHMpIHsNCiAgICBpZighQXJyYXkuaXNBcnJheShhcnIpKXsNCiAgICAgIGNvbnNvbGUuZXJyb3IoIkZpcnN0IGFyZ3VtZW50IHRvIGpzUHN5Y2gucmFuZG9taXphdGlvbi5zYW1wbGVXaXRoUmVwbGFjZW1lbnQoKSBtdXN0IGJlIGFuIGFycmF5IikNCiAgICB9DQoNCiAgICB2YXIgbm9ybWFsaXplZF93ZWlnaHRzID0gW107DQogICAgaWYodHlwZW9mIHdlaWdodHMgIT09ICd1bmRlZmluZWQnKXsNCiAgICAgIGlmKHdlaWdodHMubGVuZ3RoICE9PSBhcnIubGVuZ3RoKXsNCiAgICAgICAgY29uc29sZS5lcnJvcignVGhlIGxlbmd0aCBvZiB0aGUgd2VpZ2h0cyBhcnJheSBtdXN0IGVxdWFsIHRoZSBsZW5ndGggb2YgdGhlIGFycmF5ICcrDQogICAgICAgICd0byBiZSBzYW1wbGVkIGZyb20uJyk7DQogICAgICB9DQogICAgICB2YXIgd2VpZ2h0X3N1bSA9IDA7DQogICAgICBmb3IodmFyIGk9MDsgaTx3ZWlnaHRzLmxlbmd0aDsgaSsrKXsNCiAgICAgICAgd2VpZ2h0X3N1bSArPSB3ZWlnaHRzW2ldOw0KICAgICAgfQ0KICAgICAgZm9yKHZhciBpPTA7IGk8d2VpZ2h0cy5sZW5ndGg7IGkrKyl7DQogICAgICAgIG5vcm1hbGl6ZWRfd2VpZ2h0cy5wdXNoKCB3ZWlnaHRzW2ldIC8gd2VpZ2h0X3N1bSApOw0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBmb3IodmFyIGk9MDsgaTxhcnIubGVuZ3RoOyBpKyspew0KICAgICAgICBub3JtYWxpemVkX3dlaWdodHMucHVzaCggMSAvIGFyci5sZW5ndGggKTsNCiAgICAgIH0NCiAgICB9DQoNCiAgICB2YXIgY3VtdWxhdGl2ZV93ZWlnaHRzID0gW25vcm1hbGl6ZWRfd2VpZ2h0c1swXV07DQogICAgZm9yKHZhciBpPTE7IGk8bm9ybWFsaXplZF93ZWlnaHRzLmxlbmd0aDsgaSsrKXsNCiAgICAgIGN1bXVsYXRpdmVfd2VpZ2h0cy5wdXNoKG5vcm1hbGl6ZWRfd2VpZ2h0c1tpXSArIGN1bXVsYXRpdmVfd2VpZ2h0c1tpLTFdKTsNCiAgICB9DQoNCiAgICB2YXIgc2FtcCA9IFtdOw0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7DQogICAgICB2YXIgcm5kID0gTWF0aC5yYW5kb20oKTsNCiAgICAgIHZhciBpbmRleCA9IDA7DQogICAgICB3aGlsZShybmQgPiBjdW11bGF0aXZlX3dlaWdodHNbaW5kZXhdKSB7IGluZGV4Kys7IH0NCiAgICAgIHNhbXAucHVzaChhcnJbaW5kZXhdKTsNCiAgICB9DQogICAgcmV0dXJuIHNhbXA7DQogIH0NCg0KICBtb2R1bGUuZmFjdG9yaWFsID0gZnVuY3Rpb24oZmFjdG9ycywgcmVwZXRpdGlvbnMsIHVucGFjaykgew0KDQogICAgdmFyIGZhY3Rvck5hbWVzID0gT2JqZWN0LmtleXMoZmFjdG9ycyk7DQoNCiAgICB2YXIgZmFjdG9yX2NvbWJpbmF0aW9ucyA9IFtdOw0KDQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmYWN0b3JzW2ZhY3Rvck5hbWVzWzBdXS5sZW5ndGg7IGkrKykgew0KICAgICAgZmFjdG9yX2NvbWJpbmF0aW9ucy5wdXNoKHt9KTsNCiAgICAgIGZhY3Rvcl9jb21iaW5hdGlvbnNbaV1bZmFjdG9yTmFtZXNbMF1dID0gZmFjdG9yc1tmYWN0b3JOYW1lc1swXV1baV07DQogICAgfQ0KDQogICAgZm9yICh2YXIgaSA9IDE7IGkgPCBmYWN0b3JOYW1lcy5sZW5ndGg7IGkrKykgew0KICAgICAgdmFyIHRvQWRkID0gZmFjdG9yc1tmYWN0b3JOYW1lc1tpXV07DQogICAgICB2YXIgbiA9IGZhY3Rvcl9jb21iaW5hdGlvbnMubGVuZ3RoOw0KICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBuOyBqKyspIHsNCiAgICAgICAgdmFyIGJhc2UgPSBmYWN0b3JfY29tYmluYXRpb25zW2pdOw0KICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IHRvQWRkLmxlbmd0aDsgaysrKSB7DQogICAgICAgICAgdmFyIG5ld3BpZWNlID0ge307DQogICAgICAgICAgbmV3cGllY2VbZmFjdG9yTmFtZXNbaV1dID0gdG9BZGRba107DQogICAgICAgICAgZmFjdG9yX2NvbWJpbmF0aW9ucy5wdXNoKE9iamVjdC5hc3NpZ24oe30sIGJhc2UsIG5ld3BpZWNlKSk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGZhY3Rvcl9jb21iaW5hdGlvbnMuc3BsaWNlKDAsIG4pOw0KICAgIH0NCg0KICAgIHJlcGV0aXRpb25zID0gKHR5cGVvZiByZXBldGl0aW9ucyA9PT0gJ3VuZGVmaW5lZCcpID8gMSA6IHJlcGV0aXRpb25zOw0KICAgIHZhciB3aXRoX3JlcGV0aXRpb25zID0gbW9kdWxlLnJlcGVhdChmYWN0b3JfY29tYmluYXRpb25zLCByZXBldGl0aW9ucywgdW5wYWNrKTsNCg0KICAgIHJldHVybiB3aXRoX3JlcGV0aXRpb25zOw0KICB9DQoNCiAgbW9kdWxlLnJhbmRvbUlEID0gZnVuY3Rpb24obGVuZ3RoKXsNCiAgICB2YXIgcmVzdWx0ID0gJyc7DQogICAgdmFyIGxlbmd0aCA9ICh0eXBlb2YgbGVuZ3RoID09ICd1bmRlZmluZWQnKSA/IDMyIDogbGVuZ3RoOw0KICAgIHZhciBjaGFycyA9ICcwMTIzNDU2Nzg5YWJjZGVmZ2hqa2xtbm9wcXJzdHV2d3h5eic7DQogICAgZm9yKHZhciBpID0gMDsgaTxsZW5ndGg7IGkrKyl7DQogICAgICByZXN1bHQgKz0gY2hhcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogY2hhcnMubGVuZ3RoKV07DQogICAgfQ0KICAgIHJldHVybiByZXN1bHQ7DQogIH0NCg0KICBmdW5jdGlvbiB1bnBhY2tBcnJheShhcnJheSkgew0KDQogICAgdmFyIG91dCA9IHt9Ow0KDQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgew0KICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhhcnJheVtpXSk7DQogICAgICBmb3IgKHZhciBrID0gMDsgayA8IGtleXMubGVuZ3RoOyBrKyspIHsNCiAgICAgICAgaWYgKHR5cGVvZiBvdXRba2V5c1trXV0gPT09ICd1bmRlZmluZWQnKSB7DQogICAgICAgICAgb3V0W2tleXNba11dID0gW107DQogICAgICAgIH0NCiAgICAgICAgb3V0W2tleXNba11dLnB1c2goYXJyYXlbaV1ba2V5c1trXV0pOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHJldHVybiBvdXQ7DQogIH0NCg0KICBmdW5jdGlvbiBzaHVmZmxlKGFycmF5KSB7DQogICAgdmFyIGNvcHlfYXJyYXkgPSBhcnJheS5zbGljZSgwKTsNCiAgICB2YXIgbSA9IGNvcHlfYXJyYXkubGVuZ3RoLA0KICAgICAgdCwgaTsNCg0KICAgIC8vIFdoaWxlIHRoZXJlIHJlbWFpbiBlbGVtZW50cyB0byBzaHVmZmxl4oCmDQogICAgd2hpbGUgKG0pIHsNCg0KICAgICAgLy8gUGljayBhIHJlbWFpbmluZyBlbGVtZW504oCmDQogICAgICBpID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbS0tKTsNCg0KICAgICAgLy8gQW5kIHN3YXAgaXQgd2l0aCB0aGUgY3VycmVudCBlbGVtZW50Lg0KICAgICAgdCA9IGNvcHlfYXJyYXlbbV07DQogICAgICBjb3B5X2FycmF5W21dID0gY29weV9hcnJheVtpXTsNCiAgICAgIGNvcHlfYXJyYXlbaV0gPSB0Ow0KICAgIH0NCg0KICAgIHJldHVybiBjb3B5X2FycmF5Ow0KICB9DQoNCiAgcmV0dXJuIG1vZHVsZTsNCg0KfSkoKTsNCg0KanNQc3ljaC5wbHVnaW5BUEkgPSAoZnVuY3Rpb24oKSB7DQoNCiAgdmFyIG1vZHVsZSA9IHt9Ow0KDQogIC8vIGtleWJvYXJkIGxpc3RlbmVycyAvLw0KDQogIHZhciBrZXlib2FyZF9saXN0ZW5lcnMgPSBbXTsNCg0KICB2YXIgaGVsZF9rZXlzID0ge307DQoNCiAgdmFyIHJvb3Rfa2V5ZG93bl9saXN0ZW5lciA9IGZ1bmN0aW9uKGUpew0KICAgIGZvcih2YXIgaT0wOyBpPGtleWJvYXJkX2xpc3RlbmVycy5sZW5ndGg7IGkrKyl7DQogICAgICBrZXlib2FyZF9saXN0ZW5lcnNbaV0uZm4oZSk7DQogICAgfQ0KICAgIGhlbGRfa2V5c1tlLmtleUNvZGVdID0gdHJ1ZTsNCiAgfQ0KICB2YXIgcm9vdF9rZXl1cF9saXN0ZW5lciA9IGZ1bmN0aW9uKGUpew0KICAgIGhlbGRfa2V5c1tlLmtleUNvZGVdID0gZmFsc2U7DQogIH0NCg0KICBtb2R1bGUucmVzZXQgPSBmdW5jdGlvbihyb290X2VsZW1lbnQpew0KICAgIGtleWJvYXJkX2xpc3RlbmVycyA9IFtdOw0KICAgIGhlbGRfa2V5cyA9IHt9Ow0KICAgIHJvb3RfZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywgcm9vdF9rZXlkb3duX2xpc3RlbmVyKTsNCiAgICByb290X2VsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5dXAnLCByb290X2tleXVwX2xpc3RlbmVyKTsNCiAgfQ0KDQogIG1vZHVsZS5jcmVhdGVLZXlib2FyZEV2ZW50TGlzdGVuZXJzID0gZnVuY3Rpb24ocm9vdF9lbGVtZW50KXsNCiAgICByb290X2VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHJvb3Rfa2V5ZG93bl9saXN0ZW5lcik7DQogICAgcm9vdF9lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgcm9vdF9rZXl1cF9saXN0ZW5lcik7DQogIH0NCg0KICBtb2R1bGUuZ2V0S2V5Ym9hcmRSZXNwb25zZSA9IGZ1bmN0aW9uKHBhcmFtZXRlcnMpIHsNCiAgICAvL3BhcmFtZXRlcnMgYXJlOiBjYWxsYmFja19mdW5jdGlvbiwgdmFsaWRfcmVzcG9uc2VzLCBydF9tZXRob2QsIHBlcnNpc3QsIGF1ZGlvX2NvbnRleHQsIGF1ZGlvX2NvbnRleHRfc3RhcnRfdGltZSwgYWxsb3dfaGVsZF9rZXk/DQoNCiAgICBwYXJhbWV0ZXJzLnJ0X21ldGhvZCA9ICh0eXBlb2YgcGFyYW1ldGVycy5ydF9tZXRob2QgPT09ICd1bmRlZmluZWQnKSA/ICdwZXJmb3JtYW5jZScgOiBwYXJhbWV0ZXJzLnJ0X21ldGhvZDsNCiAgICBpZiAocGFyYW1ldGVycy5ydF9tZXRob2QgIT0gJ3BlcmZvcm1hbmNlJyAmJiBwYXJhbWV0ZXJzLnJ0X21ldGhvZCAhPSAnYXVkaW8nKSB7DQogICAgICBjb25zb2xlLmxvZygnSW52YWxpZCBSVCBtZXRob2Qgc3BlY2lmaWVkIGluIGdldEtleWJvYXJkUmVzcG9uc2UuIERlZmF1bHRpbmcgdG8gInBlcmZvcm1hbmNlIiBtZXRob2QuJyk7DQogICAgICBwYXJhbWV0ZXJzLnJ0X21ldGhvZCA9ICdwZXJmb3JtYW5jZSc7DQogICAgfQ0KDQogICAgdmFyIHN0YXJ0X3RpbWU7DQogICAgaWYgKHBhcmFtZXRlcnMucnRfbWV0aG9kID09ICdwZXJmb3JtYW5jZScpIHsNCiAgICAgIHN0YXJ0X3RpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTsNCiAgICB9IGVsc2UgaWYgKHBhcmFtZXRlcnMucnRfbWV0aG9kID09ICdhdWRpbycpIHsNCiAgICAgIHN0YXJ0X3RpbWUgPSBwYXJhbWV0ZXJzLmF1ZGlvX2NvbnRleHRfc3RhcnRfdGltZTsNCiAgICB9DQoNCiAgICB2YXIgbGlzdGVuZXJfaWQ7DQoNCiAgICB2YXIgbGlzdGVuZXJfZnVuY3Rpb24gPSBmdW5jdGlvbihlKSB7DQoNCiAgICAgIHZhciBrZXlfdGltZTsNCiAgICAgIGlmIChwYXJhbWV0ZXJzLnJ0X21ldGhvZCA9PSAncGVyZm9ybWFuY2UnKSB7DQogICAgICAgIGtleV90aW1lID0gcGVyZm9ybWFuY2Uubm93KCk7DQogICAgICB9IGVsc2UgaWYgKHBhcmFtZXRlcnMucnRfbWV0aG9kID09ICdhdWRpbycpIHsNCiAgICAgICAga2V5X3RpbWUgPSBwYXJhbWV0ZXJzLmF1ZGlvX2NvbnRleHQuY3VycmVudFRpbWUNCiAgICAgIH0NCg0KICAgICAgdmFyIHZhbGlkX3Jlc3BvbnNlID0gZmFsc2U7DQogICAgICBpZiAodHlwZW9mIHBhcmFtZXRlcnMudmFsaWRfcmVzcG9uc2VzID09PSAndW5kZWZpbmVkJyB8fCBwYXJhbWV0ZXJzLnZhbGlkX3Jlc3BvbnNlcyA9PSBqc1BzeWNoLkFMTF9LRVlTKSB7DQogICAgICAgIHZhbGlkX3Jlc3BvbnNlID0gdHJ1ZTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGlmKHBhcmFtZXRlcnMudmFsaWRfcmVzcG9uc2VzICE9IGpzUHN5Y2guTk9fS0VZUyl7DQogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJhbWV0ZXJzLnZhbGlkX3Jlc3BvbnNlcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbWV0ZXJzLnZhbGlkX3Jlc3BvbnNlc1tpXSA9PSAnc3RyaW5nJykgew0KICAgICAgICAgICAgICB2YXIga2MgPSBqc1BzeWNoLnBsdWdpbkFQSS5jb252ZXJ0S2V5Q2hhcmFjdGVyVG9LZXlDb2RlKHBhcmFtZXRlcnMudmFsaWRfcmVzcG9uc2VzW2ldKTsNCiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBrYyAhPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgICAgICBpZiAoZS5rZXlDb2RlID09IGtjKSB7DQogICAgICAgICAgICAgICAgICB2YWxpZF9yZXNwb25zZSA9IHRydWU7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBrZXkgc3RyaW5nIHNwZWNpZmllZCBmb3IgZ2V0S2V5Ym9hcmRSZXNwb25zZScpOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9IGVsc2UgaWYgKGUua2V5Q29kZSA9PSBwYXJhbWV0ZXJzLnZhbGlkX3Jlc3BvbnNlc1tpXSkgew0KICAgICAgICAgICAgICB2YWxpZF9yZXNwb25zZSA9IHRydWU7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgICAvLyBjaGVjayBpZiBrZXkgd2FzIGFscmVhZHkgaGVsZCBkb3duDQoNCiAgICAgIGlmICgoKHR5cGVvZiBwYXJhbWV0ZXJzLmFsbG93X2hlbGRfa2V5ID09ICd1bmRlZmluZWQnKSB8fCAhcGFyYW1ldGVycy5hbGxvd19oZWxkX2tleSkgJiYgdmFsaWRfcmVzcG9uc2UpIHsNCiAgICAgICAgaWYgKHR5cGVvZiBoZWxkX2tleXNbZS5rZXlDb2RlXSAhPT0gJ3VuZGVmaW5lZCcgJiYgaGVsZF9rZXlzW2Uua2V5Q29kZV0gPT0gdHJ1ZSkgew0KICAgICAgICAgIHZhbGlkX3Jlc3BvbnNlID0gZmFsc2U7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgaWYgKHZhbGlkX3Jlc3BvbnNlKSB7DQogICAgICAgIC8vIGlmIHRoaXMgaXMgYSB2YWxpZCByZXNwb25zZSwgdGhlbiB3ZSBkb24ndCB3YW50IHRoZSBrZXkgZXZlbnQgdG8gdHJpZ2dlciBvdGhlciBhY3Rpb25zDQogICAgICAgIC8vIGxpa2Ugc2Nyb2xsaW5nIHZpYSB0aGUgc3BhY2ViYXIuDQogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsNCg0KICAgICAgICBwYXJhbWV0ZXJzLmNhbGxiYWNrX2Z1bmN0aW9uKHsNCiAgICAgICAgICBrZXk6IGUua2V5Q29kZSwNCiAgICAgICAgICBydDoga2V5X3RpbWUgLSBzdGFydF90aW1lDQogICAgICAgIH0pOw0KDQogICAgICAgIGlmIChrZXlib2FyZF9saXN0ZW5lcnMuaW5jbHVkZXMobGlzdGVuZXJfaWQpKSB7DQoNCiAgICAgICAgICBpZiAoIXBhcmFtZXRlcnMucGVyc2lzdCkgew0KICAgICAgICAgICAgLy8gcmVtb3ZlIGtleWJvYXJkIGxpc3RlbmVyDQogICAgICAgICAgICBtb2R1bGUuY2FuY2VsS2V5Ym9hcmRSZXNwb25zZShsaXN0ZW5lcl9pZCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfTsNCg0KICAgIC8vIGNyZWF0ZSBsaXN0ZW5lciBpZCBvYmplY3QNCiAgICBsaXN0ZW5lcl9pZCA9IHsNCiAgICAgIHR5cGU6ICdrZXlkb3duJywNCiAgICAgIGZuOiBsaXN0ZW5lcl9mdW5jdGlvbg0KICAgIH07DQoNCiAgICAvLyBhZGQgdGhpcyBrZXlib2FyZCBsaXN0ZW5lciB0byB0aGUgbGlzdCBvZiBsaXN0ZW5lcnMNCiAgICBrZXlib2FyZF9saXN0ZW5lcnMucHVzaChsaXN0ZW5lcl9pZCk7DQoNCiAgICByZXR1cm4gbGlzdGVuZXJfaWQ7DQoNCiAgfTsNCg0KICBtb2R1bGUuY2FuY2VsS2V5Ym9hcmRSZXNwb25zZSA9IGZ1bmN0aW9uKGxpc3RlbmVyKSB7DQogICAgLy8gcmVtb3ZlIHRoZSBsaXN0ZW5lciBmcm9tIHRoZSBsaXN0IG9mIGxpc3RlbmVycw0KICAgIGlmIChrZXlib2FyZF9saXN0ZW5lcnMuaW5jbHVkZXMobGlzdGVuZXIpKSB7DQogICAgICBrZXlib2FyZF9saXN0ZW5lcnMuc3BsaWNlKGtleWJvYXJkX2xpc3RlbmVycy5pbmRleE9mKGxpc3RlbmVyKSwgMSk7DQogICAgfQ0KICB9Ow0KDQogIG1vZHVsZS5jYW5jZWxBbGxLZXlib2FyZFJlc3BvbnNlcyA9IGZ1bmN0aW9uKCkgew0KICAgIGtleWJvYXJkX2xpc3RlbmVycyA9IFtdOw0KICB9Ow0KDQogIG1vZHVsZS5jb252ZXJ0S2V5Q2hhcmFjdGVyVG9LZXlDb2RlID0gZnVuY3Rpb24oY2hhcmFjdGVyKSB7DQogICAgdmFyIGNvZGU7DQogICAgY2hhcmFjdGVyID0gY2hhcmFjdGVyLnRvTG93ZXJDYXNlKCk7DQogICAgaWYgKHR5cGVvZiBrZXlsb29rdXBbY2hhcmFjdGVyXSAhPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgIGNvZGUgPSBrZXlsb29rdXBbY2hhcmFjdGVyXTsNCiAgICB9DQogICAgcmV0dXJuIGNvZGU7DQogIH0NCg0KICBtb2R1bGUuY29udmVydEtleUNvZGVUb0tleUNoYXJhY3RlciA9IGZ1bmN0aW9uKGNvZGUpew0KICAgIGZvcih2YXIgaSBpbiBPYmplY3Qua2V5cyhrZXlsb29rdXApKXsNCiAgICAgIGlmKGtleWxvb2t1cFtPYmplY3Qua2V5cyhrZXlsb29rdXApW2ldXSA9PSBjb2RlKXsNCiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGtleWxvb2t1cClbaV07DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiB1bmRlZmluZWQ7DQogIH0NCg0KICBtb2R1bGUuY29tcGFyZUtleXMgPSBmdW5jdGlvbihrZXkxLCBrZXkyKXsNCiAgICAvLyBjb252ZXJ0IHRvIG51bWVyaWMgdmFsdWVzIG5vIG1hdHRlciB3aGF0DQogICAgaWYodHlwZW9mIGtleTEgPT0gJ3N0cmluZycpIHsNCiAgICAgIGtleTEgPSBtb2R1bGUuY29udmVydEtleUNoYXJhY3RlclRvS2V5Q29kZShrZXkxKTsNCiAgICB9DQogICAgaWYodHlwZW9mIGtleTIgPT0gJ3N0cmluZycpIHsNCiAgICAgIGtleTIgPSBtb2R1bGUuY29udmVydEtleUNoYXJhY3RlclRvS2V5Q29kZShrZXkyKTsNCiAgICB9DQogICAgcmV0dXJuIGtleTEgPT0ga2V5MjsNCiAgfQ0KDQogIHZhciBrZXlsb29rdXAgPSB7DQogICAgJ2JhY2tzcGFjZSc6IDgsDQogICAgJ3RhYic6IDksDQogICAgJ2VudGVyJzogMTMsDQogICAgJ3NoaWZ0JzogMTYsDQogICAgJ2N0cmwnOiAxNywNCiAgICAnYWx0JzogMTgsDQogICAgJ3BhdXNlJzogMTksDQogICAgJ2NhcHNsb2NrJzogMjAsDQogICAgJ2VzYyc6IDI3LA0KICAgICdzcGFjZSc6IDMyLA0KICAgICdzcGFjZWJhcic6IDMyLA0KICAgICcgJzogMzIsDQogICAgJ3BhZ2V1cCc6IDMzLA0KICAgICdwYWdlZG93bic6IDM0LA0KICAgICdlbmQnOiAzNSwNCiAgICAnaG9tZSc6IDM2LA0KICAgICdsZWZ0YXJyb3cnOiAzNywNCiAgICAndXBhcnJvdyc6IDM4LA0KICAgICdyaWdodGFycm93JzogMzksDQogICAgJ2Rvd25hcnJvdyc6IDQwLA0KICAgICdpbnNlcnQnOiA0NSwNCiAgICAnZGVsZXRlJzogNDYsDQogICAgJzAnOiA0OCwNCiAgICAnMSc6IDQ5LA0KICAgICcyJzogNTAsDQogICAgJzMnOiA1MSwNCiAgICAnNCc6IDUyLA0KICAgICc1JzogNTMsDQogICAgJzYnOiA1NCwNCiAgICAnNyc6IDU1LA0KICAgICc4JzogNTYsDQogICAgJzknOiA1NywNCiAgICAnYSc6IDY1LA0KICAgICdiJzogNjYsDQogICAgJ2MnOiA2NywNCiAgICAnZCc6IDY4LA0KICAgICdlJzogNjksDQogICAgJ2YnOiA3MCwNCiAgICAnZyc6IDcxLA0KICAgICdoJzogNzIsDQogICAgJ2knOiA3MywNCiAgICAnaic6IDc0LA0KICAgICdrJzogNzUsDQogICAgJ2wnOiA3NiwNCiAgICAnbSc6IDc3LA0KICAgICduJzogNzgsDQogICAgJ28nOiA3OSwNCiAgICAncCc6IDgwLA0KICAgICdxJzogODEsDQogICAgJ3InOiA4MiwNCiAgICAncyc6IDgzLA0KICAgICd0JzogODQsDQogICAgJ3UnOiA4NSwNCiAgICAndic6IDg2LA0KICAgICd3JzogODcsDQogICAgJ3gnOiA4OCwNCiAgICAneSc6IDg5LA0KICAgICd6JzogOTAsDQogICAgJzBudW1wYWQnOiA5NiwNCiAgICAnMW51bXBhZCc6IDk3LA0KICAgICcybnVtcGFkJzogOTgsDQogICAgJzNudW1wYWQnOiA5OSwNCiAgICAnNG51bXBhZCc6IDEwMCwNCiAgICAnNW51bXBhZCc6IDEwMSwNCiAgICAnNm51bXBhZCc6IDEwMiwNCiAgICAnN251bXBhZCc6IDEwMywNCiAgICAnOG51bXBhZCc6IDEwNCwNCiAgICAnOW51bXBhZCc6IDEwNSwNCiAgICAnbXVsdGlwbHknOiAxMDYsDQogICAgJ3BsdXMnOiAxMDcsDQogICAgJ21pbnVzJzogMTA5LA0KICAgICdkZWNpbWFsJzogMTEwLA0KICAgICdkaXZpZGUnOiAxMTEsDQogICAgJ2YxJzogMTEyLA0KICAgICdmMic6IDExMywNCiAgICAnZjMnOiAxMTQsDQogICAgJ2Y0JzogMTE1LA0KICAgICdmNSc6IDExNiwNCiAgICAnZjYnOiAxMTcsDQogICAgJ2Y3JzogMTE4LA0KICAgICdmOCc6IDExOSwNCiAgICAnZjknOiAxMjAsDQogICAgJ2YxMCc6IDEyMSwNCiAgICAnZjExJzogMTIyLA0KICAgICdmMTInOiAxMjMsDQogICAgJz0nOiAxODcsDQogICAgJywnOiAxODgsDQogICAgJy4nOiAxOTAsDQogICAgJy8nOiAxOTEsDQogICAgJ2AnOiAxOTIsDQogICAgJ1snOiAyMTksDQogICAgJ1xcJzogMjIwLA0KICAgICddJzogMjIxDQogIH07DQoNCiAgLy8gdGltZW91dCByZWdpc3RyYXRpb24NCg0KICB2YXIgdGltZW91dF9oYW5kbGVycyA9IFtdOw0KDQogIG1vZHVsZS5zZXRUaW1lb3V0ID0gZnVuY3Rpb24oY2FsbGJhY2ssIGRlbGF5KXsNCiAgICB2YXIgaGFuZGxlID0gc2V0VGltZW91dChjYWxsYmFjaywgZGVsYXkpOw0KICAgIHRpbWVvdXRfaGFuZGxlcnMucHVzaChoYW5kbGUpOw0KICAgIHJldHVybiBoYW5kbGU7DQogIH0NCg0KICBtb2R1bGUuY2xlYXJBbGxUaW1lb3V0cyA9IGZ1bmN0aW9uKCl7DQogICAgZm9yKHZhciBpPTA7aTx0aW1lb3V0X2hhbmRsZXJzLmxlbmd0aDsgaSsrKXsNCiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0X2hhbmRsZXJzW2ldKTsNCiAgICB9DQogICAgdGltZW91dF9oYW5kbGVycyA9IFtdOw0KICB9DQoNCiAgLy8gdmlkZW8gLy8NCiAgICB2YXIgdmlkZW9fYnVmZmVycyA9IHt9DQogICAgbW9kdWxlLmdldFZpZGVvQnVmZmVyID0gZnVuY3Rpb24odmlkZW9JRCkgew0KICAgICAgcmV0dXJuIHZpZGVvX2J1ZmZlcnNbdmlkZW9JRF0NCiAgICB9DQoNCiAgLy8gYXVkaW8gLy8NCiAgdmFyIGNvbnRleHQgPSBudWxsOw0KICB2YXIgYXVkaW9fYnVmZmVycyA9IFtdOw0KDQogIG1vZHVsZS5pbml0QXVkaW8gPSBmdW5jdGlvbigpew0KICAgIGNvbnRleHQgPSAoanNQc3ljaC5pbml0U2V0dGluZ3MoKS51c2Vfd2ViYXVkaW8gPT09IHRydWUpID8ganNQc3ljaC53ZWJhdWRpb19jb250ZXh0IDogbnVsbDsNCiAgfQ0KDQogIG1vZHVsZS5hdWRpb0NvbnRleHQgPSBmdW5jdGlvbigpew0KICAgIGlmKGNvbnRleHQgIT09IG51bGwpew0KICAgICAgaWYoY29udGV4dC5zdGF0ZSAhPT0gJ3J1bm5pbmcnKXsNCiAgICAgICAgY29udGV4dC5yZXN1bWUoKTsNCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIGNvbnRleHQ7DQogIH0NCg0KICBtb2R1bGUuZ2V0QXVkaW9CdWZmZXIgPSBmdW5jdGlvbihhdWRpb0lEKSB7DQoNCiAgICBpZiAoYXVkaW9fYnVmZmVyc1thdWRpb0lEXSA9PT0gJ3RtcCcpIHsNCiAgICAgIGNvbnNvbGUuZXJyb3IoJ0F1ZGlvIGZpbGUgZmFpbGVkIHRvIGxvYWQgaW4gdGhlIHRpbWUgYWxsb3R0ZWQuJykNCiAgICAgIHJldHVybjsNCiAgICB9DQoNCiAgICByZXR1cm4gYXVkaW9fYnVmZmVyc1thdWRpb0lEXTsNCg0KICB9DQoNCiAgLy8gcHJlbG9hZGluZyBzdGltdWxpIC8vDQoNCiAgdmFyIHByZWxvYWRzID0gW107DQoNCiAgdmFyIGltZ19jYWNoZSA9IHt9Ow0KDQogIG1vZHVsZS5wcmVsb2FkQXVkaW9GaWxlcyA9IGZ1bmN0aW9uKGZpbGVzLCBjYWxsYmFja19jb21wbGV0ZSwgY2FsbGJhY2tfbG9hZCkgew0KDQogICAgZmlsZXMgPSBqc1BzeWNoLnV0aWxzLmZsYXR0ZW4oZmlsZXMpOw0KICAgIGZpbGVzID0ganNQc3ljaC51dGlscy51bmlxdWUoZmlsZXMpOw0KDQogICAgdmFyIG5fbG9hZGVkID0gMDsNCiAgICB2YXIgbG9hZGZuID0gKHR5cGVvZiBjYWxsYmFja19sb2FkID09PSAndW5kZWZpbmVkJykgPyBmdW5jdGlvbigpIHt9IDogY2FsbGJhY2tfbG9hZDsNCiAgICB2YXIgZmluaXNoZm4gPSAodHlwZW9mIGNhbGxiYWNrX2NvbXBsZXRlID09PSAndW5kZWZpbmVkJykgPyBmdW5jdGlvbigpIHt9IDogY2FsbGJhY2tfY29tcGxldGU7DQoNCiAgICBpZihmaWxlcy5sZW5ndGg9PTApew0KICAgICAgZmluaXNoZm4oKTsNCiAgICAgIHJldHVybjsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBsb2FkX2F1ZGlvX2ZpbGVfd2ViYXVkaW8oc291cmNlLCBjb3VudCl7DQogICAgICBjb3VudCA9IGNvdW50IHx8IDE7DQogICAgICB2YXIgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOw0KICAgICAgcmVxdWVzdC5vcGVuKCdHRVQnLCBzb3VyY2UsIHRydWUpOw0KICAgICAgcmVxdWVzdC5yZXNwb25zZVR5cGUgPSAnYXJyYXlidWZmZXInOw0KICAgICAgcmVxdWVzdC5vbmxvYWQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgY29udGV4dC5kZWNvZGVBdWRpb0RhdGEocmVxdWVzdC5yZXNwb25zZSwgZnVuY3Rpb24oYnVmZmVyKSB7DQogICAgICAgICAgYXVkaW9fYnVmZmVyc1tzb3VyY2VdID0gYnVmZmVyOw0KICAgICAgICAgIG5fbG9hZGVkKys7DQogICAgICAgICAgbG9hZGZuKG5fbG9hZGVkKTsNCiAgICAgICAgICBpZihuX2xvYWRlZCA9PSBmaWxlcy5sZW5ndGgpIHsNCiAgICAgICAgICAgIGZpbmlzaGZuKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9LCBmdW5jdGlvbigpIHsNCiAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBsb2FkaW5nIGF1ZGlvIGZpbGU6ICcgKyBidWZmZXJJRCk7DQogICAgICAgIH0pOw0KICAgICAgfQ0KICAgICAgcmVxdWVzdC5vbmVycm9yID0gZnVuY3Rpb24oKXsNCiAgICAgICAgaWYoY291bnQgPCBqc1BzeWNoLmluaXRTZXR0aW5ncygpLm1heF9wcmVsb2FkX2F0dGVtcHRzKXsNCiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7DQogICAgICAgICAgICBsb2FkX2F1ZGlvX2ZpbGVfd2ViYXVkaW8oc291cmNlLCBjb3VudCsxKQ0KICAgICAgICAgIH0sIDIwMCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAganNQc3ljaC5sb2FkRmFpbCgpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICByZXF1ZXN0LnNlbmQoKTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBsb2FkX2F1ZGlvX2ZpbGVfaHRtbDVhdWRpbyhzb3VyY2UsIGNvdW50KXsNCiAgICAgIGNvdW50ID0gY291bnQgfHwgMTsNCiAgICAgIHZhciBhdWRpbyA9IG5ldyBBdWRpbygpOw0KICAgICAgYXVkaW8uYWRkRXZlbnRMaXN0ZW5lcignY2FucGxheXRocm91Z2gnLCBmdW5jdGlvbigpew0KICAgICAgICBhdWRpb19idWZmZXJzW3NvdXJjZV0gPSBhdWRpbzsNCiAgICAgICAgbl9sb2FkZWQrKzsNCiAgICAgICAgbG9hZGZuKG5fbG9hZGVkKTsNCiAgICAgICAgaWYobl9sb2FkZWQgPT0gZmlsZXMubGVuZ3RoKXsNCiAgICAgICAgICBmaW5pc2hmbigpOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICAgIGF1ZGlvLmFkZEV2ZW50TGlzdGVuZXIoJ29uZXJyb3InLCBmdW5jdGlvbigpew0KICAgICAgICBpZihjb3VudCA8IGpzUHN5Y2guaW5pdFNldHRpbmdzKCkubWF4X3ByZWxvYWRfYXR0ZW1wdHMpew0KICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsNCiAgICAgICAgICAgIGxvYWRfYXVkaW9fZmlsZV9odG1sNWF1ZGlvKHNvdXJjZSwgY291bnQrMSkNCiAgICAgICAgICB9LCAyMDApOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGpzUHN5Y2gubG9hZEZhaWwoKTsNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgICBhdWRpby5hZGRFdmVudExpc3RlbmVyKCdvbnN0YWxsZWQnLCBmdW5jdGlvbigpew0KICAgICAgICBpZihjb3VudCA8IGpzUHN5Y2guaW5pdFNldHRpbmdzKCkubWF4X3ByZWxvYWRfYXR0ZW1wdHMpew0KICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsNCiAgICAgICAgICAgIGxvYWRfYXVkaW9fZmlsZV9odG1sNWF1ZGlvKHNvdXJjZSwgY291bnQrMSkNCiAgICAgICAgICB9LCAyMDApOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGpzUHN5Y2gubG9hZEZhaWwoKTsNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgICBhdWRpby5hZGRFdmVudExpc3RlbmVyKCdvbmFib3J0JywgZnVuY3Rpb24oKXsNCiAgICAgICAgaWYoY291bnQgPCBqc1BzeWNoLmluaXRTZXR0aW5ncygpLm1heF9wcmVsb2FkX2F0dGVtcHRzKXsNCiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7DQogICAgICAgICAgICBsb2FkX2F1ZGlvX2ZpbGVfaHRtbDVhdWRpbyhzb3VyY2UsIGNvdW50KzEpDQogICAgICAgICAgfSwgMjAwKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBqc1BzeWNoLmxvYWRGYWlsKCk7DQogICAgICAgIH0NCiAgICAgIH0pOw0KICAgICAgYXVkaW8uc3JjID0gc291cmNlOw0KICAgIH0NCg0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmlsZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgIHZhciBidWZmZXJJRCA9IGZpbGVzW2ldOw0KICAgICAgaWYgKHR5cGVvZiBhdWRpb19idWZmZXJzW2J1ZmZlcklEXSAhPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgbl9sb2FkZWQrKzsNCiAgICAgICAgbG9hZGZuKG5fbG9hZGVkKTsNCiAgICAgICAgaWYobl9sb2FkZWQgPT0gZmlsZXMubGVuZ3RoKSB7DQogICAgICAgICAgZmluaXNoZm4oKTsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgYXVkaW9fYnVmZmVyc1tidWZmZXJJRF0gPSAndG1wJzsNCiAgICAgICAgaWYobW9kdWxlLmF1ZGlvQ29udGV4dCgpICE9PSBudWxsKXsNCiAgICAgICAgICBsb2FkX2F1ZGlvX2ZpbGVfd2ViYXVkaW8oYnVmZmVySUQpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGxvYWRfYXVkaW9fZmlsZV9odG1sNWF1ZGlvKGJ1ZmZlcklEKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCg0KICB9DQoNCiAgbW9kdWxlLnByZWxvYWRJbWFnZXMgPSBmdW5jdGlvbihpbWFnZXMsIGNhbGxiYWNrX2NvbXBsZXRlLCBjYWxsYmFja19sb2FkKSB7DQoNCiAgICAvLyBmbGF0dGVuIHRoZSBpbWFnZXMgYXJyYXkNCiAgICBpbWFnZXMgPSBqc1BzeWNoLnV0aWxzLmZsYXR0ZW4oaW1hZ2VzKTsNCiAgICBpbWFnZXMgPSBqc1BzeWNoLnV0aWxzLnVuaXF1ZShpbWFnZXMpOw0KDQogICAgdmFyIG5fbG9hZGVkID0gMDsNCiAgICB2YXIgbG9hZGZuID0gKHR5cGVvZiBjYWxsYmFja19sb2FkID09PSAndW5kZWZpbmVkJykgPyBmdW5jdGlvbigpIHt9IDogY2FsbGJhY2tfbG9hZDsNCiAgICB2YXIgZmluaXNoZm4gPSAodHlwZW9mIGNhbGxiYWNrX2NvbXBsZXRlID09PSAndW5kZWZpbmVkJykgPyBmdW5jdGlvbigpIHt9IDogY2FsbGJhY2tfY29tcGxldGU7DQoNCiAgICBpZihpbWFnZXMubGVuZ3RoID09PSAwKXsNCiAgICAgIGZpbmlzaGZuKCk7DQogICAgICByZXR1cm47DQogICAgfQ0KDQogICAgZnVuY3Rpb24gcHJlbG9hZF9pbWFnZShzb3VyY2UsIGNvdW50KXsNCiAgICAgIGNvdW50ID0gY291bnQgfHwgMTsNCg0KICAgICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpOw0KDQogICAgICBpbWcub25sb2FkID0gZnVuY3Rpb24oKSB7DQogICAgICAgIG5fbG9hZGVkKys7DQogICAgICAgIGxvYWRmbihuX2xvYWRlZCk7DQogICAgICAgIGlmIChuX2xvYWRlZCA9PT0gaW1hZ2VzLmxlbmd0aCkgew0KICAgICAgICAgIGZpbmlzaGZuKCk7DQogICAgICAgIH0NCiAgICAgIH07DQoNCiAgICAgIGltZy5vbmVycm9yID0gZnVuY3Rpb24oKSB7DQogICAgICAgIGlmKGNvdW50IDwganNQc3ljaC5pbml0U2V0dGluZ3MoKS5tYXhfcHJlbG9hZF9hdHRlbXB0cyl7DQogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpew0KICAgICAgICAgICAgcHJlbG9hZF9pbWFnZShzb3VyY2UsIGNvdW50KzEpOw0KICAgICAgICAgIH0sIDIwMCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAganNQc3ljaC5sb2FkRmFpbCgpOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIGltZy5zcmMgPSBzb3VyY2U7DQoNCiAgICAgIGltZ19jYWNoZVtzb3VyY2VdID0gaW1nOw0KICAgIH0NCg0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW1hZ2VzLmxlbmd0aDsgaSsrKSB7DQogICAgICBwcmVsb2FkX2ltYWdlKGltYWdlc1tpXSk7DQogICAgfQ0KDQogIH07DQoNCiAgICBtb2R1bGUucHJlbG9hZFZpZGVvID0gZnVuY3Rpb24odmlkZW8sIGNhbGxiYWNrX2NvbXBsZXRlLCBjYWxsYmFja19sb2FkKSB7DQoNCiAgICAgICAgLy8gZmxhdHRlbiB0aGUgaW1hZ2VzIGFycmF5DQogICAgICAgIHZpZGVvID0ganNQc3ljaC51dGlscy5mbGF0dGVuKHZpZGVvKTsNCiAgICAgICAgdmlkZW8gPSBqc1BzeWNoLnV0aWxzLnVuaXF1ZSh2aWRlbyk7DQoNCiAgICAgICAgdmFyIG5fbG9hZGVkID0gMDsNCiAgICAgICAgdmFyIGxvYWRmbiA9ICFjYWxsYmFja19sb2FkID8gZnVuY3Rpb24oKSB7fSA6IGNhbGxiYWNrX2xvYWQ7DQogICAgICAgIHZhciBmaW5pc2hmbiA9ICFjYWxsYmFja19jb21wbGV0ZSA/IGZ1bmN0aW9uKCkge30gOiBjYWxsYmFja19jb21wbGV0ZTsNCg0KICAgICAgICBpZih2aWRlby5sZW5ndGg9PT0wKXsNCiAgICAgICAgICAgIGZpbmlzaGZuKCk7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBwcmVsb2FkX3ZpZGVvKHNvdXJjZSwgY291bnQpew0KICAgICAgICAgICAgY291bnQgPSBjb3VudCB8fCAxOw0KICAgICAgICAgICAgLy9iYXNlZCBvbiBvcHRpb24gNCBoZXJlOiBodHRwOi8vZGluYnJvci5kay9ibG9nL2hvdy10by1wcmVsb2FkLWVudGlyZS1odG1sNS12aWRlby1iZWZvcmUtcGxheS1zb2x2ZWQvDQogICAgICAgICAgICB2YXIgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOw0KICAgICAgICAgICAgcmVxdWVzdC5vcGVuKCdHRVQnLCBzb3VyY2UsIHRydWUpOw0KICAgICAgICAgICAgcmVxdWVzdC5yZXNwb25zZVR5cGUgPSAnYmxvYic7DQogICAgICAgICAgICByZXF1ZXN0Lm9ubG9hZCA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cyA9PT0gMjAwIHx8IHRoaXMuc3RhdHVzID09PSAwKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciB2aWRlb0Jsb2IgPSB0aGlzLnJlc3BvbnNlOw0KICAgICAgICAgICAgICAgICAgICB2aWRlb19idWZmZXJzW3NvdXJjZV0gPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHZpZGVvQmxvYik7IC8vIElFMTArDQogICAgICAgICAgICAgICAgICAgIG5fbG9hZGVkKys7DQogICAgICAgICAgICAgICAgICAgIGxvYWRmbihuX2xvYWRlZCk7DQogICAgICAgICAgICAgICAgICAgIGlmIChuX2xvYWRlZCA9PT0gdmlkZW8ubGVuZ3RoKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBmaW5pc2hmbigpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgcmVxdWVzdC5vbmVycm9yID0gZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICBpZihjb3VudCA8IGpzUHN5Y2guaW5pdFNldHRpbmdzKCkubWF4X3ByZWxvYWRfYXR0ZW1wdHMpew0KICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgICAgICAgICBwcmVsb2FkX3ZpZGVvKHNvdXJjZSwgY291bnQrMSkNCiAgICAgICAgICAgICAgICAgICAgfSwgMjAwKTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBqc1BzeWNoLmxvYWRGYWlsKCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmVxdWVzdC5zZW5kKCk7DQogICAgICAgIH0NCg0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZpZGVvLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBwcmVsb2FkX3ZpZGVvKHZpZGVvW2ldKTsNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICBtb2R1bGUucmVnaXN0ZXJQcmVsb2FkID0gZnVuY3Rpb24ocGx1Z2luX25hbWUsIHBhcmFtZXRlciwgbWVkaWFfdHlwZSwgY29uZGl0aW9uYWxfZnVuY3Rpb24pIHsNCiAgICBpZiAoWydhdWRpbycsICdpbWFnZScsICd2aWRlbyddLmluZGV4T2YobWVkaWFfdHlwZSk9PT0tMSkgew0KICAgICAgY29uc29sZS5lcnJvcignSW52YWxpZCBtZWRpYV90eXBlIHBhcmFtZXRlciBmb3IganNQc3ljaC5wbHVnaW5BUEkucmVnaXN0ZXJQcmVsb2FkLiBQbGVhc2UgY2hlY2sgdGhlIHBsdWdpbiBmaWxlLicpOw0KICAgIH0NCg0KICAgIHZhciBwcmVsb2FkID0gew0KICAgICAgcGx1Z2luOiBwbHVnaW5fbmFtZSwNCiAgICAgIHBhcmFtZXRlcjogcGFyYW1ldGVyLA0KICAgICAgbWVkaWFfdHlwZTogbWVkaWFfdHlwZSwNCiAgICAgIGNvbmRpdGlvbmFsX2Z1bmN0aW9uOiBjb25kaXRpb25hbF9mdW5jdGlvbg0KICAgIH0NCg0KICAgIHByZWxvYWRzLnB1c2gocHJlbG9hZCk7DQogIH0NCg0KICBtb2R1bGUuYXV0b1ByZWxvYWQgPSBmdW5jdGlvbih0aW1lbGluZSwgY2FsbGJhY2ssIGltYWdlcywgYXVkaW8sIHZpZGVvLCBwcm9ncmVzc19iYXIpIHsNCiAgICAvLyBsaXN0IG9mIGl0ZW1zIHRvIHByZWxvYWQNCiAgICBpbWFnZXMgPSBpbWFnZXMgfHwgW107DQogICAgYXVkaW8gPSBhdWRpbyB8fCBbXTsNCiAgICB2aWRlbyA9IHZpZGVvIHx8IFtdOw0KDQogICAgLy8gY29uc3RydWN0IGxpc3QNCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByZWxvYWRzLmxlbmd0aDsgaSsrKSB7DQogICAgICB2YXIgdHlwZSA9IHByZWxvYWRzW2ldLnBsdWdpbjsNCiAgICAgIHZhciBwYXJhbSA9IHByZWxvYWRzW2ldLnBhcmFtZXRlcjsNCiAgICAgIHZhciBtZWRpYSA9IHByZWxvYWRzW2ldLm1lZGlhX3R5cGU7DQogICAgICB2YXIgZnVuYyA9IHByZWxvYWRzW2ldLmNvbmRpdGlvbmFsX2Z1bmN0aW9uOw0KICAgICAgdmFyIHRyaWFscyA9IHRpbWVsaW5lLnRyaWFsc09mVHlwZSh0eXBlKTsNCiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdHJpYWxzLmxlbmd0aDsgaisrKSB7DQoNCiAgICAgICAgaWYgKHRyaWFsc1tqXVtwYXJhbV0gJiYgdHlwZW9mIHRyaWFsc1tqXVtwYXJhbV0gIT09ICdmdW5jdGlvbicpIHsNCg0KICAgICAgICAgIGlmICggIWZ1bmMgIHx8IGZ1bmModHJpYWxzW2pdKSApew0KICAgICAgICAgICAgaWYgKG1lZGlhID09PSAnaW1hZ2UnKSB7DQogICAgICAgICAgICAgIGltYWdlcyA9IGltYWdlcy5jb25jYXQoanNQc3ljaC51dGlscy5mbGF0dGVuKFt0cmlhbHNbal1bcGFyYW1dXSkpOw0KICAgICAgICAgICAgfSBlbHNlIGlmIChtZWRpYSA9PT0gJ2F1ZGlvJykgew0KICAgICAgICAgICAgICBhdWRpbyA9IGF1ZGlvLmNvbmNhdChqc1BzeWNoLnV0aWxzLmZsYXR0ZW4oW3RyaWFsc1tqXVtwYXJhbV1dKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIGlmIChtZWRpYSA9PT0gJ3ZpZGVvJykgew0KICAgICAgICAgICAgICB2aWRlbyA9IHZpZGVvLmNvbmNhdChqc1BzeWNoLnV0aWxzLmZsYXR0ZW4oW3RyaWFsc1tqXVtwYXJhbV1dKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KDQogICAgaW1hZ2VzID0ganNQc3ljaC51dGlscy51bmlxdWUoanNQc3ljaC51dGlscy5mbGF0dGVuKGltYWdlcykpOw0KICAgIGF1ZGlvICA9IGpzUHN5Y2gudXRpbHMudW5pcXVlKGpzUHN5Y2gudXRpbHMuZmxhdHRlbihhdWRpbykpOw0KICAgIHZpZGVvICA9IGpzUHN5Y2gudXRpbHMudW5pcXVlKGpzUHN5Y2gudXRpbHMuZmxhdHRlbih2aWRlbykpOw0KDQogICAgLy8gcmVtb3ZlIGFueSBudWxscyBmYWxzZSB2YWx1ZXMNCiAgICBpbWFnZXMgPSBpbWFnZXMuZmlsdGVyKGZ1bmN0aW9uKHgpIHsgcmV0dXJuIHggIT0gZmFsc2UgJiYgeCAhPSBudWxsfSkNCiAgICBhdWRpbyA9IGF1ZGlvLmZpbHRlcihmdW5jdGlvbih4KSB7IHJldHVybiB4ICE9IGZhbHNlICYmIHggIT0gbnVsbH0pDQogICAgdmlkZW8gPSB2aWRlby5maWx0ZXIoZnVuY3Rpb24oeCkgeyByZXR1cm4geCAhPSBmYWxzZSAmJiB4ICE9IG51bGx9KQ0KICAgIA0KICAgIHZhciB0b3RhbF9uID0gaW1hZ2VzLmxlbmd0aCArIGF1ZGlvLmxlbmd0aCArIHZpZGVvLmxlbmd0aDsNCg0KICAgIHZhciBsb2FkZWQgPSAwOw0KDQogICAgaWYocHJvZ3Jlc3NfYmFyKXsNCiAgICAgIHZhciBwYl9odG1sID0gIjxkaXYgaWQ9J2pzcHN5Y2gtbG9hZGluZy1wcm9ncmVzcy1iYXItY29udGFpbmVyJyBzdHlsZT0naGVpZ2h0OiAxMHB4OyB3aWR0aDogMzAwcHg7IGJhY2tncm91bmQtY29sb3I6ICNkZGQ7Jz4iOw0KICAgICAgcGJfaHRtbCArPSAiPGRpdiBpZD0nanNwc3ljaC1sb2FkaW5nLXByb2dyZXNzLWJhcicgc3R5bGU9J2hlaWdodDogMTBweDsgd2lkdGg6IDAlOyBiYWNrZ3JvdW5kLWNvbG9yOiAjNzc3Oyc+PC9kaXY+IjsNCiAgICAgIHBiX2h0bWwgKz0gIjwvZGl2PiI7DQogICAgICBqc1BzeWNoLmdldERpc3BsYXlFbGVtZW50KCkuaW5uZXJIVE1MID0gcGJfaHRtbDsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiB1cGRhdGVfbG9hZGluZ19wcm9ncmVzc19iYXIoKXsNCiAgICAgIGxvYWRlZCsrOw0KICAgICAgaWYocHJvZ3Jlc3NfYmFyKXsNCiAgICAgICAgdmFyIHBlcmNlbnRfbG9hZGVkID0gKGxvYWRlZC90b3RhbF9uKSoxMDA7DQogICAgICAgIGpzUHN5Y2guZ2V0RGlzcGxheUVsZW1lbnQoKS5xdWVyeVNlbGVjdG9yKCcjanNwc3ljaC1sb2FkaW5nLXByb2dyZXNzLWJhcicpLnN0eWxlLndpZHRoID0gcGVyY2VudF9sb2FkZWQrIiUiOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIC8vIGRvIHRoZSBwcmVsb2FkaW5nDQogICAgLy8gZmlyc3QgdGhlIGltYWdlcywgdGhlbiB3aGVuIHRoZSBpbWFnZXMgYXJlIGNvbXBsZXRlDQogICAgLy8gd2FpdCBmb3IgdGhlIGF1ZGlvIGZpbGVzIHRvIGZpbmlzaA0KICAgIG1vZHVsZS5wcmVsb2FkSW1hZ2VzKGltYWdlcywgZnVuY3Rpb24oKSB7DQogICAgICBtb2R1bGUucHJlbG9hZEF1ZGlvRmlsZXMoYXVkaW8sIGZ1bmN0aW9uKCkgew0KICAgICAgICAgIG1vZHVsZS5wcmVsb2FkVmlkZW8odmlkZW8sIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICBjYWxsYmFjaygpOw0KICAgICAgICAgIH0sIHVwZGF0ZV9sb2FkaW5nX3Byb2dyZXNzX2Jhcik7DQogICAgICB9LCB1cGRhdGVfbG9hZGluZ19wcm9ncmVzc19iYXIpOw0KICAgIH0sIHVwZGF0ZV9sb2FkaW5nX3Byb2dyZXNzX2Jhcik7DQogIH0NCg0KICAvKioNCiAgICogQWxsb3dzIGNvbW11bmljYXRpb24gd2l0aCB1c2VyIGhhcmR3YXJlIHRocm91Z2ggb3VyIGN1c3RvbSBHb29nbGUgQ2hyb21lIGV4dGVuc2lvbiArIG5hdGl2ZSBDKysgcHJvZ3JhbQ0KICAgKiBAcGFyYW0JCXtvYmplY3R9CW1lc3MJVGhlIG1lc3NhZ2UgdG8gYmUgcGFzc2VkIHRvIG91ciBleHRlbnNpb24sIHNlZSBpdHMgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGV4cGVjdGVkIG1lbWJlcnMgb2YgdGhpcyBvYmplY3QuDQogICAqIEBhdXRob3IJRGFuaWVsIFJpdmFzDQogICAqDQogICAqLw0KICBtb2R1bGUuaGFyZHdhcmUgPSBmdW5jdGlvbiBoYXJkd2FyZShtZXNzKXsNCgkgIC8vc2luY2UgQ2hyb21lIGV4dGVuc2lvbiBjb250ZW50LXNjcmlwdHMgZG8gbm90IHNoYXJlIHRoZSBqYXZhc2NyaXB0IGVudmlyb25tZW50IHdpdGggdGhlIHBhZ2Ugc2NyaXB0IHRoYXQgbG9hZGVkIGpzcHN5Y2gsDQoJICAvL3dlIHdpbGwgbmVlZCB0byB1c2UgaGFja3kgbWV0aG9kcyBsaWtlIGNvbW11bmljYXRpbmcgdGhyb3VnaCBET00gZXZlbnRzLg0KCSAgdmFyIGpzcHN5Y2hFdnQgPSBuZXcgQ3VzdG9tRXZlbnQoJ2pzcHN5Y2gnLCB7ZGV0YWlsOiBtZXNzfSk7DQoJICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KGpzcHN5Y2hFdnQpOw0KCSAgLy9BbmQgdm9pbGEhIGl0IHdpbGwgYmUgdGhlIGpvYiBvZiB0aGUgY29udGVudCBzY3JpcHQgaW5qZWN0ZWQgYnkgdGhlIGV4dGVuc2lvbiB0byBsaXN0ZW4gZm9yIHRoZSBldmVudCBhbmQgZG8gdGhlIGFwcHJvcHJpYXRlIGFjdGlvbnMuDQogIH07DQoNCiAgLyoqIHtib29sZWFufSBJbmRpY2F0ZXMgd2hldGhlciB0aGlzIGluc3RhbmNlIG9mIGpzcHN5Y2ggaGFzIG9wZW5lZCBhIGhhcmR3YXJlIGNvbm5lY3Rpb24gdGhyb3VnaCBvdXIgYnJvd3NlciBleHRlbnNpb24gKi8NCiAgbW9kdWxlLmhhcmR3YXJlQ29ubmVjdGVkID0gZmFsc2U7DQoNCg0KICAvL2l0IG1pZ2h0IGJlIHVzZWZ1bCB0byBvcGVuIHVwIGEgbGluZSBvZiBjb21tdW5pY2F0aW9uIGZyb20gdGhlIGV4dGVuc2lvbiBiYWNrIHRvIHRoaXMgcGFnZSBzY3JpcHQsDQogIC8vYWdhaW4sIHRoaXMgd2lsbCBoYXZlIHRvIHBhc3MgdGhyb3VnaCBET00gZXZlbnRzLiBGb3Igbm93IHNwZWVkIGlzIG9mIG5vIGNvbmNlcm4gc28gSSB3aWxsIHVzZSBqUXVlcnkNCiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigianNwc3ljaC1hY3RpdmF0ZSIsIGZ1bmN0aW9uKGV2dCl7DQoJICBtb2R1bGUuaGFyZHdhcmVDb25uZWN0ZWQgPSB0cnVlOw0KICB9KQ0KDQoNCg0KICByZXR1cm4gbW9kdWxlOw0KfSkoKTsNCg0KLy8gbWV0aG9kcyB1c2VkIGluIG11bHRpcGxlIG1vZHVsZXMgLy8NCmpzUHN5Y2gudXRpbHMgPSAoZnVuY3Rpb24oKSB7DQoNCgl2YXIgbW9kdWxlID0ge307DQoNCgltb2R1bGUuZmxhdHRlbiA9IGZ1bmN0aW9uKGFyciwgb3V0KSB7DQoJCW91dCA9ICh0eXBlb2Ygb3V0ID09PSAndW5kZWZpbmVkJykgPyBbXSA6IG91dDsNCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsNCgkJCWlmIChBcnJheS5pc0FycmF5KGFycltpXSkpIHsNCgkJCQltb2R1bGUuZmxhdHRlbihhcnJbaV0sIG91dCk7DQoJCQl9IGVsc2Ugew0KCQkJCW91dC5wdXNoKGFycltpXSk7DQoJCQl9DQoJCX0NCgkJcmV0dXJuIG91dDsNCgl9DQoNCgltb2R1bGUudW5pcXVlID0gZnVuY3Rpb24oYXJyKSB7DQoJCXZhciBvdXQgPSBbXTsNCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsNCgkJCWlmIChhcnIuaW5kZXhPZihhcnJbaV0pID09IGkpIHsNCgkJCQlvdXQucHVzaChhcnJbaV0pOw0KCQkJfQ0KCQl9DQoJCXJldHVybiBvdXQ7DQoJfQ0KDQoJbW9kdWxlLmRlZXBDb3B5ID0gZnVuY3Rpb24ob2JqKSB7DQogICAgaWYoIW9iaikgcmV0dXJuIG9iajsNCiAgICB2YXIgb3V0Ow0KICAgIGlmKEFycmF5LmlzQXJyYXkob2JqKSl7DQogICAgICBvdXQgPSBbXTsNCiAgICAgIGZvcih2YXIgaSA9IDA7IGk8b2JqLmxlbmd0aDsgaSsrKXsNCiAgICAgICAgb3V0LnB1c2gobW9kdWxlLmRlZXBDb3B5KG9ialtpXSkpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIG91dDsNCiAgICB9IGVsc2UgaWYodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcpew0KICAgICAgb3V0ID0ge307DQogICAgICBmb3IodmFyIGtleSBpbiBvYmopew0KICAgICAgICBpZihvYmouaGFzT3duUHJvcGVydHkoa2V5KSl7DQogICAgICAgICAgb3V0W2tleV0gPSBtb2R1bGUuZGVlcENvcHkob2JqW2tleV0pOw0KICAgICAgICB9DQogICAgICB9DQogICAgICByZXR1cm4gb3V0Ow0KICAgIH0gZWxzZSB7DQogICAgICByZXR1cm4gb2JqOw0KICAgIH0NCiAgfQ0KDQoJcmV0dXJuIG1vZHVsZTsNCn0pKCk7DQoNCi8vIHBvbHlmaWxsIGZvciBPYmplY3QuYXNzaWduIHRvIHN1cHBvcnQgSUUNCmlmICh0eXBlb2YgT2JqZWN0LmFzc2lnbiAhPSAnZnVuY3Rpb24nKSB7DQogIE9iamVjdC5hc3NpZ24gPSBmdW5jdGlvbiAodGFyZ2V0LCB2YXJBcmdzKSB7IC8vIC5sZW5ndGggb2YgZnVuY3Rpb24gaXMgMg0KICAgICd1c2Ugc3RyaWN0JzsNCiAgICBpZiAodGFyZ2V0ID09IG51bGwpIHsgLy8gVHlwZUVycm9yIGlmIHVuZGVmaW5lZCBvciBudWxsDQogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY29udmVydCB1bmRlZmluZWQgb3IgbnVsbCB0byBvYmplY3QnKTsNCiAgICB9DQoNCiAgICB2YXIgdG8gPSBPYmplY3QodGFyZ2V0KTsNCg0KICAgIGZvciAodmFyIGluZGV4ID0gMTsgaW5kZXggPCBhcmd1bWVudHMubGVuZ3RoOyBpbmRleCsrKSB7DQogICAgICB2YXIgbmV4dFNvdXJjZSA9IGFyZ3VtZW50c1tpbmRleF07DQoNCiAgICAgIGlmIChuZXh0U291cmNlICE9IG51bGwpIHsgLy8gU2tpcCBvdmVyIGlmIHVuZGVmaW5lZCBvciBudWxsDQogICAgICAgIGZvciAodmFyIG5leHRLZXkgaW4gbmV4dFNvdXJjZSkgew0KICAgICAgICAgIC8vIEF2b2lkIGJ1Z3Mgd2hlbiBoYXNPd25Qcm9wZXJ0eSBpcyBzaGFkb3dlZA0KICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobmV4dFNvdXJjZSwgbmV4dEtleSkpIHsNCiAgICAgICAgICAgIHRvW25leHRLZXldID0gbmV4dFNvdXJjZVtuZXh0S2V5XTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHRvOw0KICB9Ow0KfQ0KDQovLyBwb2x5ZmlsbCBmb3IgQXJyYXkuaW5jbHVkZXMgdG8gc3VwcG9ydCBJRQ0KaWYgKCFBcnJheS5wcm90b3R5cGUuaW5jbHVkZXMpIHsNCiAgQXJyYXkucHJvdG90eXBlLmluY2x1ZGVzID0gZnVuY3Rpb24oc2VhcmNoRWxlbWVudCAvKiwgZnJvbUluZGV4Ki8pIHsNCiAgICAndXNlIHN0cmljdCc7DQogICAgaWYgKHRoaXMgPT0gbnVsbCkgew0KICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJyYXkucHJvdG90eXBlLmluY2x1ZGVzIGNhbGxlZCBvbiBudWxsIG9yIHVuZGVmaW5lZCcpOw0KICAgIH0NCg0KICAgIHZhciBPID0gT2JqZWN0KHRoaXMpOw0KICAgIHZhciBsZW4gPSBwYXJzZUludChPLmxlbmd0aCwgMTApIHx8IDA7DQogICAgaWYgKGxlbiA9PT0gMCkgew0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0NCiAgICB2YXIgbiA9IHBhcnNlSW50KGFyZ3VtZW50c1sxXSwgMTApIHx8IDA7DQogICAgdmFyIGs7DQogICAgaWYgKG4gPj0gMCkgew0KICAgICAgayA9IG47DQogICAgfSBlbHNlIHsNCiAgICAgIGsgPSBsZW4gKyBuOw0KICAgICAgaWYgKGsgPCAwKSB7ayA9IDA7fQ0KICAgIH0NCiAgICB2YXIgY3VycmVudEVsZW1lbnQ7DQogICAgd2hpbGUgKGsgPCBsZW4pIHsNCiAgICAgIGN1cnJlbnRFbGVtZW50ID0gT1trXTsNCiAgICAgIGlmIChzZWFyY2hFbGVtZW50ID09PSBjdXJyZW50RWxlbWVudCB8fA0KICAgICAgICAgKHNlYXJjaEVsZW1lbnQgIT09IHNlYXJjaEVsZW1lbnQgJiYgY3VycmVudEVsZW1lbnQgIT09IGN1cnJlbnRFbGVtZW50KSkgeyAvLyBOYU4gIT09IE5hTg0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGsrKzsNCiAgICB9DQogICAgcmV0dXJuIGZhbHNlOw0KICB9Ow0KfQ0KDQovLyBwb2x5ZmlsbCBmb3IgQXJyYXkuaXNBcnJheQ0KaWYgKCFBcnJheS5pc0FycmF5KSB7DQogIEFycmF5LmlzQXJyYXkgPSBmdW5jdGlvbihhcmcpIHsNCiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGFyZykgPT09ICdbb2JqZWN0IEFycmF5XSc7DQogIH07DQp9DQo="></script>
<script src="data:application/javascript;base64,LyoqDQogKiBqc3BzeWNoLXN1cnZleS1saWtlcnQNCiAqIGEganNwc3ljaCBwbHVnaW4gZm9yIG1lYXN1cmluZyBpdGVtcyBvbiBhIGxpa2VydCBzY2FsZQ0KICoNCiAqIEpvc2ggZGUgTGVldXcNCiAqDQogKiBkb2N1bWVudGF0aW9uOiBkb2NzLmpzcHN5Y2gub3JnDQogKg0KICovDQoNCmpzUHN5Y2gucGx1Z2luc1snc3VydmV5LWxpa2VydCddID0gKGZ1bmN0aW9uKCkgew0KDQogIHZhciBwbHVnaW4gPSB7fTsNCg0KICBwbHVnaW4uaW5mbyA9IHsNCiAgICBuYW1lOiAnc3VydmV5LWxpa2VydCcsDQogICAgZGVzY3JpcHRpb246ICcnLA0KICAgIHBhcmFtZXRlcnM6IHsNCiAgICAgIHF1ZXN0aW9uczogew0KICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5DT01QTEVYLA0KICAgICAgICBhcnJheTogdHJ1ZSwNCiAgICAgICAgcHJldHR5X25hbWU6ICdRdWVzdGlvbnMnLA0KICAgICAgICBuZXN0ZWQ6IHsNCiAgICAgICAgICBwcm9tcHQ6IHsNCiAgICAgICAgICAgIHR5cGU6IGpzUHN5Y2gucGx1Z2lucy5wYXJhbWV0ZXJUeXBlLlNUUklORywNCiAgICAgICAgICAgIHByZXR0eV9uYW1lOiAnUHJvbXB0JywNCiAgICAgICAgICAgIGRlZmF1bHQ6IHVuZGVmaW5lZCwNCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnUXVlc3Rpb25zIHRoYXQgYXJlIGFzc29jaWF0ZWQgd2l0aCB0aGUgc2xpZGVyLicNCiAgICAgICAgICB9LA0KICAgICAgICAgIGxhYmVsczogew0KICAgICAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuU1RSSU5HLA0KICAgICAgICAgICAgYXJyYXk6IHRydWUsDQogICAgICAgICAgICBwcmV0dHlfbmFtZTogJ0xhYmVscycsDQogICAgICAgICAgICBkZWZhdWx0OiB1bmRlZmluZWQsDQogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0xhYmVscyB0byBkaXNwbGF5IGZvciBpbmRpdmlkdWFsIHF1ZXN0aW9uLicNCiAgICAgICAgICB9LA0KICAgICAgICAgIHJlcXVpcmVkOiB7DQogICAgICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5CT09MLA0KICAgICAgICAgICAgcHJldHR5X25hbWU6ICdSZXF1aXJlZCcsDQogICAgICAgICAgICBkZWZhdWx0OiBmYWxzZSwNCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnTWFrZXMgYW5zd2VyaW5nIHRoZSBxdWVzdGlvbiByZXF1aXJlZC4nDQogICAgICAgICAgfSwNCiAgICAgICAgICBuYW1lOiB7DQogICAgICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5TVFJJTkcsDQogICAgICAgICAgICBwcmV0dHlfbmFtZTogJ1F1ZXN0aW9uIE5hbWUnLA0KICAgICAgICAgICAgZGVmYXVsdDogJycsDQogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0NvbnRyb2xzIHRoZSBuYW1lIG9mIGRhdGEgdmFsdWVzIGFzc29jaWF0ZWQgd2l0aCB0aGlzIHF1ZXN0aW9uJw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgIHJhbmRvbWl6ZV9xdWVzdGlvbl9vcmRlcjogew0KICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5CT09MLA0KICAgICAgICBwcmV0dHlfbmFtZTogJ1JhbmRvbWl6ZSBRdWVzdGlvbiBPcmRlcicsDQogICAgICAgIGRlZmF1bHQ6IGZhbHNlLA0KICAgICAgICBkZXNjcmlwdGlvbjogJ0lmIHRydWUsIHRoZSBvcmRlciBvZiB0aGUgcXVlc3Rpb25zIHdpbGwgYmUgcmFuZG9taXplZCcNCiAgICAgIH0sDQogICAgICBwcmVhbWJsZTogew0KICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5TVFJJTkcsDQogICAgICAgIHByZXR0eV9uYW1lOiAnUHJlYW1ibGUnLA0KICAgICAgICBkZWZhdWx0OiBudWxsLA0KICAgICAgICBkZXNjcmlwdGlvbjogJ1N0cmluZyB0byBkaXNwbGF5IGF0IHRvcCBvZiB0aGUgcGFnZS4nDQogICAgICB9LA0KICAgICAgc2NhbGVfd2lkdGg6IHsNCiAgICAgICAgdHlwZToganNQc3ljaC5wbHVnaW5zLnBhcmFtZXRlclR5cGUuSU5ULA0KICAgICAgICBwcmV0dHlfbmFtZTogJ1NjYWxlIHdpZHRoJywNCiAgICAgICAgZGVmYXVsdDogbnVsbCwNCiAgICAgICAgZGVzY3JpcHRpb246ICdXaWR0aCBvZiB0aGUgbGlrZXJ0IHNjYWxlcyBpbiBwaXhlbHMuJw0KICAgICAgfSwNCiAgICAgIGJ1dHRvbl9sYWJlbDogew0KICAgICAgICB0eXBlOiBqc1BzeWNoLnBsdWdpbnMucGFyYW1ldGVyVHlwZS5TVFJJTkcsDQogICAgICAgIHByZXR0eV9uYW1lOiAnQnV0dG9uIGxhYmVsJywNCiAgICAgICAgZGVmYXVsdDogICdDb250aW51ZScsDQogICAgICAgIGRlc2NyaXB0aW9uOiAnTGFiZWwgb2YgdGhlIGJ1dHRvbi4nDQogICAgICB9DQogICAgfQ0KICB9DQoNCiAgcGx1Z2luLnRyaWFsID0gZnVuY3Rpb24oZGlzcGxheV9lbGVtZW50LCB0cmlhbCkgew0KDQogICAgaWYodHJpYWwuc2NhbGVfd2lkdGggIT09IG51bGwpew0KICAgICAgdmFyIHcgPSB0cmlhbC5zY2FsZV93aWR0aCArICdweCc7DQogICAgfSBlbHNlIHsNCiAgICAgIHZhciB3ID0gJzEwMCUnOw0KICAgIH0NCg0KICAgIHZhciBodG1sID0gIiI7DQogICAgLy8gaW5qZWN0IENTUyBmb3IgdHJpYWwNCiAgICBodG1sICs9ICc8c3R5bGUgaWQ9ImpzcHN5Y2gtc3VydmV5LWxpa2VydC1jc3MiPic7DQogICAgaHRtbCArPSAiLmpzcHN5Y2gtc3VydmV5LWxpa2VydC1zdGF0ZW1lbnQgeyBkaXNwbGF5OmJsb2NrOyBmb250LXNpemU6IDE2cHg7IHBhZGRpbmctdG9wOiA0MHB4OyBtYXJnaW4tYm90dG9tOjEwcHg7IH0iKw0KICAgICAgIi5qc3BzeWNoLXN1cnZleS1saWtlcnQtb3B0cyB7IGxpc3Qtc3R5bGU6bm9uZTsgd2lkdGg6Iit3KyI7IG1hcmdpbjphdXRvOyBwYWRkaW5nOjAgMCAzNXB4OyBkaXNwbGF5OmJsb2NrOyBmb250LXNpemU6IDE0cHg7IGxpbmUtaGVpZ2h0OjEuMWVtOyB9IisNCiAgICAgICIuanNwc3ljaC1zdXJ2ZXktbGlrZXJ0LW9wdC1sYWJlbCB7IGxpbmUtaGVpZ2h0OiAxLjFlbTsgY29sb3I6ICM0NDQ7IH0iKw0KICAgICAgIi5qc3BzeWNoLXN1cnZleS1saWtlcnQtb3B0czpiZWZvcmUgeyBjb250ZW50OiAnJzsgcG9zaXRpb246cmVsYXRpdmU7IHRvcDoxMXB4OyAvKmxlZnQ6OS41JTsqLyBkaXNwbGF5OmJsb2NrOyBiYWNrZ3JvdW5kLWNvbG9yOiNlZmVmZWY7IGhlaWdodDo0cHg7IHdpZHRoOjEwMCU7IH0iKw0KICAgICAgIi5qc3BzeWNoLXN1cnZleS1saWtlcnQtb3B0czpsYXN0LW9mLXR5cGUgeyBib3JkZXItYm90dG9tOiAwOyB9IisNCiAgICAgICIuanNwc3ljaC1zdXJ2ZXktbGlrZXJ0LW9wdHMgbGkgeyBkaXNwbGF5OmlubGluZS1ibG9jazsgLyp3aWR0aDoxOSU7Ki8gdGV4dC1hbGlnbjpjZW50ZXI7IHZlcnRpY2FsLWFsaWduOiB0b3A7IH0iKw0KICAgICAgIi5qc3BzeWNoLXN1cnZleS1saWtlcnQtb3B0cyBsaSBpbnB1dFt0eXBlPXJhZGlvXSB7IGRpc3BsYXk6YmxvY2s7IHBvc2l0aW9uOnJlbGF0aXZlOyB0b3A6MDsgbGVmdDo1MCU7IG1hcmdpbi1sZWZ0Oi02cHg7IH0iDQogICAgaHRtbCArPSAnPC9zdHlsZT4nOw0KDQogICAgLy8gc2hvdyBwcmVhbWJsZSB0ZXh0DQogICAgaWYodHJpYWwucHJlYW1ibGUgIT09IG51bGwpew0KICAgICAgaHRtbCArPSAnPGRpdiBpZD0ianNwc3ljaC1zdXJ2ZXktbGlrZXJ0LXByZWFtYmxlIiBjbGFzcz0ianNwc3ljaC1zdXJ2ZXktbGlrZXJ0LXByZWFtYmxlIj4nK3RyaWFsLnByZWFtYmxlKyc8L2Rpdj4nOw0KICAgIH0NCiAgICBodG1sICs9ICc8Zm9ybSBpZD0ianNwc3ljaC1zdXJ2ZXktbGlrZXJ0LWZvcm0iPic7DQoNCiAgICAvLyBhZGQgbGlrZXJ0IHNjYWxlIHF1ZXN0aW9ucyAvLy8NCiAgICAvLyBnZW5lcmF0ZSBxdWVzdGlvbiBvcmRlci4gdGhpcyBpcyByYW5kb21pemVkIGhlcmUgYXMgb3Bwb3NlZCB0byByYW5kb21pemluZyB0aGUgb3JkZXIgb2YgdHJpYWwucXVlc3Rpb25zDQogICAgLy8gc28gdGhhdCB0aGUgZGF0YSBhcmUgYWx3YXlzIGFzc29jaWF0ZWQgd2l0aCB0aGUgc2FtZSBxdWVzdGlvbiByZWdhcmRsZXNzIG9mIG9yZGVyDQogICAgdmFyIHF1ZXN0aW9uX29yZGVyID0gW107DQogICAgZm9yKHZhciBpPTA7IGk8dHJpYWwucXVlc3Rpb25zLmxlbmd0aDsgaSsrKXsNCiAgICAgIHF1ZXN0aW9uX29yZGVyLnB1c2goaSk7DQogICAgfQ0KICAgIGlmKHRyaWFsLnJhbmRvbWl6ZV9xdWVzdGlvbl9vcmRlcil7DQogICAgICBxdWVzdGlvbl9vcmRlciA9IGpzUHN5Y2gucmFuZG9taXphdGlvbi5zaHVmZmxlKHF1ZXN0aW9uX29yZGVyKTsNCiAgICB9DQogICAgDQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0cmlhbC5xdWVzdGlvbnMubGVuZ3RoOyBpKyspIHsNCiAgICAgIHZhciBxdWVzdGlvbiA9IHRyaWFsLnF1ZXN0aW9uc1txdWVzdGlvbl9vcmRlcltpXV07DQogICAgICAvLyBhZGQgcXVlc3Rpb24NCiAgICAgIGh0bWwgKz0gJzxsYWJlbCBjbGFzcz0ianNwc3ljaC1zdXJ2ZXktbGlrZXJ0LXN0YXRlbWVudCI+JyArIHF1ZXN0aW9uLnByb21wdCArICc8L2xhYmVsPic7DQogICAgICAvLyBhZGQgb3B0aW9ucw0KICAgICAgdmFyIHdpZHRoID0gMTAwIC8gcXVlc3Rpb24ubGFiZWxzLmxlbmd0aDsNCiAgICAgIHZhciBvcHRpb25zX3N0cmluZyA9ICc8dWwgY2xhc3M9ImpzcHN5Y2gtc3VydmV5LWxpa2VydC1vcHRzIiBkYXRhLW5hbWU9IicrcXVlc3Rpb24ubmFtZSsnIiBkYXRhLXJhZGlvLWdyb3VwPSJRJyArIHF1ZXN0aW9uX29yZGVyW2ldICsgJyI+JzsNCiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcXVlc3Rpb24ubGFiZWxzLmxlbmd0aDsgaisrKSB7DQogICAgICAgIG9wdGlvbnNfc3RyaW5nICs9ICc8bGkgc3R5bGU9IndpZHRoOicgKyB3aWR0aCArICclIj48aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9IlEnICsgcXVlc3Rpb25fb3JkZXJbaV0gKyAnIiB2YWx1ZT0iJyArIGogKyAnIic7DQogICAgICAgIGlmKHF1ZXN0aW9uLnJlcXVpcmVkKXsNCiAgICAgICAgICBvcHRpb25zX3N0cmluZyArPSAnIHJlcXVpcmVkJzsNCiAgICAgICAgfQ0KICAgICAgICBvcHRpb25zX3N0cmluZyArPSAnPjxsYWJlbCBjbGFzcz0ianNwc3ljaC1zdXJ2ZXktbGlrZXJ0LW9wdC1sYWJlbCI+JyArIHF1ZXN0aW9uLmxhYmVsc1tqXSArICc8L2xhYmVsPjwvbGk+JzsNCiAgICAgIH0NCiAgICAgIG9wdGlvbnNfc3RyaW5nICs9ICc8L3VsPic7DQogICAgICBodG1sICs9IG9wdGlvbnNfc3RyaW5nOw0KICAgIH0NCg0KICAgIC8vIGFkZCBzdWJtaXQgYnV0dG9uDQogICAgaHRtbCArPSAnPGlucHV0IHR5cGU9InN1Ym1pdCIgaWQ9ImpzcHN5Y2gtc3VydmV5LWxpa2VydC1uZXh0IiBjbGFzcz0ianNwc3ljaC1zdXJ2ZXktbGlrZXJ0IGpzcHN5Y2gtYnRuIiB2YWx1ZT0iJyt0cmlhbC5idXR0b25fbGFiZWwrJyI+PC9pbnB1dD4nOw0KDQogICAgaHRtbCArPSAnPC9mb3JtPicNCg0KICAgIGRpc3BsYXlfZWxlbWVudC5pbm5lckhUTUwgPSBodG1sOw0KDQogICAgZGlzcGxheV9lbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJyNqc3BzeWNoLXN1cnZleS1saWtlcnQtZm9ybScpLmFkZEV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIGZ1bmN0aW9uKGUpew0KICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgLy8gbWVhc3VyZSByZXNwb25zZSB0aW1lDQogICAgICB2YXIgZW5kVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpOw0KICAgICAgdmFyIHJlc3BvbnNlX3RpbWUgPSBlbmRUaW1lIC0gc3RhcnRUaW1lOw0KDQogICAgICAvLyBjcmVhdGUgb2JqZWN0IHRvIGhvbGQgcmVzcG9uc2VzDQogICAgICB2YXIgcXVlc3Rpb25fZGF0YSA9IHt9Ow0KICAgICAgdmFyIG1hdGNoZXMgPSBkaXNwbGF5X2VsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnI2pzcHN5Y2gtc3VydmV5LWxpa2VydC1mb3JtIC5qc3BzeWNoLXN1cnZleS1saWtlcnQtb3B0cycpOw0KICAgICAgZm9yKHZhciBpbmRleCA9IDA7IGluZGV4IDwgbWF0Y2hlcy5sZW5ndGg7IGluZGV4Kyspew0KICAgICAgICB2YXIgaWQgPSBtYXRjaGVzW2luZGV4XS5kYXRhc2V0WydyYWRpb0dyb3VwJ107DQogICAgICAgIHZhciBlbCA9IGRpc3BsYXlfZWxlbWVudC5xdWVyeVNlbGVjdG9yKCdpbnB1dFtuYW1lPSInICsgaWQgKyAnIl06Y2hlY2tlZCcpOw0KICAgICAgICBpZiAoZWwgPT09IG51bGwpIHsNCiAgICAgICAgICB2YXIgcmVzcG9uc2UgPSAiIjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICB2YXIgcmVzcG9uc2UgPSBwYXJzZUludChlbC52YWx1ZSk7DQogICAgICAgIH0NCiAgICAgICAgdmFyIG9iamUgPSB7fTsNCiAgICAgICAgaWYobWF0Y2hlc1tpbmRleF0uYXR0cmlidXRlc1snZGF0YS1uYW1lJ10udmFsdWUgIT09ICcnKXsNCiAgICAgICAgICB2YXIgbmFtZSA9IG1hdGNoZXNbaW5kZXhdLmF0dHJpYnV0ZXNbJ2RhdGEtbmFtZSddLnZhbHVlOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHZhciBuYW1lID0gaWQ7DQogICAgICAgIH0NCiAgICAgICAgb2JqZVtuYW1lXSA9IHJlc3BvbnNlOw0KICAgICAgICBPYmplY3QuYXNzaWduKHF1ZXN0aW9uX2RhdGEsIG9iamUpOw0KICAgICAgfQ0KDQogICAgICAvLyBzYXZlIGRhdGENCiAgICAgIHZhciB0cmlhbF9kYXRhID0gew0KICAgICAgICAicnQiOiByZXNwb25zZV90aW1lLA0KICAgICAgICAicmVzcG9uc2VzIjogSlNPTi5zdHJpbmdpZnkocXVlc3Rpb25fZGF0YSksDQogICAgICAgICJxdWVzdGlvbl9vcmRlciI6IEpTT04uc3RyaW5naWZ5KHF1ZXN0aW9uX29yZGVyKQ0KICAgICAgfTsNCg0KICAgICAgZGlzcGxheV9lbGVtZW50LmlubmVySFRNTCA9ICcnOw0KDQogICAgICAvLyBuZXh0IHRyaWFsDQogICAgICBqc1BzeWNoLmZpbmlzaFRyaWFsKHRyaWFsX2RhdGEpOw0KICAgIH0pOw0KDQogICAgdmFyIHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpOw0KICB9Ow0KDQogIHJldHVybiBwbHVnaW47DQp9KSgpOw0K"></script>
<script type="text/javascript">
var scale = [
　"全くあてはまらない",
  "ほとんどあてはまらない",
  "あまりあてはまらない",
  "どちらともいえない",
  "ややあてはまる",
  "かなりあてはまる", 
  "非常にあてはまる",
];

var likert = {
timeline:[
{
  type: 'survey-likert',
  questions: [
    {prompt: "ゲームをしたい", name: 'game', labels: scale},
    {prompt: "ラーメン食べたい", name: 'ramen', labels: scale},
    {prompt: "よく腹を壊す", name: 'stomach', labels: scale},
    {prompt: "柔術したい", name: 'JiuJitsu', labels: scale}
  ],
  button_label: '次へ',
},{
  type: 'survey-likert',
  questions: [
    {prompt: "論文読みたい", name: 'ReadPaper', labels: scale},
    {prompt: "お祈りはもう要らない", name: 'pray', labels: scale},
    {prompt: "MMAジム行きたい", name: 'MMA', labels: scale},
    {prompt: "論文書けると思う", name: 'WritePaper', labels: scale}
  ],
  button_label: '次へ',
},{
  type: 'survey-likert',
  questions: [
    {prompt: "ウイイレW杯日本代表で優勝したい", name: 'Wining11', labels: scale},
    {prompt: "痔が再発してつらい", name: 'zi', labels: scale}
  ],
  button_label: '次へ',
  }]
};


var timeline = []; 
timeline.push(likert);

/*実行*/
jsPsych.init({
   timeline: timeline,
   on_finish: function() {
       jsPsych.data.displayData();
   }
});

   

</script>



<!-- code folding -->



</body>
</html>
