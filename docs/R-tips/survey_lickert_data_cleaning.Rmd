---
title: "jsPsychのsurvey-likertのデータをRのデータフレームにする方法で四苦八苦したので備忘録"
author: "Takuto Yoshida"
date: "5/13/2021"
output: html_document
---

## jsPsychで研究中

現在僕は、jsPsychとfirebaseでオンライン実験とオンライン調査をしています。
jsPsychは非常にわかりやすくて、実験作るのに役立つのですが、吐き出すデータがちょっと癖あります。今回の記事の内容は、実験の作り方とは離れるので、jsPsychでの実験の作り方が気になる方は、[Kunisato先生のブログ](https://kunisatolab.github.io)を参照してください。

話を戻して、jsPsychでは、Jsonという形式で結果がアウトプットされます。他の吐き出し方もあるかもしれませんが、僕はJson以外の吐き出し方知りません。
基本的には、JsonはRへのデータ読み込みしやすい形式なんですが、一部問題があります。
jsPsych内の、survey-likertで、リッカートでの質問紙のデータの形式が大変でつまづきました。

## 恐怖のマトリョーシカで＝た


[簡単な質問紙](jsPsych_Experiment/jsPsych_Likert.html)で公開している質問紙に回答すると、以下のようなjsonデータが画面上に出力されます。ちなみに僕は満点です。イボではなくキレです。

```{json}
	{
		"rt": 5769.974999999249,
		"responses": "{\"game\":6,\"ramen\":6,\"stomach\":6,\"JiuJitsu\":6}",
		"question_order": "[0,1,2,3]",
		"trial_type": "survey-likert",
		"trial_index": 0,
		"time_elapsed": 5772,
		"internal_node_id": "0.0-0.0-0.0"
	},
	{
		"rt": 7308.964999998352,
		"responses": "{\"ReadPaper\":6,\"pray\":6,\"MMA\":6,\"WritePaper\":6}",
		"question_order": "[0,1,2,3]",
		"trial_type": "survey-likert",
		"trial_index": 1,
		"time_elapsed": 13084,
		"internal_node_id": "0.0-0.0-1.0"
	},
	{
		"rt": 4439.2100000004575,
		"responses": "{\"Wining11\":6,\"zi\":6}",
		"question_order": "[0,1]",
		"trial_type": "survey-likert",
		"trial_index": 2,
		"time_elapsed": 17525,
		"internal_node_id": "0.0-0.0-2.0"
	}

```


firebaseで公開して研究参加者さんに答えてもらうと、上記のjsonファイルが、idごとに連なっていきます。気になる人は[サンプルjsonファイル](jsPsych_Experiment/survey_likert_rawdata.json)で確認してください。





まずは、上記のでjsonデータをRで分析しやすい形式に読み込みます。




```{r message=FALSE, highlight=TRUE, results='hide', error=FALSE, warning=FALSE}

library(tidyverse)
library(jsonlite)
library(dplyr)

List <- jsonlite::fromJSON("jsPsych_Experiment/survey_likert_rawdata.json",)

RawDF <- tidyr::as_tibble(List, validate = F) %>% gather(., id) %>% unnest(.)

```


```{r}
htmlTable::htmlTable(RawDF)
```


エクセル形式になった！やったね！と思いきや、


```{r}
RawDF$responses
```

よく見ると、DFのデータフレーム内のresponse変数に、jsonっぽい何かが入っちゃうんですよね。
しかも、1人の参加者ごとに行でまとまってないし、質問紙調査に合うデータフレームになってない。


というわけで形を整えたかったんですが、「jspsych survey likert R dataframe」とかで調べても解決策が出てこなかったんすよね。

なので、なんとか解決できいたので皆さんに解決策を共有します。



## 解決策



### 無理矢理文字を消して、配列にして処置。

responseの中の、「\{」 や「\}」という記号をまず消してあげます。


```{r message=FALSE, highlight=TRUE, results='hide', error=FALSE, warning=FALSE}
item_maziri_responses <- RawDF$responses %>%  noquote(.) %>% gsub("{", "", ., fixed = T) %>% gsub("}", "", .) %>%
  gsub(":", "", .) 
```

```{r}
item_maziri_responses
```


そんで、その配列の中の、\"項目名\"の部分を全部消してあげましょう。
質問項目の名前はそれぞれなので、[正規表現](http://www.okadajp.org/RWiki/?R+%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE)を使用してあげて、\"\"で囲ってる範囲を抹殺してあげましょう。そのためには、 **[\\"'].\*?['\\"]** という風に指定して文字検索したら質問項目の名前は問わず、要らん文字列が抹殺されます。ここでつまずいて僕は5日くらい溶けました。




```{r message=FALSE, highlight=TRUE, results='hide', error=FALSE, warning=FALSE}
item_no_maziri_responses<- item_maziri_responses %>% gsub("[\"'].*?['\"]", "", .) 
```

```{r}
item_no_maziri_responses

```

はい、これで、RawDF$responseから、質問項目の名前の情報が消えました。やったね。
ついでに、データフレームにしてあげましょう。

```{r message=FALSE, highlight=TRUE, results='hide', error=FALSE, warning=FALSE}
DF <- item_no_maziri_responses %>% paste(., sep = "", collapse = ",") %>%  read.csv(text =., header = F) %>% as.numeric(.) %>% array(., dim = c(14, 2)) %>% t(.) %>% data.frame(.)
```


質問項目とid情報も名前も入れときましょう。

```{r message=FALSE, highlight=TRUE, results='hide', error=FALSE, warning=FALSE}
names(DF) <- paste("Q", c(1:14), sep = "")
DF$id <- names(List)
```



jsPsychでのオンライン実験の作り方の記事ばかりで、データの処理の困っている人の役に立てば幸いです。
ラーメン食ってラボから帰ります。

